#!/bin/bash
set -e

echo "üêß Installing fileShare.app..."

# Check Python and tkinter
python3 -c "import tkinter" 2>/dev/null || {
    echo "‚ùå Install tkinter first:"
    echo "  Ubuntu: sudo apt install python3-tk"
    exit 1
}

# Install location
DIR="$HOME/.local/share/fileShare"
BIN="$HOME/.local/bin"
DESKTOP="$HOME/.local/share/applications"

mkdir -p "$DIR" "$BIN" "$DESKTOP" "$DIR/templates"

echo "üì¶ Installing files..."

# Extract files (source code protected)
echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQgc29ja2V0CmltcG9ydCBzZWNyZXRzCmltcG9ydCBoYXNobGliCmltcG9ydCB0aW1lCmltcG9ydCBzcWxpdGUzCmZyb20gaHR0cC5zZXJ2ZXIgaW1wb3J0IEhUVFBTZXJ2ZXIsIFNpbXBsZUhUVFBSZXF1ZXN0SGFuZGxlcgpmcm9tIHNvY2tldHNlcnZlciBpbXBvcnQgVGhyZWFkaW5nTWl4SW4KaW1wb3J0IHVybGxpYi5wYXJzZQpmcm9tIHJlbW90ZV9jb250cm9sIGltcG9ydCBSZW1vdGVDb250cm9sCgpjbGFzcyBBdXRoRmlsZUhhbmRsZXIoU2ltcGxlSFRUUFJlcXVlc3RIYW5kbGVyKToKICAgIFZBTElEX1RPS0VOUyA9IHt9ICAjIHRva2VuIC0+IHt1c2VyLCBleHBpcmVzfQogICAgRkFJTEVEX0FUVEVNUFRTID0ge30KICAgIERCX0ZJTEUgPSBvcy5lbnZpcm9uLmdldCgnRklMRVNIQVJFX0RCX1BBVEgnLCAndXNlcnMuZGInKQogICAgQURNSU5fUEFTU1dPUkQgPSBOb25lICAjIFN0b3JlIGFkbWluIHBhc3N3b3JkIGluIG1lbW9yeQogICAgQURNSU5fTk9USUZJQ0FUSU9OUyA9IFtdICAjIFN0b3JlIGFkbWluIG5vdGlmaWNhdGlvbnMKICAgIEFDVElWRV9VU0VSUyA9IHt9ICAjIHRva2VuIC0+IHt1c2VyLCBsYXN0X2FjdGl2aXR5LCBpcCwgdXNlcl9hZ2VudH0KICAgIFNIQVJFRF9QQVRIU19DQUNIRSA9IE5vbmUgICMgQ2FjaGUgc2hhcmVkIHBhdGhzIHRvIGF2b2lkIHJlcGVhdGVkIERCIHF1ZXJpZXMKICAgIENBQ0hFX1RJTUVTVEFNUCA9IDAgICMgVHJhY2sgd2hlbiBjYWNoZSB3YXMgbGFzdCB1cGRhdGVkCiAgICAKICAgIGRlZiBnZXRfdGVtcGxhdGVfcGF0aChzZWxmLCB0ZW1wbGF0ZV9uYW1lKToKICAgICAgICAiIiJHZXQgdGVtcGxhdGUgcGF0aCBmb3IgYm90aCBkZXZlbG9wbWVudCBhbmQgcGFja2FnZWQgYXBwIiIiCiAgICAgICAgaWYgaGFzYXR0cihzeXMsICdfTUVJUEFTUycpOgogICAgICAgICAgICAjIFJ1bm5pbmcgYXMgcGFja2FnZWQgYXBwCiAgICAgICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4oc3lzLl9NRUlQQVNTLCAndGVtcGxhdGVzJywgdGVtcGxhdGVfbmFtZSkgICMgdHlwZTogaWdub3JlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBSdW5uaW5nIGFzIHNjcmlwdAogICAgICAgICAgICByZXR1cm4gb3MucGF0aC5qb2luKCd0ZW1wbGF0ZXMnLCB0ZW1wbGF0ZV9uYW1lKQogICAgCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBnZXRfYWRtaW5fcGFzc3dvcmQoY2xzKToKICAgICAgICAiIiJHZXQgY3VycmVudCBhZG1pbiBwYXNzd29yZCBmcm9tIG1lbW9yeSIiIgogICAgICAgIHJldHVybiBjbHMuQURNSU5fUEFTU1dPUkQKICAgIAogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgaW5pdF9kYihjbHMpOgogICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoY2xzLkRCX0ZJTEUpCiAgICAgICAgIyBFbnN1cmUgZGF0YWJhc2UgZmlsZSBoYXMgcHJvcGVyIHBlcm1pc3Npb25zIG9uIExpbnV4CiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5jaG1vZChjbHMuREJfRklMRSwgMG82NDQpCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBBdHRyaWJ1dGVFcnJvcik6CiAgICAgICAgICAgIHBhc3MgICMgSWdub3JlIHBlcm1pc3Npb24gZXJyb3JzCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB1c2VycyAoCiAgICAgICAgICAgICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZLAogICAgICAgICAgICAgICAgdXNlcm5hbWUgVEVYVCBVTklRVUUgTk9UIE5VTEwsCiAgICAgICAgICAgICAgICBwYXNzd29yZF9oYXNoIFRFWFQgTk9UIE5VTEwsCiAgICAgICAgICAgICAgICBzYWx0IFRFWFQgTk9UIE5VTEwsCiAgICAgICAgICAgICAgICBpc19hcHByb3ZlZCBCT09MRUFOIERFRkFVTFQgMCwKICAgICAgICAgICAgICAgIGNyZWF0ZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsCiAgICAgICAgICAgICAgICBwYXNzd29yZF9wbGFpbiBURVhUCiAgICAgICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgc2hhcmVkX3BhdGhzIHRhYmxlCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJycnCiAgICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHNoYXJlZF9wYXRocyAoCiAgICAgICAgICAgICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZLAogICAgICAgICAgICAgICAgcGF0aCBURVhUIFVOSVFVRSBOT1QgTlVMTCwKICAgICAgICAgICAgICAgIHNoYXJlZF9ieSBURVhUIE5PVCBOVUxMLAogICAgICAgICAgICAgICAgaXNfZmlsZSBCT09MRUFOIERFRkFVTFQgMCwKICAgICAgICAgICAgICAgIGNyZWF0ZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAKICAgICAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIEFkZCBpc19maWxlIGNvbHVtbiBpZiBpdCBkb2Vzbid0IGV4aXN0IChtaWdyYXRpb24pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnQUxURVIgVEFCTEUgc2hhcmVkX3BhdGhzIEFERCBDT0xVTU4gaXNfZmlsZSBCT09MRUFOIERFRkFVTFQgMCcpCiAgICAgICAgZXhjZXB0IHNxbGl0ZTMuT3BlcmF0aW9uYWxFcnJvcjoKICAgICAgICAgICAgcGFzcyAgIyBDb2x1bW4gYWxyZWFkeSBleGlzdHMKICAgICAgICAKICAgICAgICAjIEFkZCBwYXNzd29yZF9wbGFpbiBjb2x1bW4gaWYgaXQgZG9lc24ndCBleGlzdCAobWlncmF0aW9uKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJ0FMVEVSIFRBQkxFIHVzZXJzIEFERCBDT0xVTU4gcGFzc3dvcmRfcGxhaW4gVEVYVCcpCiAgICAgICAgZXhjZXB0IHNxbGl0ZTMuT3BlcmF0aW9uYWxFcnJvcjoKICAgICAgICAgICAgcGFzcyAgIyBDb2x1bW4gYWxyZWFkeSBleGlzdHMKICAgICAgICAKICAgICAgICAjIEFsd2F5cyBnZW5lcmF0ZSBuZXcgYWRtaW4gcGFzc3dvcmQgb24gZWFjaCBzdGFydAogICAgICAgIGltcG9ydCB1dWlkCiAgICAgICAgYWRtaW5fcGFzc3dvcmQgPSBzdHIodXVpZC51dWlkNCgpKQogICAgICAgIGFkbWluX3NhbHQgPSBzZWNyZXRzLnRva2VuX2hleCgxNikKICAgICAgICBhZG1pbl9oYXNoID0gaGFzaGxpYi5wYmtkZjJfaG1hYygnc2hhMjU2JywgYWRtaW5fcGFzc3dvcmQuZW5jb2RlKCksIGFkbWluX3NhbHQuZW5jb2RlKCksIDEwMDAwMCkKICAgICAgICAKICAgICAgICAjIENoZWNrIGlmIGFkbWluIHVzZXIgZXhpc3RzCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJ1NFTEVDVCBDT1VOVCgqKSBGUk9NIHVzZXJzIFdIRVJFIHVzZXJuYW1lID0gPycsICgnYWRtaW4nLCkpCiAgICAgICAgaWYgY3Vyc29yLmZldGNob25lKClbMF0gPT0gMDoKICAgICAgICAgICAgIyBDcmVhdGUgbmV3IGFkbWluIHVzZXIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJ0lOU0VSVCBJTlRPIHVzZXJzICh1c2VybmFtZSwgcGFzc3dvcmRfaGFzaCwgc2FsdCwgaXNfYXBwcm92ZWQsIHBhc3N3b3JkX3BsYWluKSBWQUxVRVMgKD8sID8sID8sIDEsID8pJywKICAgICAgICAgICAgICAgICAgICAgICAgICgnYWRtaW4nLCBhZG1pbl9oYXNoLmhleCgpLCBhZG1pbl9zYWx0LCBhZG1pbl9wYXNzd29yZCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBVcGRhdGUgZXhpc3RpbmcgYWRtaW4gdXNlciB3aXRoIG5ldyBwYXNzd29yZAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnVVBEQVRFIHVzZXJzIFNFVCBwYXNzd29yZF9oYXNoID0gPywgc2FsdCA9ID8sIHBhc3N3b3JkX3BsYWluID0gPyBXSEVSRSB1c2VybmFtZSA9ID8nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIChhZG1pbl9oYXNoLmhleCgpLCBhZG1pbl9zYWx0LCBhZG1pbl9wYXNzd29yZCwgJ2FkbWluJykpCiAgICAgICAgICAgIGV4Y2VwdCBzcWxpdGUzLk9wZXJhdGlvbmFsRXJyb3I6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIGlmIHBhc3N3b3JkX3BsYWluIGNvbHVtbiBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnVVBEQVRFIHVzZXJzIFNFVCBwYXNzd29yZF9oYXNoID0gPywgc2FsdCA9ID8gV0hFUkUgdXNlcm5hbWUgPSA/JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYWRtaW5faGFzaC5oZXgoKSwgYWRtaW5fc2FsdCwgJ2FkbWluJykpCiAgICAgICAgCiAgICAgICAgIyBTdG9yZSBwYXNzd29yZCBpbiBtZW1vcnkKICAgICAgICBjbHMuQURNSU5fUEFTU1dPUkQgPSBhZG1pbl9wYXNzd29yZAogICAgICAgIHByaW50KGYiXG4qKiogQURNSU4gUEFTU1dPUkQ6IHthZG1pbl9wYXNzd29yZH0gKioqIikKICAgICAgICBwcmludCgiKioqIE5FVyBQQVNTV09SRCBHRU5FUkFURUQgLSBTQVZFIElUIE5PVyAqKipcbiIpCiAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBnZXRfc2hhcmVkX3BhdGhzKGNscyk6CiAgICAgICAgIiIiR2V0IHNoYXJlZCBwYXRocyBmcm9tIGRhdGFiYXNlIHdpdGggY2FjaGluZyIiIgogICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgIyBDYWNoZSBmb3IgMzAgc2Vjb25kcyB0byBpbXByb3ZlIHBlcmZvcm1hbmNlCiAgICAgICAgaWYgY2xzLlNIQVJFRF9QQVRIU19DQUNIRSBpcyBOb25lIG9yIChjdXJyZW50X3RpbWUgLSBjbHMuQ0FDSEVfVElNRVNUQU1QKSA+IDMwOgogICAgICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KGNscy5EQl9GSUxFKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCdTRUxFQ1QgcGF0aCwgaXNfZmlsZSBGUk9NIHNoYXJlZF9wYXRocycpCiAgICAgICAgICAgIGNscy5TSEFSRURfUEFUSFNfQ0FDSEUgPSB7cm93WzBdOiBib29sKHJvd1sxXSkgZm9yIHJvdyBpbiBjdXJzb3IuZmV0Y2hhbGwoKX0KICAgICAgICAgICAgY2xzLkNBQ0hFX1RJTUVTVEFNUCA9IGN1cnJlbnRfdGltZQogICAgICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICByZXR1cm4gY2xzLlNIQVJFRF9QQVRIU19DQUNIRQogICAgCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBpbnZhbGlkYXRlX3NoYXJlZF9wYXRoc19jYWNoZShjbHMpOgogICAgICAgICIiIkludmFsaWRhdGUgY2FjaGUgd2hlbiBwYXRocyBhcmUgbW9kaWZpZWQiIiIKICAgICAgICBjbHMuU0hBUkVEX1BBVEhTX0NBQ0hFID0gTm9uZQogICAgICAgIGNscy5DQUNIRV9USU1FU1RBTVAgPSAwCiAgICAKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIGNyZWF0ZV91c2VyKGNscywgdXNlcm5hbWUsIHBhc3N3b3JkKToKICAgICAgICBzYWx0ID0gc2VjcmV0cy50b2tlbl9oZXgoMTYpCiAgICAgICAgcGFzc3dvcmRfaGFzaCA9IGhhc2hsaWIucGJrZGYyX2htYWMoJ3NoYTI1NicsIHBhc3N3b3JkLmVuY29kZSgpLCBzYWx0LmVuY29kZSgpLCAxMDAwMDApCiAgICAgICAgCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChjbHMuREJfRklMRSkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEV4cGxpY2l0bHkgc2V0IGlzX2FwcHJvdmVkPTAgdG8gZW5zdXJlIHVzZXIgbmVlZHMgYWRtaW4gYXBwcm92YWwKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJ0lOU0VSVCBJTlRPIHVzZXJzICh1c2VybmFtZSwgcGFzc3dvcmRfaGFzaCwgc2FsdCwgaXNfYXBwcm92ZWQpIFZBTFVFUyAoPywgPywgPywgMCknLAogICAgICAgICAgICAgICAgICAgICAgICAgKHVzZXJuYW1lLCBwYXNzd29yZF9oYXNoLmhleCgpLCBzYWx0KSkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICBwcmludChmIkNyZWF0ZWQgdXNlciAne3VzZXJuYW1lfScgLSB3YWl0aW5nIGZvciBhZG1pbiBhcHByb3ZhbCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IHNxbGl0ZTMuSW50ZWdyaXR5RXJyb3I6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGNvbm4uY2xvc2UoKQogICAgCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiB2ZXJpZnlfdXNlcihjbHMsIHVzZXJuYW1lLCBwYXNzd29yZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KGNscy5EQl9GSUxFLCB0aW1lb3V0PTUuMCkgICMgQWRkIHRpbWVvdXQKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnU0VMRUNUIHBhc3N3b3JkX2hhc2gsIHNhbHQsIGlzX2FwcHJvdmVkIEZST00gdXNlcnMgV0hFUkUgdXNlcm5hbWUgPSA/JywgKHVzZXJuYW1lLCkpCiAgICAgICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSwgJ1VzZXIgbm90IGZvdW5kJwogICAgICAgICAgICAKICAgICAgICAgICAgc3RvcmVkX2hhc2gsIHNhbHQsIGlzX2FwcHJvdmVkID0gcmVzdWx0CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFF1aWNrIGFwcHJvdmFsIGNoZWNrIGZpcnN0CiAgICAgICAgICAgIGlmIG5vdCBpc19hcHByb3ZlZDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSwgJ0FjY291bnQgcGVuZGluZyBhcHByb3ZhbCcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGhlbiB2ZXJpZnkgcGFzc3dvcmQKICAgICAgICAgICAgcGFzc3dvcmRfaGFzaCA9IGhhc2hsaWIucGJrZGYyX2htYWMoJ3NoYTI1NicsIHBhc3N3b3JkLmVuY29kZSgpLCBzYWx0LmVuY29kZSgpLCAxMDAwMDApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBwYXNzd29yZF9oYXNoLmhleCgpICE9IHN0b3JlZF9oYXNoOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCAnSW52YWxpZCBwYXNzd29yZCcKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlLCAnU3VjY2VzcycKICAgICAgICBleGNlcHQgc3FsaXRlMy5FcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChmIkRhdGFiYXNlIGVycm9yIGR1cmluZyBsb2dpbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCAnRGF0YWJhc2UgZXJyb3IgLSBwbGVhc2UgdHJ5IGFnYWluJwogICAgCiAgICBkZWYgZ2VuZXJhdGVfdG9rZW4oc2VsZiwgdXNlcm5hbWUpOgogICAgICAgIHRva2VuID0gc2VjcmV0cy50b2tlbl91cmxzYWZlKDMyKQogICAgICAgIGV4cGlyZXMgPSB0aW1lLnRpbWUoKSArIDM2MDAgICMgMSBob3VyCiAgICAgICAgc2VsZi5WQUxJRF9UT0tFTlNbdG9rZW5dID0geyd1c2VyJzogdXNlcm5hbWUsICdleHBpcmVzJzogZXhwaXJlc30KICAgICAgICByZXR1cm4gdG9rZW4KICAgIAogICAgZGVmIGNoZWNrX3JhdGVfbGltaXQoc2VsZiwgY2xpZW50X2lwLCBieXBhc3NfYWRtaW49RmFsc2UpOgogICAgICAgICIiIlNpbXBsZSByYXRlIGxpbWl0IGNoZWNrIC0gb25seSB1c2VkIGZvciBhZG1pbiBvcGVyYXRpb25zIG5vdyIiIgogICAgICAgIGlmIGJ5cGFzc19hZG1pbjoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgaWYgY2xpZW50X2lwIGluIHNlbGYuRkFJTEVEX0FUVEVNUFRTOgogICAgICAgICAgICBhdHRlbXB0cywgbGFzdF9hdHRlbXB0ID0gc2VsZi5GQUlMRURfQVRURU1QVFNbY2xpZW50X2lwXQogICAgICAgICAgICAjIENsZWFyIGV4cGlyZWQgYXR0ZW1wdHMKICAgICAgICAgICAgaWYgdGltZS50aW1lKCkgLSBsYXN0X2F0dGVtcHQgPiAxMjA6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5GQUlMRURfQVRURU1QVFNbY2xpZW50X2lwXQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgIyBCbG9jayBpZiA1IG9yIG1vcmUgYXR0ZW1wdHMKICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRzIDwgNQogICAgICAgIHJldHVybiBUcnVlCiAgICAKICAgIGRlZiByZWNvcmRfZmFpbGVkX2F0dGVtcHQoc2VsZiwgY2xpZW50X2lwKToKICAgICAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIGlmIGNsaWVudF9pcCBpbiBzZWxmLkZBSUxFRF9BVFRFTVBUUzoKICAgICAgICAgICAgYXR0ZW1wdHMsIF8gPSBzZWxmLkZBSUxFRF9BVFRFTVBUU1tjbGllbnRfaXBdCiAgICAgICAgICAgIG5ld19hdHRlbXB0cyA9IGF0dGVtcHRzICsgMQogICAgICAgICAgICBzZWxmLkZBSUxFRF9BVFRFTVBUU1tjbGllbnRfaXBdID0gKG5ld19hdHRlbXB0cywgbm93KQogICAgICAgICAgICBwcmludChmIkRFQlVHOiBSZWNvcmRlZCBmYWlsZWQgYXR0ZW1wdCBmb3Ige2NsaWVudF9pcH06IHtuZXdfYXR0ZW1wdHN9IHRvdGFsIGF0dGVtcHRzIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLkZBSUxFRF9BVFRFTVBUU1tjbGllbnRfaXBdID0gKDEsIG5vdykKICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogRmlyc3QgZmFpbGVkIGF0dGVtcHQgcmVjb3JkZWQgZm9yIHtjbGllbnRfaXB9IikKICAgIAogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgY2xlYXJfcmF0ZV9saW1pdChjbHMsIGNsaWVudF9pcD1Ob25lKToKICAgICAgICAiIiJDbGVhciByYXRlIGxpbWl0aW5nIGZvciBzcGVjaWZpYyBJUCBvciBhbGwgSVBzIiIiCiAgICAgICAgcHJpbnQoZiJERUJVRzogY2xlYXJfcmF0ZV9saW1pdCBjYWxsZWQgd2l0aCBjbGllbnRfaXA9e2NsaWVudF9pcH0iKQogICAgICAgIHByaW50KGYiREVCVUc6IEN1cnJlbnQgRkFJTEVEX0FUVEVNUFRTOiB7Y2xzLkZBSUxFRF9BVFRFTVBUU30iKQogICAgICAgIAogICAgICAgIGlmIGNsaWVudF9pcDoKICAgICAgICAgICAgaWYgY2xpZW50X2lwIGluIGNscy5GQUlMRURfQVRURU1QVFM6CiAgICAgICAgICAgICAgICBkZWwgY2xzLkZBSUxFRF9BVFRFTVBUU1tjbGllbnRfaXBdCiAgICAgICAgICAgICAgICBwcmludChmIuKchSBSYXRlIGxpbWl0IGNsZWFyZWQgZm9yIHtjbGllbnRfaXB9IikKICAgICAgICAgICAgICAgIHByaW50KGYiREVCVUc6IEFmdGVyIGNsZWFyaW5nLCBGQUlMRURfQVRURU1QVFM6IHtjbHMuRkFJTEVEX0FUVEVNUFRTfSIpCiAgICAgICAgICAgICAgICBjbHMuQURNSU5fTk9USUZJQ0FUSU9OUy5hcHBlbmQoZiJSYXRlIGxpbWl0IGNsZWFyZWQgZm9yIHtjbGllbnRfaXB9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KGYi4pqg77iPICBObyByYXRlIGxpbWl0IGZvdW5kIGZvciB7Y2xpZW50X2lwfSIpCiAgICAgICAgICAgICAgICBjbHMuQURNSU5fTk9USUZJQ0FUSU9OUy5hcHBlbmQoZiJObyByYXRlIGxpbWl0IGZvdW5kIGZvciB7Y2xpZW50X2lwfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY291bnQgPSBsZW4oY2xzLkZBSUxFRF9BVFRFTVBUUykKICAgICAgICAgICAgY2xzLkZBSUxFRF9BVFRFTVBUUy5jbGVhcigpCiAgICAgICAgICAgIHByaW50KGYi4pyFIEFsbCByYXRlIGxpbWl0cyBjbGVhcmVkICh7Y291bnR9IElQcykiKQogICAgICAgICAgICBwcmludChmIkRFQlVHOiBBZnRlciBjbGVhcmluZyBhbGwsIEZBSUxFRF9BVFRFTVBUUzoge2Nscy5GQUlMRURfQVRURU1QVFN9IikKICAgICAgICAgICAgY2xzLkFETUlOX05PVElGSUNBVElPTlMuYXBwZW5kKGYiQWxsIHJhdGUgbGltaXRzIGNsZWFyZWQgKHtjb3VudH0gSVBzKSIpCiAgICAKICAgIGRlZiBjaGVja190b2tlbl9hdXRoKHNlbGYpOgogICAgICAgIGlmICc/dG9rZW49JyBpbiBzZWxmLnBhdGg6CiAgICAgICAgICAgIHBhdGhfcGFydHMgPSBzZWxmLnBhdGguc3BsaXQoJz90b2tlbj0nKQogICAgICAgICAgICBpZiBsZW4ocGF0aF9wYXJ0cykgPT0gMjoKICAgICAgICAgICAgICAgIHNlbGYucGF0aCA9IHBhdGhfcGFydHNbMF0KICAgICAgICAgICAgICAgIHRva2VuID0gcGF0aF9wYXJ0c1sxXS5zcGxpdCgnJicpWzBdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHRva2VuIGluIHNlbGYuVkFMSURfVE9LRU5TOgogICAgICAgICAgICAgICAgICAgIHRva2VuX2RhdGEgPSBzZWxmLlZBTElEX1RPS0VOU1t0b2tlbl0KICAgICAgICAgICAgICAgICAgICBpZiB0aW1lLnRpbWUoKSA8IHRva2VuX2RhdGFbJ2V4cGlyZXMnXToKICAgICAgICAgICAgICAgICAgICAgICAgIyBVcGRhdGUgYWN0aXZlIHVzZXIgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5BQ1RJVkVfVVNFUlNbdG9rZW5dID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXInOiB0b2tlbl9kYXRhWyd1c2VyJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGFzdF9hY3Rpdml0eSc6IHRpbWUudGltZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lwJzogc2VsZi5jbGllbnRfYWRkcmVzc1swXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyX2FnZW50Jzogc2VsZi5oZWFkZXJzLmdldCgnVXNlci1BZ2VudCcsICdVbmtub3duJylbOjUwXQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbl9kYXRhWyd1c2VyJ10KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIENsZWFuIHVwIGV4cGlyZWQgdG9rZW4KICAgICAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuVkFMSURfVE9LRU5TW3Rva2VuXQogICAgICAgICAgICAgICAgICAgICAgICBpZiB0b2tlbiBpbiBzZWxmLkFDVElWRV9VU0VSUzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLkFDVElWRV9VU0VSU1t0b2tlbl0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgY2xlYW51cF9leHBpcmVkX3Rva2VucyhzZWxmKToKICAgICAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIGV4cGlyZWRfdG9rZW5zID0gW3Rva2VuIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpIGlmIG5vdyA+PSBkYXRhWydleHBpcmVzJ11dCiAgICAgICAgZm9yIHRva2VuIGluIGV4cGlyZWRfdG9rZW5zOgogICAgICAgICAgICBkZWwgc2VsZi5WQUxJRF9UT0tFTlNbdG9rZW5dCiAgICAKICAgIGRlZiBmb3JtYXRfc2l6ZShzZWxmLCBzaXplKToKICAgICAgICAiIiJGb3JtYXQgZmlsZSBzaXplIGluIGh1bWFuIHJlYWRhYmxlIGZvcm1hdCIiIgogICAgICAgIGZvciB1bml0IGluIFsnQicsICdLQicsICdNQicsICdHQiddOgogICAgICAgICAgICBpZiBzaXplIDwgMTAyNDoKICAgICAgICAgICAgICAgIHJldHVybiBmIntzaXplOi4xZn0ge3VuaXR9IgogICAgICAgICAgICBzaXplIC89IDEwMjQKICAgICAgICByZXR1cm4gZiJ7c2l6ZTouMWZ9IFRCIgogICAgCiAgICBkZWYgc2VuZF9hdXRoX3BhZ2Uoc2VsZiwgZXJyb3JfbXNnPScnKToKICAgICAgICBjbGllbnRfaXAgPSBzZWxmLmNsaWVudF9hZGRyZXNzWzBdCiAgICAgICAgCiAgICAgICAgIyBPbmx5IHNob3cgcmF0ZSBsaW1pdCBtZXNzYWdlIGlmIHVzZXIgaXMgYWN0dWFsbHkgcmF0ZSBsaW1pdGVkIEFORCB0aGlzIGlzIGFmdGVyIGEgZmFpbGVkIGF0dGVtcHQKICAgICAgICBpZiBlcnJvcl9tc2cgYW5kICfinYwnIGluIGVycm9yX21zZzoKICAgICAgICAgICAgIyBEb24ndCBjYWxsIGNoZWNrX3JhdGVfbGltaXQgaGVyZSAtIGp1c3QgY2hlY2sgaWYgSVAgaXMgaW4gRkFJTEVEX0FUVEVNUFRTIHdpdGggPj0gNSBhdHRlbXB0cwogICAgICAgICAgICBpZiBjbGllbnRfaXAgaW4gc2VsZi5GQUlMRURfQVRURU1QVFM6CiAgICAgICAgICAgICAgICBhdHRlbXB0cywgbGFzdF9hdHRlbXB0ID0gc2VsZi5GQUlMRURfQVRURU1QVFNbY2xpZW50X2lwXQogICAgICAgICAgICAgICAgaWYgYXR0ZW1wdHMgPj0gNSBhbmQgKHRpbWUudGltZSgpIC0gbGFzdF9hdHRlbXB0KSA8PSAxMjA6CiAgICAgICAgICAgICAgICAgICAgdGltZV9yZW1haW5pbmcgPSBpbnQoMTIwIC0gKHRpbWUudGltZSgpIC0gbGFzdF9hdHRlbXB0KSkKICAgICAgICAgICAgICAgICAgICBpZiB0aW1lX3JlbWFpbmluZyA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYn8J+aqyBUb28gbWFueSBmYWlsZWQgbG9naW4gYXR0ZW1wdHMgKHthdHRlbXB0c30pLiBQbGVhc2Ugd2FpdCB7dGltZV9yZW1haW5pbmd9IHNlY29uZHMgYmVmb3JlIHRyeWluZyBhZ2Fpbi4nCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gJ/CfmqsgVG9vIG1hbnkgZmFpbGVkIGxvZ2luIGF0dGVtcHRzLiBQbGVhc2UgY29udGFjdCBhZG1pbiB0byBjbGVhciByYXRlIGxpbWl0cy4nCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ZW1wbGF0ZV9wYXRoID0gc2VsZi5nZXRfdGVtcGxhdGVfcGF0aCgnbG9naW4uaHRtbCcpCiAgICAgICAgICAgIHdpdGggb3Blbih0ZW1wbGF0ZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBodG1sID0gZi5yZWFkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGVycm9yX21zZzoKICAgICAgICAgICAgICAgIGlmICfwn5qrJyBpbiBlcnJvcl9tc2c6ICAjIFJhdGUgbGltaXQgbWVzc2FnZQogICAgICAgICAgICAgICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoJzxwPjxzbWFsbD5TZWN1cmUgdG9rZW4tYmFzZWQgYXV0aGVudGljYXRpb248L3NtYWxsPjwvcD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYnPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogI2Y4ZDdkYTsgY29sb3I6ICM3MjFjMjQ7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgbWFyZ2luOiAxNXB4IDA7IGJvcmRlcjogMXB4IHNvbGlkICNmNWM2Y2I7Ij48c3Ryb25nPlJhdGUgTGltaXRlZDwvc3Ryb25nPjxicj57ZXJyb3JfbXNnfTwvZGl2PicpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoJzxwPjxzbWFsbD5TZWN1cmUgdG9rZW4tYmFzZWQgYXV0aGVudGljYXRpb248L3NtYWxsPjwvcD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYnPHAgc3R5bGU9ImNvbG9yOiByZWQ7Ij57ZXJyb3JfbXNnfTwvcD4nKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC10eXBlJywgJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcpCiAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKGh0bWwuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDUwMCwgIlRlbXBsYXRlIGZpbGUgbm90IGZvdW5kIikKICAgIAogICAgZGVmIHNlbmRfd2VsY29tZV9wYWdlKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBIYW5kbGUgYm90aCBkZXZlbG9wbWVudCBhbmQgcGFja2FnZWQgYXBwIHBhdGhzCiAgICAgICAgICAgIHRlbXBsYXRlX3BhdGggPSBzZWxmLmdldF90ZW1wbGF0ZV9wYXRoKCd3ZWxjb21lLmh0bWwnKQogICAgICAgICAgICB3aXRoIG9wZW4odGVtcGxhdGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgaHRtbCA9IGYucmVhZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDb250ZW50LXR5cGUnLCAndGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04JykKICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoaHRtbC5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNTAwLCAiVGVtcGxhdGUgZmlsZSBub3QgZm91bmQiKQogICAgCiAgICBkZWYgc2VuZF9yZWdpc3Rlcl9wYWdlKHNlbGYsIGVycm9yX21zZz0nJyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ZW1wbGF0ZV9wYXRoID0gc2VsZi5nZXRfdGVtcGxhdGVfcGF0aCgncmVnaXN0ZXIuaHRtbCcpCiAgICAgICAgICAgIHdpdGggb3Blbih0ZW1wbGF0ZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBodG1sID0gZi5yZWFkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGVycm9yX21zZzoKICAgICAgICAgICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoJzxkaXYgY2xhc3M9InJlcXVpcmVtZW50cyI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYnPGRpdiBzdHlsZT0iY29sb3I6IHJlZDsgbWFyZ2luOiAxMHB4IDA7Ij57ZXJyb3JfbXNnfTwvZGl2PjxkaXYgY2xhc3M9InJlcXVpcmVtZW50cyI+JykKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtdHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShodG1sLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsICJUZW1wbGF0ZSBmaWxlIG5vdCBmb3VuZCIpCiAgICAKICAgIGRlZiBzZW5kX3JlZ2lzdHJhdGlvbl9zdWNjZXNzX3BhZ2Uoc2VsZiwgdXNlcm5hbWUpOgogICAgICAgICIiIlNlbmQgc3VjY2VzcyBwYWdlIHdpdGggcG9wdXAtc3R5bGUgbWVzc2FnZSBhZnRlciByZWdpc3RyYXRpb24iIiIKICAgICAgICBodG1sID0gZicnJzwhRE9DVFlQRSBodG1sPgo8aHRtbD4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8dGl0bGU+UmVnaXN0cmF0aW9uIFN1Y2Nlc3NmdWw8L3RpdGxlPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIj4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHt7IGZvbnQtZmFtaWx5OiBBcmlhbCwgc2Fucy1zZXJpZjsgYmFja2dyb3VuZDogI2Y1ZjVmNTsgbWFyZ2luOiAwOyBwYWRkaW5nOiAyMHB4OyB9fQogICAgICAgIC5wb3B1cCB7eyBiYWNrZ3JvdW5kOiB3aGl0ZTsgbWF4LXdpZHRoOiA1MDBweDsgbWFyZ2luOiA1MHB4IGF1dG87IHBhZGRpbmc6IDMwcHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IGJveC1zaGFkb3c6IDAgNHB4IDIwcHggcmdiYSgwLDAsMCwwLjEpOyB0ZXh0LWFsaWduOiBjZW50ZXI7IH19CiAgICAgICAgLnN1Y2Nlc3MtaWNvbiB7eyBmb250LXNpemU6IDYwcHg7IGNvbG9yOiAjMjhhNzQ1OyBtYXJnaW4tYm90dG9tOiAyMHB4OyB9fQogICAgICAgIC50aXRsZSB7eyBjb2xvcjogIzI4YTc0NTsgZm9udC1zaXplOiAyNHB4OyBmb250LXdlaWdodDogYm9sZDsgbWFyZ2luLWJvdHRvbTogMTVweDsgfX0KICAgICAgICAubWVzc2FnZSB7eyBjb2xvcjogIzY2NjsgZm9udC1zaXplOiAxNnB4OyBsaW5lLWhlaWdodDogMS41OyBtYXJnaW4tYm90dG9tOiAyNXB4OyB9fQogICAgICAgIC5sb2dpbi1idG4ge3sgYmFja2dyb3VuZDogIzAwN2JmZjsgY29sb3I6IHdoaXRlOyBwYWRkaW5nOiAxMnB4IDMwcHg7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNXB4OyBmb250LXNpemU6IDE2cHg7IGRpc3BsYXk6IGlubGluZS1ibG9jazsgfX0KICAgICAgICAubG9naW4tYnRuOmhvdmVyIHt7IGJhY2tncm91bmQ6ICMwMDU2YjM7IH19CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBjbGFzcz0icG9wdXAiPgogICAgICAgIDxkaXYgY2xhc3M9InN1Y2Nlc3MtaWNvbiI+4pyFPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0idGl0bGUiPkFjY291bnQgQ3JlYXRlZCBTdWNjZXNzZnVsbHkhPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ibWVzc2FnZSI+CiAgICAgICAgICAgIFdlbGNvbWUgPHN0cm9uZz57dXNlcm5hbWV9PC9zdHJvbmc+ITxicj48YnI+CiAgICAgICAgICAgIFlvdXIgYWNjb3VudCBoYXMgYmVlbiBjcmVhdGVkIGFuZCBpcyBub3cgPHN0cm9uZz5wZW5kaW5nIGFkbWluIGFwcHJvdmFsPC9zdHJvbmc+Ljxicj48YnI+CiAgICAgICAgICAgIFlvdSB3aWxsIGJlIGFibGUgdG8gbG9naW4gb25jZSBhbiBhZG1pbmlzdHJhdG9yIGFwcHJvdmVzIHlvdXIgYWNjb3VudC48YnI+CiAgICAgICAgICAgIFBsZWFzZSBjaGVjayBiYWNrIGxhdGVyIG9yIGNvbnRhY3QgdGhlIGFkbWluaXN0cmF0b3IuCiAgICAgICAgPC9kaXY+CiAgICAgICAgPGEgaHJlZj0iL2xvZ2luIiBjbGFzcz0ibG9naW4tYnRuIj5HbyB0byBMb2dpbiBQYWdlPC9hPgogICAgPC9kaXY+CjwvYm9keT4KPC9odG1sPicnJwogICAgICAgIAogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC10eXBlJywgJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCcpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZShodG1sLmVuY29kZSgndXRmLTgnKSkKICAgIAogICAgZGVmIGRvX1BPU1Qoc2VsZik6CiAgICAgICAgY29udGVudF9sZW5ndGggPSBpbnQoc2VsZi5oZWFkZXJzLmdldCgnQ29udGVudC1MZW5ndGgnLCAwKSkKICAgICAgICBwb3N0X2RhdGEgPSBzZWxmLnJmaWxlLnJlYWQoY29udGVudF9sZW5ndGgpLmRlY29kZSgpCiAgICAgICAgY2xpZW50X2lwID0gc2VsZi5jbGllbnRfYWRkcmVzc1swXQogICAgICAgIAogICAgICAgIGlmIHNlbGYucGF0aCA9PSAnL2xvZ2luJzoKICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogTG9naW4gYXR0ZW1wdCBmcm9tIHtjbGllbnRfaXB9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUGFyc2UgZm9ybSBkYXRhIGZpcnN0CiAgICAgICAgICAgIHBhcmFtcyA9IHVybGxpYi5wYXJzZS5wYXJzZV9xcyhwb3N0X2RhdGEpCiAgICAgICAgICAgIHVzZXJuYW1lID0gcGFyYW1zLmdldCgndXNlcm5hbWUnLCBbJyddKVswXQogICAgICAgICAgICBwYXNzd29yZCA9IHBhcmFtcy5nZXQoJ3Bhc3N3b3JkJywgWycnXSlbMF0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQWx3YXlzIGNoZWNrIGFuZCBjbGVhciBleHBpcmVkIHJhdGUgbGltaXRzIGZpcnN0CiAgICAgICAgICAgIG5vdyA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIGlmIGNsaWVudF9pcCBpbiBzZWxmLkZBSUxFRF9BVFRFTVBUUzoKICAgICAgICAgICAgICAgIGF0dGVtcHRzLCBsYXN0X2F0dGVtcHQgPSBzZWxmLkZBSUxFRF9BVFRFTVBUU1tjbGllbnRfaXBdCiAgICAgICAgICAgICAgICAjIENsZWFyIG9sZCBhdHRlbXB0cyBpZiBtb3JlIHRoYW4gMiBtaW51dGVzIHBhc3NlZAogICAgICAgICAgICAgICAgaWYgbm93IC0gbGFzdF9hdHRlbXB0ID4gMTIwOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiREVCVUc6IENsZWFyaW5nIGV4cGlyZWQgYXR0ZW1wdHMgZm9yIHtjbGllbnRfaXB9ICh0aW1lb3V0IHJlYWNoZWQpIikKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5GQUlMRURfQVRURU1QVFNbY2xpZW50X2lwXQogICAgICAgICAgICAgICAgZWxpZiBhdHRlbXB0cyA+PSA1OgogICAgICAgICAgICAgICAgICAgIHRpbWVfcmVtYWluaW5nID0gaW50KDEyMCAtIChub3cgLSBsYXN0X2F0dGVtcHQpKQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiREVCVUc6IFJhdGUgbGltaXQgYWN0aXZlIGZvciB7Y2xpZW50X2lwfSAtIHthdHRlbXB0c30gYXR0ZW1wdHMsIHt0aW1lX3JlbWFpbmluZ31zIHJlbWFpbmluZyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX2F1dGhfcGFnZShmJ/CfmqsgVG9vIG1hbnkgZmFpbGVkIGF0dGVtcHRzLiBQbGVhc2Ugd2FpdCB7dGltZV9yZW1haW5pbmd9IHNlY29uZHMgYmVmb3JlIHRyeWluZyBhZ2Fpbi4nKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogQXR0ZW1wdGluZyBsb2dpbiBmb3IgdXNlcm5hbWU9J3t1c2VybmFtZX0nIGZyb20ge2NsaWVudF9pcH0iKQogICAgICAgICAgICBzdWNjZXNzLCBtZXNzYWdlID0gc2VsZi52ZXJpZnlfdXNlcih1c2VybmFtZSwgcGFzc3dvcmQpCiAgICAgICAgICAgIHByaW50KGYiREVCVUc6IExvZ2luIHJlc3VsdDogc3VjY2Vzcz17c3VjY2Vzc30sIG1lc3NhZ2U9J3ttZXNzYWdlfSciKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgICMgQ2xlYXIgYW55IGZhaWxlZCBhdHRlbXB0cyBvbiBzdWNjZXNzZnVsIGxvZ2luCiAgICAgICAgICAgICAgICBpZiBjbGllbnRfaXAgaW4gc2VsZi5GQUlMRURfQVRURU1QVFM6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogQ2xlYXJpbmcgZmFpbGVkIGF0dGVtcHRzIGZvciB7Y2xpZW50X2lwfSBhZnRlciBzdWNjZXNzZnVsIGxvZ2luIikKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5GQUlMRURfQVRURU1QVFNbY2xpZW50X2lwXQogICAgICAgICAgICAgICAgdG9rZW4gPSBzZWxmLmdlbmVyYXRlX3Rva2VuKHVzZXJuYW1lKQogICAgICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogR2VuZXJhdGVkIHRva2VuIGZvciB7dXNlcm5hbWV9LCByZWRpcmVjdGluZyB0byBtYWluIHBhZ2UiKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDMwMikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0xvY2F0aW9uJywgZicvP3Rva2VuPXt0b2tlbn0nKQogICAgICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIkRFQlVHOiBMb2dpbiBmYWlsZWQgZm9yIHt1c2VybmFtZX06IHttZXNzYWdlfSIpCiAgICAgICAgICAgICAgICBzZWxmLnJlY29yZF9mYWlsZWRfYXR0ZW1wdChjbGllbnRfaXApCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfYXV0aF9wYWdlKGYn4p2MIHttZXNzYWdlfScpCiAgICAgICAgCiAgICAgICAgZWxpZiBzZWxmLnBhdGggPT0gJy9yZWdpc3Rlcic6CiAgICAgICAgICAgIHBhcmFtcyA9IHVybGxpYi5wYXJzZS5wYXJzZV9xcyhwb3N0X2RhdGEpCiAgICAgICAgICAgIHVzZXJuYW1lID0gcGFyYW1zLmdldCgndXNlcm5hbWUnLCBbJyddKVswXQogICAgICAgICAgICBwYXNzd29yZCA9IHBhcmFtcy5nZXQoJ3Bhc3N3b3JkJywgWycnXSlbMF0KICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYiREVCVUc6IFJlZ2lzdHJhdGlvbiBhdHRlbXB0IGZvciB1c2VybmFtZT0ne3VzZXJuYW1lfScgZnJvbSB7Y2xpZW50X2lwfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBsZW4odXNlcm5hbWUpIDwgMyBvciBsZW4ocGFzc3dvcmQpIDwgNjoKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9yZWdpc3Rlcl9wYWdlKCdVc2VybmFtZSBtdXN0IGJlIGF0IGxlYXN0IDMgY2hhcmFjdGVycyBhbmQgcGFzc3dvcmQgYXQgbGVhc3QgNiBjaGFyYWN0ZXJzJykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi5jcmVhdGVfdXNlcih1c2VybmFtZSwgcGFzc3dvcmQpOgogICAgICAgICAgICAgICAgcHJpbnQoZiJERUJVRzogVXNlciAne3VzZXJuYW1lfScgY3JlYXRlZCBzdWNjZXNzZnVsbHkgLSBzaG93aW5nIHN1Y2Nlc3MgcG9wdXAiKQogICAgICAgICAgICAgICAgIyBTaG93IGRlZGljYXRlZCBzdWNjZXNzIHBhZ2Ugd2l0aCBwb3B1cC1zdHlsZSBtZXNzYWdlCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcmVnaXN0cmF0aW9uX3N1Y2Nlc3NfcGFnZSh1c2VybmFtZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KGYiREVCVUc6IEZhaWxlZCB0byBjcmVhdGUgdXNlciAne3VzZXJuYW1lfScgLSB1c2VybmFtZSBhbHJlYWR5IGV4aXN0cyIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcmVnaXN0ZXJfcGFnZSgn4p2MIFVzZXJuYW1lIGFscmVhZHkgZXhpc3RzLiBQbGVhc2UgY2hvb3NlIGFub3RoZXIuJykKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDA0KQogICAgCiAgICBkZWYgZG9fSEVBRChzZWxmKToKICAgICAgICAiIiJIYW5kbGUgSEVBRCByZXF1ZXN0cyBmb3IgdmlkZW8gc3RyZWFtaW5nIiIiCiAgICAgICAgc2VsZi5kb19HRVQoKQogICAgCiAgICBkZWYgZG9fR0VUKHNlbGYpOgogICAgICAgICMgQ2xlYW4gdXAgZXhwaXJlZCB0b2tlbnMgZmlyc3QKICAgICAgICBzZWxmLmNsZWFudXBfZXhwaXJlZF90b2tlbnMoKQogICAgICAgIAogICAgICAgICMgSGFuZGxlIHJhdGUgbGltaXQgY2xlYXJpbmcgQkVGT1JFIHRva2VuIGF1dGggdG8gYXZvaWQgdHJpZ2dlcmluZyByYXRlIGxpbWl0cwogICAgICAgIGlmIHNlbGYucGF0aC5zdGFydHN3aXRoKCcvYWRtaW4vY2xlYXItcmF0ZS1saW1pdCcpOgogICAgICAgICAgICAjIENoZWNrIHRva2VuIGF1dGhlbnRpY2F0aW9uIGZvciBhZG1pbiByb3V0ZXMKICAgICAgICAgICAgdXNlciA9IHNlbGYuY2hlY2tfdG9rZW5fYXV0aCgpCiAgICAgICAgICAgIGlmIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgIGlmIHNlbGYucGF0aCA9PSAnL2FkbWluL2NsZWFyLXJhdGUtbGltaXQnOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJBZG1pbiBjbGVhcmluZyBBTEwgcmF0ZSBsaW1pdHMiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJfcmF0ZV9saW1pdCgpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IE5vbmUKICAgICAgICAgICAgICAgICAgICBmb3IgdG9rZW4sIGRhdGEgaW4gc2VsZi5WQUxJRF9UT0tFTlMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGF0YVsndXNlciddID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3Rva2VuID0gdG9rZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDMwMikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdMb2NhdGlvbicsIGYnL2FkbWluL3JhdGUtbGltaXRzP3Rva2VuPXtjdXJyZW50X3Rva2VufScpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBlbGlmIHNlbGYucGF0aC5zdGFydHN3aXRoKCcvYWRtaW4vY2xlYXItcmF0ZS1saW1pdC8nKToKICAgICAgICAgICAgICAgICAgICBwYXRoX3BhcnQgPSBzZWxmLnBhdGhbMjU6XSAgIyBSZW1vdmUgJy9hZG1pbi9jbGVhci1yYXRlLWxpbWl0LycKICAgICAgICAgICAgICAgICAgICBpZiAnPycgaW4gcGF0aF9wYXJ0OgogICAgICAgICAgICAgICAgICAgICAgICBpcF90b19jbGVhciA9IHVybGxpYi5wYXJzZS51bnF1b3RlKHBhdGhfcGFydC5zcGxpdCgnPycpWzBdKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGlwX3RvX2NsZWFyID0gdXJsbGliLnBhcnNlLnVucXVvdGUocGF0aF9wYXJ0KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHByaW50KGYiQWRtaW4gY2xlYXJpbmcgcmF0ZSBsaW1pdCBmb3IgSVA6IHtpcF90b19jbGVhcn0iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJfcmF0ZV9saW1pdChpcF90b19jbGVhcikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgICAgICAgICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMzAyKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0xvY2F0aW9uJywgZicvYWRtaW4vcmF0ZS1saW1pdHM/dG9rZW49e2N1cnJlbnRfdG9rZW59JykKICAgICAgICAgICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDEsICJBY2Nlc3MgZGVuaWVkIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgQ2hlY2sgdG9rZW4gYXV0aGVudGljYXRpb24gZm9yIG90aGVyIHJvdXRlcwogICAgICAgIHVzZXIgPSBzZWxmLmNoZWNrX3Rva2VuX2F1dGgoKQogICAgICAgIAogICAgICAgIGlmIHNlbGYucGF0aCA9PSAnL3JlZ2lzdGVyJzoKICAgICAgICAgICAgc2VsZi5zZW5kX3JlZ2lzdGVyX3BhZ2UoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBzZWxmLnBhdGggPT0gJy9hZG1pbicgYW5kIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgc2VsZi5zZW5kX2FkbWluX3BhZ2UoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBzZWxmLnBhdGguc3RhcnRzd2l0aCgnL2FkbWluL2FwcHJvdmUvJykgYW5kIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgdXNlcl9pZCA9IHNlbGYucGF0aC5zcGxpdCgnLycpWy0xXQogICAgICAgICAgICBzZWxmLmFwcHJvdmVfdXNlcih1c2VyX2lkKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBzZWxmLnBhdGguc3RhcnRzd2l0aCgnL2FkbWluL3JlamVjdC8nKSBhbmQgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICB1c2VyX2lkID0gc2VsZi5wYXRoLnNwbGl0KCcvJylbLTFdCiAgICAgICAgICAgIHNlbGYucmVqZWN0X3VzZXIodXNlcl9pZCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wYXRoLnN0YXJ0c3dpdGgoJy9hZG1pbi9kZWxldGUvJykgYW5kIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgdXNlcl9pZCA9IHNlbGYucGF0aC5zcGxpdCgnLycpWy0xXQogICAgICAgICAgICBzZWxmLmRlbGV0ZV91c2VyKHVzZXJfaWQpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIHNlbGYucGF0aC5zdGFydHN3aXRoKCcvYWRtaW4vcmVzZXQtcGFzc3dvcmQvJykgYW5kIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgdXNlcl9pZCA9IHNlbGYucGF0aC5zcGxpdCgnLycpWy0xXQogICAgICAgICAgICBzZWxmLnJlc2V0X3VzZXJfcGFzc3dvcmQodXNlcl9pZCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wYXRoID09ICcvYWRtaW4vYWN0aXZlLXVzZXJzJyBhbmQgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICBzZWxmLnNlbmRfYWN0aXZlX3VzZXJzX3BhZ2UoKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBzZWxmLnBhdGggPT0gJy9hZG1pbi9zaGFyZWQtcGF0aHMnIGFuZCB1c2VyID09ICdhZG1pbic6CiAgICAgICAgICAgIHNlbGYuc2VuZF9zaGFyZWRfcGF0aHNfcGFnZSgpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIHNlbGYucGF0aC5zdGFydHN3aXRoKCcvYWRtaW4vc2hhcmUtcGF0aC8nKSBhbmQgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICAjIEV4dHJhY3QgcGF0aCBmcm9tIFVSTCwgaGFuZGxpbmcgYm90aCAvYWRtaW4vc2hhcmUtcGF0aC9QQVRIIGFuZCAvYWRtaW4vc2hhcmUtcGF0aC8/dG9rZW49Li4uCiAgICAgICAgICAgIHBhdGhfcGFydCA9IHNlbGYucGF0aFsxODpdICAjIFJlbW92ZSAnL2FkbWluL3NoYXJlLXBhdGgvJwogICAgICAgICAgICBmb3JjZV90eXBlID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgJz8nIGluIHBhdGhfcGFydDoKICAgICAgICAgICAgICAgIHBhdGhfdG9fc2hhcmUgPSB1cmxsaWIucGFyc2UudW5xdW90ZShwYXRoX3BhcnQuc3BsaXQoJz8nKVswXSkKICAgICAgICAgICAgICAgICMgQ2hlY2sgZm9yIHR5cGUgcGFyYW1ldGVyCiAgICAgICAgICAgICAgICBxdWVyeV9zdHJpbmcgPSBwYXRoX3BhcnQuc3BsaXQoJz8nKVsxXQogICAgICAgICAgICAgICAgcXVlcnlfcGFyYW1zID0gdXJsbGliLnBhcnNlLnBhcnNlX3FzKHF1ZXJ5X3N0cmluZykKICAgICAgICAgICAgICAgIGZvcmNlX3R5cGUgPSBxdWVyeV9wYXJhbXMuZ2V0KCd0eXBlJywgW05vbmVdKVswXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGF0aF90b19zaGFyZSA9IHVybGxpYi5wYXJzZS51bnF1b3RlKHBhdGhfcGFydCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHBhdGhfdG9fc2hhcmU6ICAjIE9ubHkgcHJvY2VlZCBpZiBwYXRoIGlzIG5vdCBlbXB0eQogICAgICAgICAgICAgICAgc2VsZi5hZGRfc2hhcmVkX3BhdGgocGF0aF90b19zaGFyZSwgZm9yY2VfdHlwZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgUmVkaXJlY3QgYmFjayB0byBzaGFyZWQgcGF0aHMgcGFnZSBpZiBubyBwYXRoIHByb3ZpZGVkCiAgICAgICAgICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgICAgICAgICAgZm9yIHRva2VuLCBkYXRhIGluIHNlbGYuVkFMSURfVE9LRU5TLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgaWYgZGF0YVsndXNlciddID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDMwMikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0xvY2F0aW9uJywgZicvYWRtaW4vc2hhcmVkLXBhdGhzP3Rva2VuPXtjdXJyZW50X3Rva2VufScpCiAgICAgICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wYXRoLnN0YXJ0c3dpdGgoJy9hZG1pbi91bnNoYXJlLXBhdGgvJykgYW5kIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgcGF0aF90b191bnNoYXJlID0gdXJsbGliLnBhcnNlLnVucXVvdGUoc2VsZi5wYXRoWzIwOl0pCiAgICAgICAgICAgIHNlbGYucmVtb3ZlX3NoYXJlZF9wYXRoKHBhdGhfdG9fdW5zaGFyZSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wYXRoID09ICcvYWRtaW4vcmF0ZS1saW1pdHMnIGFuZCB1c2VyID09ICdhZG1pbic6CiAgICAgICAgICAgIHNlbGYuc2VuZF9yYXRlX2xpbWl0c19wYWdlKCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCgogICAgICAgIAogICAgICAgICMgSGFuZGxlIGZhdmljb24gcmVxdWVzdHMgd2l0aG91dCBhdXRoZW50aWNhdGlvbgogICAgICAgIGlmIHNlbGYucGF0aCA9PSAnL2Zhdmljb24uaWNvJzoKICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwNCwgIk5vdCBmb3VuZCIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIG5vdCB1c2VyOgogICAgICAgICAgICBpZiBzZWxmLnBhdGggPT0gJy8nOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3dlbGNvbWVfcGFnZSgpCiAgICAgICAgICAgIGVsaWYgc2VsZi5wYXRoID09ICcvbG9naW4nOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2F1dGhfcGFnZSgpCiAgICAgICAgICAgIGVsaWYgc2VsZi5wYXRoID09ICcvcmVnaXN0ZXInOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3JlZ2lzdGVyX3BhZ2UoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwMSwgIkFjY2VzcyBkZW5pZWQiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICAjIEZpbGUgc2VydmluZyBsb2dpYyAoc2FtZSBhcyBiZWZvcmUpCiAgICAgICAgaWYgc2VsZi5wYXRoLnN0YXJ0c3dpdGgoJy9kb3dubG9hZC8nKToKICAgICAgICAgICAgZmlsZV9wYXRoID0gc2VsZi5wYXRoWzEwOl0KICAgICAgICAgICAgc2VsZi5zZXJ2ZV9kb3dubG9hZChmaWxlX3BhdGgpCiAgICAgICAgZWxpZiBzZWxmLnBhdGguc3RhcnRzd2l0aCgnL3Jhdy8nKToKICAgICAgICAgICAgZmlsZV9wYXRoID0gc2VsZi5wYXRoWzU6XQogICAgICAgICAgICBzZWxmLnNlcnZlX3JhdyhmaWxlX3BhdGgpCiAgICAgICAgZWxpZiBzZWxmLnBhdGggPT0gJy8nIG9yIHNlbGYucGF0aCA9PSAnJzoKICAgICAgICAgICAgc2VsZi5zaG93X2RpcmVjdG9yeSgnLycsIHVzZXIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGF0aCA9IHVybGxpYi5wYXJzZS51bnF1b3RlKHNlbGYucGF0aCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihwYXRoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dfZGlyZWN0b3J5KHBhdGgsIHVzZXIpCiAgICAgICAgICAgICAgICBlbGlmIG9zLnBhdGguaXNmaWxlKHBhdGgpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VydmVfZmlsZShwYXRoKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDA0LCAiRmlsZSBvciBkaXJlY3Rvcnkgbm90IGZvdW5kIikKICAgICAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBQZXJtaXNzaW9uRXJyb3IpOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwMywgIlBlcm1pc3Npb24gZGVuaWVkIikKICAgIAogICAgZGVmIHNlcnZlX2ZpbGUoc2VsZiwgZmlsZV9wYXRoKToKICAgICAgICAjIENoZWNrIGFjY2VzcyBmb3Igbm9uLWFkbWluIHVzZXJzCiAgICAgICAgdXNlciA9IE5vbmUKICAgICAgICBmb3IgdG9rZW4sIGRhdGEgaW4gc2VsZi5WQUxJRF9UT0tFTlMuaXRlbXMoKToKICAgICAgICAgICAgaWYgZGF0YVsndXNlciddIGluIFt1Wyd1c2VyJ10gZm9yIHUgaW4gc2VsZi5BQ1RJVkVfVVNFUlMudmFsdWVzKCldOgogICAgICAgICAgICAgICAgdXNlciA9IGRhdGFbJ3VzZXInXQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICBpZiB1c2VyICE9ICdhZG1pbicgYW5kIG5vdCBzZWxmLmlzX3BhdGhfYWNjZXNzaWJsZShvcy5wYXRoLmRpcm5hbWUoZmlsZV9wYXRoKSwgdXNlcik6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDMsICJBY2Nlc3MgZGVuaWVkIC0gVGhpcyBmaWxlIGlzIG5vdCBpbiBhIHNoYXJlZCBmb2xkZXIiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5wYXRoLmdldHNpemUoZmlsZV9wYXRoKSA9PSAwOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwMCwgIkNhbm5vdCB2aWV3IGVtcHR5IGZpbGUgKDAgYnl0ZXMpIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4dCA9IGZpbGVfcGF0aC5sb3dlcigpLnNwbGl0KCcuJylbLTFdCiAgICAgICAgICAgIGNvbnRlbnRfdHlwZXMgPSB7CiAgICAgICAgICAgICAgICAnaHRtbCc6ICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnLAogICAgICAgICAgICAgICAgJ2Nzcyc6ICd0ZXh0L2NzczsgY2hhcnNldD11dGYtOCcsCiAgICAgICAgICAgICAgICAnanNvbic6ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JywKICAgICAgICAgICAgICAgICd4bWwnOiAnYXBwbGljYXRpb24veG1sOyBjaGFyc2V0PXV0Zi04JywKICAgICAgICAgICAgICAgICdqcGcnOiAnaW1hZ2UvanBlZycsCiAgICAgICAgICAgICAgICAnanBlZyc6ICdpbWFnZS9qcGVnJywKICAgICAgICAgICAgICAgICdwbmcnOiAnaW1hZ2UvcG5nJywKICAgICAgICAgICAgICAgICdnaWYnOiAnaW1hZ2UvZ2lmJywKICAgICAgICAgICAgICAgICdzdmcnOiAnaW1hZ2Uvc3ZnK3htbCcsCiAgICAgICAgICAgICAgICAnaWNvJzogJ2ltYWdlL3gtaWNvbicsCiAgICAgICAgICAgICAgICAnYXZpZic6ICdpbWFnZS9hdmlmJywKICAgICAgICAgICAgICAgICd3ZWJwJzogJ2ltYWdlL3dlYnAnLAogICAgICAgICAgICAgICAgJ3BkZic6ICdhcHBsaWNhdGlvbi9wZGYnLAogICAgICAgICAgICAgICAgJ21wNCc6ICd2aWRlby9tcDQnLAogICAgICAgICAgICAgICAgJ3dlYm0nOiAndmlkZW8vd2VibScsCiAgICAgICAgICAgICAgICAnb2dnJzogJ3ZpZGVvL29nZycsCiAgICAgICAgICAgICAgICAnYXZpJzogJ3ZpZGVvL3gtbXN2aWRlbycsCiAgICAgICAgICAgICAgICAnbW92JzogJ3ZpZGVvL3F1aWNrdGltZScsCiAgICAgICAgICAgICAgICAnd212JzogJ3ZpZGVvL3gtbXMtd212JywKICAgICAgICAgICAgICAgICdmbHYnOiAndmlkZW8veC1mbHYnLAogICAgICAgICAgICAgICAgJ21rdic6ICd2aWRlby94LW1hdHJvc2thJywKICAgICAgICAgICAgICAgICdtcDMnOiAnYXVkaW8vbXBlZycsCiAgICAgICAgICAgICAgICAnd2F2JzogJ2F1ZGlvL3dhdicsCiAgICAgICAgICAgICAgICAnb2dnJzogJ2F1ZGlvL29nZycsCiAgICAgICAgICAgICAgICAnZmxhYyc6ICdhdWRpby9mbGFjJwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb250ZW50X3R5cGUgPSBjb250ZW50X3R5cGVzLmdldChleHQsICd0ZXh0L3BsYWluOyBjaGFyc2V0PXV0Zi04JykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSGFuZGxlIHJhbmdlIHJlcXVlc3RzIGZvciB2aWRlbyBzdHJlYW1pbmcKICAgICAgICAgICAgaWYgZXh0IGluIFsnbXA0JywgJ3dlYm0nLCAnb2dnJywgJ2F2aScsICdtb3YnLCAnd212JywgJ2ZsdicsICdta3YnLCAnbXAzJywgJ3dhdicsICdmbGFjJ106CiAgICAgICAgICAgICAgICBzZWxmLnNlcnZlX3ZpZGVvX3N0cmVhbShmaWxlX3BhdGgsIGNvbnRlbnRfdHlwZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyYicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCJDb250ZW50LXR5cGUiLCBjb250ZW50X3R5cGUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShmLnJlYWQoKSkKICAgICAgICBleGNlcHQgSU9FcnJvcjoKICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwNCwgIkZpbGUgbm90IGZvdW5kIikKICAgIAogICAgZGVmIHNlcnZlX3ZpZGVvX3N0cmVhbShzZWxmLCBmaWxlX3BhdGgsIGNvbnRlbnRfdHlwZSk6CiAgICAgICAgIiIiSGFuZGxlIG9wdGltaXplZCB2aWRlbyBzdHJlYW1pbmcgd2l0aCByYW5nZSByZXF1ZXN0cyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZmlsZV9zaXplID0gb3MucGF0aC5nZXRzaXplKGZpbGVfcGF0aCkKICAgICAgICAgICAgcmFuZ2VfaGVhZGVyID0gc2VsZi5oZWFkZXJzLmdldCgnUmFuZ2UnKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBPcHRpbWFsIGNodW5rIHNpemUgZm9yIHN0cmVhbWluZyAoMU1CKQogICAgICAgICAgICBDSFVOS19TSVpFID0gMTAyNCAqIDEwMjQKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJhbmdlX2hlYWRlcjoKICAgICAgICAgICAgICAgICMgUGFyc2UgcmFuZ2UgaGVhZGVyCiAgICAgICAgICAgICAgICByYW5nZV9tYXRjaCA9IHJhbmdlX2hlYWRlci5yZXBsYWNlKCdieXRlcz0nLCAnJykuc3BsaXQoJy0nKQogICAgICAgICAgICAgICAgc3RhcnQgPSBpbnQocmFuZ2VfbWF0Y2hbMF0pIGlmIHJhbmdlX21hdGNoWzBdIGVsc2UgMAogICAgICAgICAgICAgICAgZW5kID0gaW50KHJhbmdlX21hdGNoWzFdKSBpZiByYW5nZV9tYXRjaFsxXSBlbHNlIG1pbihzdGFydCArIENIVU5LX1NJWkUgLSAxLCBmaWxlX3NpemUgLSAxKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBzdGFydCA+PSBmaWxlX3NpemU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQxNiwgIlJhbmdlIG5vdCBzYXRpc2ZpYWJsZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVuZCA9IG1pbihlbmQsIGZpbGVfc2l6ZSAtIDEpCiAgICAgICAgICAgICAgICBjb250ZW50X2xlbmd0aCA9IGVuZCAtIHN0YXJ0ICsgMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjA2KSAgIyBQYXJ0aWFsIENvbnRlbnQKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtVHlwZScsIGNvbnRlbnRfdHlwZSkKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtTGVuZ3RoJywgc3RyKGNvbnRlbnRfbGVuZ3RoKSkKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtUmFuZ2UnLCBmJ2J5dGVzIHtzdGFydH0te2VuZH0ve2ZpbGVfc2l6ZX0nKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQWNjZXB0LVJhbmdlcycsICdieXRlcycpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ3B1YmxpYywgbWF4LWFnZT0zNjAwJykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0Nvbm5lY3Rpb24nLCAna2VlcC1hbGl2ZScpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdLZWVwLUFsaXZlJywgJ3RpbWVvdXQ9NSwgbWF4PTEwMCcpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJywgJ0dFVCwgSEVBRCwgT1BUSU9OUycpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ1JhbmdlJykKICAgICAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFN0cmVhbSBpbiBzbWFsbGVyIGNodW5rcyBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYuc2VlayhzdGFydCkKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmcgPSBjb250ZW50X2xlbmd0aAogICAgICAgICAgICAgICAgICAgIHdoaWxlIHJlbWFpbmluZyA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rX3NpemUgPSBtaW4oODE5MiwgcmVtYWluaW5nKSAgIyA4S0IgY2h1bmtzCiAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rID0gZi5yZWFkKGNodW5rX3NpemUpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBjaHVuazoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoY2h1bmspCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZyAtPSBsZW4oY2h1bmspCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE5vIHJhbmdlIHJlcXVlc3QsIHNlbmQgd2l0aCBjaHVua2VkIGVuY29kaW5nIGZvciBiZXR0ZXIgc3RyZWFtaW5nCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgY29udGVudF90eXBlKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1MZW5ndGgnLCBzdHIoZmlsZV9zaXplKSkKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0FjY2VwdC1SYW5nZXMnLCAnYnl0ZXMnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ2FjaGUtQ29udHJvbCcsICdwdWJsaWMsIG1heC1hZ2U9MzYwMCcpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDb25uZWN0aW9uJywgJ2tlZXAtYWxpdmUnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignS2VlcC1BbGl2ZScsICd0aW1lb3V0PTUsIG1heD0xMDAnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKQogICAgICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU3RyZWFtIGVudGlyZSBmaWxlIGluIGNodW5rcwogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgICAgICAgICBjaHVuayA9IGYucmVhZCg4MTkyKSAgIyA4S0IgY2h1bmtzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBjaHVuazoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoY2h1bmspCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBCcm9rZW5QaXBlRXJyb3IpOgogICAgICAgICAgICAjIENsaWVudCBkaXNjb25uZWN0ZWQsIHN0b3Agc3RyZWFtaW5nCiAgICAgICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNlcnZlX3JhdyhzZWxmLCBmaWxlX3BhdGgpOgogICAgICAgIGZpbGVfcGF0aCA9IHVybGxpYi5wYXJzZS51bnF1b3RlKGZpbGVfcGF0aCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9zLnBhdGguZ2V0c2l6ZShmaWxlX3BhdGgpID09IDA6CiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDAwLCAiQ2Fubm90IHZpZXcgZW1wdHkgZmlsZSAoMCBieXRlcykiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCJDb250ZW50LXR5cGUiLCAidGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCIpCiAgICAgICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoZi5yZWFkKCkpCiAgICAgICAgZXhjZXB0IElPRXJyb3I6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDQsICJGaWxlIG5vdCBmb3VuZCIpCiAgICAKICAgIGRlZiBzZXJ2ZV9kb3dubG9hZChzZWxmLCBmaWxlX3BhdGgpOgogICAgICAgIGZpbGVfcGF0aCA9IHVybGxpYi5wYXJzZS51bnF1b3RlKGZpbGVfcGF0aCkKICAgICAgICAKICAgICAgICAjIENoZWNrIGFjY2VzcyBmb3Igbm9uLWFkbWluIHVzZXJzCiAgICAgICAgdXNlciA9IE5vbmUKICAgICAgICBmb3IgdG9rZW4sIGRhdGEgaW4gc2VsZi5WQUxJRF9UT0tFTlMuaXRlbXMoKToKICAgICAgICAgICAgaWYgZGF0YVsndXNlciddIGluIFt1Wyd1c2VyJ10gZm9yIHUgaW4gc2VsZi5BQ1RJVkVfVVNFUlMudmFsdWVzKCldOgogICAgICAgICAgICAgICAgdXNlciA9IGRhdGFbJ3VzZXInXQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICBpZiB1c2VyICE9ICdhZG1pbicgYW5kIG5vdCBzZWxmLmlzX3BhdGhfYWNjZXNzaWJsZShvcy5wYXRoLmRpcm5hbWUoZmlsZV9wYXRoKSwgdXNlcik6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDMsICJBY2Nlc3MgZGVuaWVkIC0gVGhpcyBmaWxlIGlzIG5vdCBpbiBhIHNoYXJlZCBmb2xkZXIiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmaWxlX3NpemUgPSBvcy5wYXRoLmdldHNpemUoZmlsZV9wYXRoKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcigiQ29udGVudC10eXBlIiwgImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSIpCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoIkNvbnRlbnQtRGlzcG9zaXRpb24iLCBmJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPSJ7b3MucGF0aC5iYXNlbmFtZShmaWxlX3BhdGgpfSInKQogICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCJDb250ZW50LUxlbmd0aCIsIHN0cihmaWxlX3NpemUpKQogICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCJBY2NlcHQtUmFuZ2VzIiwgImJ5dGVzIikKICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcigiQ2FjaGUtQ29udHJvbCIsICJwdWJsaWMsIG1heC1hZ2U9MCIpCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoIkNvbm5lY3Rpb24iLCAia2VlcC1hbGl2ZSIpCiAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTdHJlYW0gZG93bmxvYWQgaW4gbGFyZ2UgY2h1bmtzIGZvciBzcGVlZAogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgICAgICBjaHVuayA9IGYucmVhZCg2NTUzNikgICMgNjRLQiBjaHVua3MgZm9yIGZhc3QgZG93bmxvYWRzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGNodW5rOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoY2h1bmspCiAgICAgICAgZXhjZXB0IChJT0Vycm9yLCBCcm9rZW5QaXBlRXJyb3IpOgogICAgICAgICAgICBwYXNzICAjIENsaWVudCBkaXNjb25uZWN0ZWQKICAgIAogICAgZGVmIHNob3dfZGlyZWN0b3J5KHNlbGYsIHBhdGgsIHVzZXIpOgogICAgICAgICMgQ2hlY2sgaWYgbm9uLWFkbWluIHVzZXIgaGFzIGFjY2VzcyB0byB0aGlzIHBhdGgKICAgICAgICBpZiB1c2VyICE9ICdhZG1pbicgYW5kIG5vdCBzZWxmLmlzX3BhdGhfYWNjZXNzaWJsZShwYXRoLCB1c2VyKToKICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDQwMywgIkFjY2VzcyBkZW5pZWQgLSBUaGlzIGZvbGRlciBpcyBub3Qgc2hhcmVkIHdpdGggeW91IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgZmlsZXMgPSBvcy5saXN0ZGlyKHBhdGgpCiAgICAgICAgICAgIGZpbGVzLnNvcnQoKQogICAgICAgIGV4Y2VwdCBQZXJtaXNzaW9uRXJyb3I6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDMsICJQZXJtaXNzaW9uIGRlbmllZCAtIGNhbm5vdCBhY2Nlc3MgdGhpcyBkaXJlY3RvcnkiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgT1NFcnJvciBhcyBlOgogICAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDA0LCBmIkNhbm5vdCBhY2Nlc3MgZGlyZWN0b3J5OiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgR2V0IGN1cnJlbnQgdG9rZW4KICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gdXNlcjoKICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRlbXBsYXRlX3BhdGggPSBzZWxmLmdldF90ZW1wbGF0ZV9wYXRoKCdkaXJlY3RvcnkuaHRtbCcpCiAgICAgICAgICAgIHdpdGggb3Blbih0ZW1wbGF0ZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGYucmVhZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEJ1aWxkIHBhcmVudCBsaW5rCiAgICAgICAgICAgIHBhcmVudF9saW5rID0gJycKICAgICAgICAgICAgaWYgcGF0aCAhPSAnLyc6CiAgICAgICAgICAgICAgICBwYXJlbnQgPSBvcy5wYXRoLmRpcm5hbWUocGF0aCkKICAgICAgICAgICAgICAgIGlmIHBhcmVudCA9PSAnJzoKICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSAnLycKICAgICAgICAgICAgICAgIHBhcmVudF9saW5rID0gZic8ZGl2IGNsYXNzPSJmaWxlIGRpciI+PGEgaHJlZj0ie3BhcmVudH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij7wn5OBIC4uPC9hPjwvZGl2PicKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQnVpbGQgZmlsZSBsaXN0IC0gZmlsdGVyIGZvciBub24tYWRtaW4gdXNlcnMKICAgICAgICAgICAgZmlsZV9saXN0ID0gJycKICAgICAgICAgICAgc2hhcmVkX3BhdGhzID0gc2VsZi5nZXRfc2hhcmVkX3BhdGhzKCkgICMgR2V0IGZvciBib3RoIGFkbWluIGFuZCBub24tYWRtaW4KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBuYW1lIGluIGZpbGVzOgogICAgICAgICAgICAgICAgZnVsbF9wYXRoID0gb3MucGF0aC5qb2luKHBhdGgsIG5hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRm9yIG5vbi1hZG1pbiB1c2Vycywgb25seSBzaG93IGl0ZW1zIHRoYXQgYXJlIGFjY2Vzc2libGUKICAgICAgICAgICAgICAgIGlmIHVzZXIgIT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5pc19wYXRoX2FjY2Vzc2libGUoZnVsbF9wYXRoLCB1c2VyKToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgICMgU2tpcCB0aGlzIGl0ZW0gZm9yIG5vbi1hZG1pbiB1c2VycwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihmdWxsX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICAjIENoZWNrIGlmIGRpcmVjdG9yeSBpcyBhY2Nlc3NpYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLmxpc3RkaXIoZnVsbF9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBEaXJlY3RvcnkgaXMgYWNjZXNzaWJsZSAtIHNob3cgYXMgY2xpY2thYmxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkX3BhdGggPSB1cmxsaWIucGFyc2UucXVvdGUoZnVsbF9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29weV9idXR0b24gPSAnJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlfYnV0dG9uID0gZicgfCA8YnV0dG9uIG9uY2xpY2s9ImNvcHlUb0NsaXBib2FyZChcJ3tmdWxsX3BhdGh9XCcpIiBzdHlsZT0iYmFja2dyb3VuZDogIzZjNzU3ZDsgY29sb3I6IHdoaXRlOyBib3JkZXI6IG5vbmU7IHBhZGRpbmc6IDJweCA2cHg7IGJvcmRlci1yYWRpdXM6IDNweDsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDExcHg7Ij7wn5OLIENvcHkgUGF0aDwvYnV0dG9uPicKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfbGlzdCArPSBmJzxkaXYgY2xhc3M9ImZpbGUgZGlyIj48YSBocmVmPSJ7ZW5jb2RlZF9wYXRofT90b2tlbj17Y3VycmVudF90b2tlbn0iPvCfk4Ege25hbWV9LzwvYT57Y29weV9idXR0b259PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIFBlcm1pc3Npb25FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIERpcmVjdG9yeSBub3QgYWNjZXNzaWJsZSAtIHNob3cgYXMgZGlzYWJsZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfbGlzdCArPSBmJzxkaXYgY2xhc3M9ImZpbGUgZGlyIiBzdHlsZT0ib3BhY2l0eTogMC41OyBjb2xvcjogIzk5OTsiPjxzcGFuIHN0eWxlPSJjdXJzb3I6IG5vdC1hbGxvd2VkOyI+8J+UkiB7bmFtZX0vIChObyBhY2Nlc3MpPC9zcGFuPjwvZGl2PicKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzaXplID0gb3MucGF0aC5nZXRzaXplKGZ1bGxfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZF9wYXRoID0gdXJsbGliLnBhcnNlLnF1b3RlKGZ1bGxfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgZXh0ID0gbmFtZS5sb3dlcigpLnNwbGl0KCcuJylbLTFdCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb3B5X2J1dHRvbiA9ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlX2J1dHRvbiA9ICcnCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVzZXIgPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgZmlsZSBpcyBhbHJlYWR5IHNoYXJlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfZmlsZV9zaGFyZWQgPSBmdWxsX3BhdGggaW4gc2hhcmVkX3BhdGhzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgaXNfZmlsZV9zaGFyZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZF9maWxlID0gdXJsbGliLnBhcnNlLnF1b3RlKGZ1bGxfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFyZV9idXR0b24gPSBmJyB8IDxidXR0b24gb25jbGljaz0iaWYoY29uZmlybShcJ1NoYXJlIHRoaXMgZmlsZToge25hbWV9P1wnKSl7e3dpbmRvdy5sb2NhdGlvbi5ocmVmPVwnL2FkbWluL3NoYXJlLXBhdGgve2VuY29kZWRfZmlsZX0/dG9rZW49e2N1cnJlbnRfdG9rZW59XCd9fSIgc3R5bGU9ImJhY2tncm91bmQ6ICMyOGE3NDU7IGNvbG9yOiB3aGl0ZTsgYm9yZGVyOiBub25lOyBwYWRkaW5nOiAycHggNnB4OyBib3JkZXItcmFkaXVzOiAzcHg7IGN1cnNvcjogcG9pbnRlcjsgZm9udC1zaXplOiAxMXB4OyI+8J+TpCBTaGFyZSBGaWxlPC9idXR0b24+JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkX2ZpbGUgPSB1cmxsaWIucGFyc2UucXVvdGUoZnVsbF9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXJlX2J1dHRvbiA9IGYnIHwgPGJ1dHRvbiBvbmNsaWNrPSJpZihjb25maXJtKFwnU3RvcCBzaGFyaW5nIHRoaXMgZmlsZToge25hbWV9P1wnKSl7e3dpbmRvdy5sb2NhdGlvbi5ocmVmPVwnL2FkbWluL3Vuc2hhcmUtcGF0aC97ZW5jb2RlZF9maWxlfT90b2tlbj17Y3VycmVudF90b2tlbn1cJ319IiBzdHlsZT0iYmFja2dyb3VuZDogI2ZkN2UxNDsgY29sb3I6IHdoaXRlOyBib3JkZXI6IG5vbmU7IHBhZGRpbmc6IDJweCA2cHg7IGJvcmRlci1yYWRpdXM6IDNweDsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDExcHg7Ij7wn5SSIFVuc2hhcmUgRmlsZTwvYnV0dG9uPicKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlfYnV0dG9uID0gZicgfCA8YnV0dG9uIG9uY2xpY2s9ImNvcHlUb0NsaXBib2FyZChcJ3tmdWxsX3BhdGh9XCcpIiBzdHlsZT0iYmFja2dyb3VuZDogIzZjNzU3ZDsgY29sb3I6IHdoaXRlOyBib3JkZXI6IG5vbmU7IHBhZGRpbmc6IDJweCA2cHg7IGJvcmRlci1yYWRpdXM6IDNweDsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDExcHg7Ij7wn5OLIENvcHkgUGF0aDwvYnV0dG9uPicKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNpemUgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgMC1ieXRlIGZpbGVzIC0gb25seSBhbGxvdyBkb3dubG9hZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ICs9IGYnPGRpdiBjbGFzcz0iZmlsZSIgc3R5bGU9Im9wYWNpdHk6IDAuNzsgY29sb3I6ICM2NjY7Ij7wn5OEIHtuYW1lfSAoMCBieXRlcykgLSA8c3BhbiBzdHlsZT0iY29sb3I6ICM5OTk7Ij5FbXB0eSBmaWxlPC9zcGFuPiB8IDxhIGhyZWY9Ii9kb3dubG9hZC97ZW5jb2RlZF9wYXRofT90b2tlbj17Y3VycmVudF90b2tlbn0iPkRvd25sb2FkPC9hPntjb3B5X2J1dHRvbn17c2hhcmVfYnV0dG9ufTwvZGl2PicKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlYWJsZV9maWxlcyA9IFsnaHRtbCcsICdodG0nLCAnY3NzJywgJ3N2ZycsICd4bWwnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fZmlsZXMgPSBbJ21wNCcsICd3ZWJtJywgJ29nZycsICdhdmknLCAnbW92JywgJ3dtdicsICdmbHYnLCAnbWt2J10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX2ZpbGVzID0gWydtcDMnLCAnd2F2JywgJ29nZycsICdmbGFjJ10KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZXh0IGluIHZpZGVvX2ZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfbGlzdCArPSBmJzxkaXYgY2xhc3M9ImZpbGUiPvCfjqwge25hbWV9ICh7c2VsZi5mb3JtYXRfc2l6ZShzaXplKX0pIC0gPGEgaHJlZj0ie2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5TdHJlYW08L2E+IHwgPGEgaHJlZj0iL2Rvd25sb2FkL3tlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+RG93bmxvYWQ8L2E+e2NvcHlfYnV0dG9ufXtzaGFyZV9idXR0b259PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBleHQgaW4gYXVkaW9fZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ICs9IGYnPGRpdiBjbGFzcz0iZmlsZSI+8J+OtSB7bmFtZX0gKHtzZWxmLmZvcm1hdF9zaXplKHNpemUpfSkgLSA8YSBocmVmPSJ7ZW5jb2RlZF9wYXRofT90b2tlbj17Y3VycmVudF90b2tlbn0iPlBsYXk8L2E+IHwgPGEgaHJlZj0iL2Rvd25sb2FkL3tlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+RG93bmxvYWQ8L2E+e2NvcHlfYnV0dG9ufXtzaGFyZV9idXR0b259PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBleHQgaW4gcGFyc2VhYmxlX2ZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfbGlzdCArPSBmJzxkaXYgY2xhc3M9ImZpbGUiPvCfk4Qge25hbWV9ICh7c2VsZi5mb3JtYXRfc2l6ZShzaXplKX0pIC0gPGEgaHJlZj0ie2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5WaWV3PC9hPiB8IDxhIGhyZWY9Ii9yYXcve2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5SYXc8L2E+IHwgPGEgaHJlZj0iL2Rvd25sb2FkL3tlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+RG93bmxvYWQ8L2E+e2NvcHlfYnV0dG9ufXtzaGFyZV9idXR0b259PC9kaXY+JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2xpc3QgKz0gZic8ZGl2IGNsYXNzPSJmaWxlIj7wn5OEIHtuYW1lfSAoe3NlbGYuZm9ybWF0X3NpemUoc2l6ZSl9KSAtIDxhIGhyZWY9IntlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+VmlldzwvYT4gfCA8YSBocmVmPSIvZG93bmxvYWQve2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5Eb3dubG9hZDwvYT57Y29weV9idXR0b259e3NoYXJlX2J1dHRvbn08L2Rpdj4nCiAgICAgICAgICAgICAgICBleGNlcHQgKE9TRXJyb3IsIFBlcm1pc3Npb25FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ICs9IGYnPGRpdiBjbGFzcz0iZmlsZSIgc3R5bGU9Im9wYWNpdHk6IDAuNTsgY29sb3I6ICM5OTk7Ij7inYwge25hbWV9IChQZXJtaXNzaW9uIGRlbmllZCk8L2Rpdj4nCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEZvciBub24tYWRtaW4gdXNlcnMgaW4gcm9vdCBkaXJlY3RvcnksIHNob3cgc2hhcmVkIGZvbGRlcnMgYXMgdmlydHVhbCBsaW5rcwogICAgICAgICAgICBpZiB1c2VyICE9ICdhZG1pbicgYW5kIHBhdGggPT0gJy8nIGFuZCBub3QgZmlsZV9saXN0OgogICAgICAgICAgICAgICAgIyBTaG93IHNoYXJlZCBmb2xkZXJzIGFzIGFjY2Vzc2libGUgbGlua3MKICAgICAgICAgICAgICAgIGZvciBzaGFyZWRfcGF0aCwgaXNfZmlsZSBpbiBzaGFyZWRfcGF0aHMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaXNfZmlsZTogICMgT25seSBzaG93IGZvbGRlcnMgaW4gcm9vdAogICAgICAgICAgICAgICAgICAgICAgICBmb2xkZXJfbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUoc2hhcmVkX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWRfcGF0aCA9IHVybGxpYi5wYXJzZS5xdW90ZShzaGFyZWRfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ICs9IGYnPGRpdiBjbGFzcz0iZmlsZSBkaXIiPjxhIGhyZWY9IntlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+8J+TgSB7Zm9sZGVyX25hbWV9LyAoU2hhcmVkKTwvYT48L2Rpdj4nCiAgICAgICAgICAgICAgICAgICAgZWxzZTogICMgU2hvdyBpbmRpdmlkdWFsIHNoYXJlZCBmaWxlcwogICAgICAgICAgICAgICAgICAgICAgICBmaWxlX25hbWUgPSBvcy5wYXRoLmJhc2VuYW1lKHNoYXJlZF9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBlbmNvZGVkX3BhdGggPSB1cmxsaWIucGFyc2UucXVvdGUoc2hhcmVkX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfc2l6ZSA9IG9zLnBhdGguZ2V0c2l6ZShzaGFyZWRfcGF0aCkgaWYgb3MucGF0aC5leGlzdHMoc2hhcmVkX3BhdGgpIGVsc2UgMAogICAgICAgICAgICAgICAgICAgICAgICBleHQgPSBmaWxlX25hbWUubG93ZXIoKS5zcGxpdCgnLicpWy0xXSBpZiAnLicgaW4gZmlsZV9uYW1lIGVsc2UgJycKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGV4dCBpbiBbJ21wNCcsICd3ZWJtJywgJ29nZycsICdhdmknLCAnbW92JywgJ3dtdicsICdmbHYnLCAnbWt2J106CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2xpc3QgKz0gZic8ZGl2IGNsYXNzPSJmaWxlIj7wn46sIHtmaWxlX25hbWV9ICh7c2VsZi5mb3JtYXRfc2l6ZShmaWxlX3NpemUpfSkgLSA8YSBocmVmPSJ7ZW5jb2RlZF9wYXRofT90b2tlbj17Y3VycmVudF90b2tlbn0iPlN0cmVhbTwvYT4gfCA8YSBocmVmPSIvZG93bmxvYWQve2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5Eb3dubG9hZDwvYT48L2Rpdj4nCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgZXh0IGluIFsnbXAzJywgJ3dhdicsICdvZ2cnLCAnZmxhYyddOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ICs9IGYnPGRpdiBjbGFzcz0iZmlsZSI+8J+OtSB7ZmlsZV9uYW1lfSAoe3NlbGYuZm9ybWF0X3NpemUoZmlsZV9zaXplKX0pIC0gPGEgaHJlZj0ie2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5QbGF5PC9hPiB8IDxhIGhyZWY9Ii9kb3dubG9hZC97ZW5jb2RlZF9wYXRofT90b2tlbj17Y3VycmVudF90b2tlbn0iPkRvd25sb2FkPC9hPjwvZGl2PicKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfbGlzdCArPSBmJzxkaXYgY2xhc3M9ImZpbGUiPvCfk4Qge2ZpbGVfbmFtZX0gKHtzZWxmLmZvcm1hdF9zaXplKGZpbGVfc2l6ZSl9KSAtIDxhIGhyZWY9IntlbmNvZGVkX3BhdGh9P3Rva2VuPXtjdXJyZW50X3Rva2VufSI+VmlldzwvYT4gfCA8YSBocmVmPSIvZG93bmxvYWQve2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij5Eb3dubG9hZDwvYT48L2Rpdj4nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBmaWxlX2xpc3Q6CiAgICAgICAgICAgICAgICAgICAgZmlsZV9saXN0ID0gJzxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogNDBweDsgY29sb3I6ICM2NjY7Ij7wn5SSIE5vIHNoYXJlZCBjb250ZW50IGF2YWlsYWJsZTxicj48c21hbGw+Q29udGFjdCBhZG1pbiB0byBzaGFyZSBmb2xkZXJzIG9yIGZpbGVzIHdpdGggeW91PC9zbWFsbD48L2Rpdj4nCiAgICAgICAgICAgIGVsaWYgbm90IGZpbGVfbGlzdCBhbmQgdXNlciAhPSAnYWRtaW4nOgogICAgICAgICAgICAgICAgZmlsZV9saXN0ID0gJzxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogNDBweDsgY29sb3I6ICM2NjY7Ij7wn5SSIE5vIHNoYXJlZCBjb250ZW50IGF2YWlsYWJsZTxicj48c21hbGw+Q29udGFjdCBhZG1pbiB0byBzaGFyZSBmb2xkZXJzIG9yIGZpbGVzIHdpdGggeW91PC9zbWFsbD48L2Rpdj4nCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFkZCBhZG1pbiBwYW5lbCBhbmQgbG9nb3V0IGxpbmsKICAgICAgICAgICAgaGVhZGVyX2NvbnRlbnQgPSAnJwogICAgICAgICAgICBpZiB1c2VyID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIGN1cnJlbnQgcGF0aCBpcyBzaGFyZWQgYXMgYSBmb2xkZXIgKG5vdCBhIGZpbGUpCiAgICAgICAgICAgICAgICBpc19zaGFyZWQgPSBwYXRoIGluIHNoYXJlZF9wYXRocyBhbmQgbm90IHNoYXJlZF9wYXRocy5nZXQocGF0aCwgRmFsc2UpCiAgICAgICAgICAgICAgICBzaGFyZV9idXR0b24gPSAnJwogICAgICAgICAgICAgICAgaWYgbm90IGlzX3NoYXJlZCBhbmQgcGF0aCAhPSAnLyc6CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZF9jdXJyZW50X3BhdGggPSB1cmxsaWIucGFyc2UucXVvdGUocGF0aCkKICAgICAgICAgICAgICAgICAgICBzaGFyZV9idXR0b24gPSBmJzxhIGhyZWY9Ii9hZG1pbi9zaGFyZS1wYXRoL3tlbmNvZGVkX2N1cnJlbnRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iYmFja2dyb3VuZDogIzI4YTc0NTsgY29sb3I6IHdoaXRlOyBwYWRkaW5nOiA1cHggMTBweDsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMTJweDsgbWFyZ2luLWxlZnQ6IDVweDsiIG9uY2xpY2s9InJldHVybiBjb25maXJtKFwnU2hhcmUgZm9sZGVyIHtwYXRofSB3aXRoIGFsbCB1c2Vycz9cJykiPvCfk6QgU2hhcmUgVGhpcyBGb2xkZXI8L2E+JwogICAgICAgICAgICAgICAgZWxpZiBpc19zaGFyZWQgYW5kIHBhdGggIT0gJy8nOgogICAgICAgICAgICAgICAgICAgIGVuY29kZWRfY3VycmVudF9wYXRoID0gdXJsbGliLnBhcnNlLnF1b3RlKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgc2hhcmVfYnV0dG9uID0gZic8YSBocmVmPSIvYWRtaW4vdW5zaGFyZS1wYXRoL3tlbmNvZGVkX2N1cnJlbnRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iYmFja2dyb3VuZDogI2ZkN2UxNDsgY29sb3I6IHdoaXRlOyBwYWRkaW5nOiA1cHggMTBweDsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMTJweDsgbWFyZ2luLWxlZnQ6IDVweDsiIG9uY2xpY2s9InJldHVybiBjb25maXJtKFwnU3RvcCBzaGFyaW5nIGZvbGRlciB7cGF0aH0/XCcpIj7wn5SSIFVuc2hhcmUgVGhpcyBGb2xkZXI8L2E+JwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBoZWFkZXJfY29udGVudCA9IGYnPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczogY2VudGVyOyBtYXJnaW4tYm90dG9tOiAxNXB4OyI+PGRpdj48YSBocmVmPSIvYWRtaW4/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iYmFja2dyb3VuZDogI2RjMzU0NTsgY29sb3I6IHdoaXRlOyBwYWRkaW5nOiA1cHggMTBweDsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiAzcHg7IGZvbnQtc2l6ZTogMTJweDsiPkFkbWluIFBhbmVsPC9hPntzaGFyZV9idXR0b259PC9kaXY+PGEgaHJlZj0iL2xvZ2luIiBzdHlsZT0iY29sb3I6ICM2NjY7Ij5Mb2dvdXQgKHt1c2VyfSk8L2E+PC9kaXY+JwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaGVhZGVyX2NvbnRlbnQgPSBmJzxkaXYgc3R5bGU9InRleHQtYWxpZ246IHJpZ2h0OyBtYXJnaW4tYm90dG9tOiAxMHB4OyI+PGEgaHJlZj0iL2xvZ2luIiBzdHlsZT0iY29sb3I6ICM2NjY7Ij5Mb2dvdXQgKHt1c2VyfSk8L2E+PC9kaXY+JwogICAgICAgICAgICAKICAgICAgICAgICAgIyBBZGQgY3VycmVudCBwYXRoIGNvcHkgYnV0dG9uIGZvciBhZG1pbgogICAgICAgICAgICBwYXRoX2hlYWRlciA9IGYie2hlYWRlcl9jb250ZW50fTxzdHJvbmc+RmlsZXMgaW46IHtwYXRofTwvc3Ryb25nPiIKICAgICAgICAgICAgaWYgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgcGF0aF9oZWFkZXIgKz0gZicgPGJ1dHRvbiBvbmNsaWNrPSJjb3B5VG9DbGlwYm9hcmQoXCd7cGF0aH1cJykiIHN0eWxlPSJiYWNrZ3JvdW5kOiAjMTdhMmI4OyBjb2xvcjogd2hpdGU7IGJvcmRlcjogbm9uZTsgcGFkZGluZzogNXB4IDEwcHg7IGJvcmRlci1yYWRpdXM6IDNweDsgY3Vyc29yOiBwb2ludGVyOyBmb250LXNpemU6IDEycHg7IG1hcmdpbi1sZWZ0OiAxMHB4OyI+8J+TiyBDb3B5IEN1cnJlbnQgUGF0aDwvYnV0dG9uPicKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVwbGFjZSBwbGFjZWhvbGRlcnMKICAgICAgICAgICAgaHRtbCA9IHRlbXBsYXRlLnJlcGxhY2UoJ3twYXRofScsIHBhdGhfaGVhZGVyKQogICAgICAgICAgICBodG1sID0gaHRtbC5yZXBsYWNlKCd7cGFyZW50X2xpbmt9JywgcGFyZW50X2xpbmspCiAgICAgICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UoJ3tmaWxlX2xpc3R9JywgZmlsZV9saXN0KQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcigiQ29udGVudC10eXBlIiwgInRleHQvaHRtbDsgY2hhcnNldD11dGYtOCIpCiAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKGh0bWwuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgc2VsZi5zZW5kX2Vycm9yKDUwMCwgIlRlbXBsYXRlIGZpbGUgbm90IGZvdW5kIikKICAgIAogICAgZGVmIHNlbmRfYWRtaW5fcGFnZShzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRlbXBsYXRlX3BhdGggPSBzZWxmLmdldF90ZW1wbGF0ZV9wYXRoKCdhZG1pbi5odG1sJykKICAgICAgICAgICAgd2l0aCBvcGVuKHRlbXBsYXRlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gZi5yZWFkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5EQl9GSUxFKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCdTRUxFQ1QgaWQsIHVzZXJuYW1lLCBpc19hcHByb3ZlZCwgY3JlYXRlZF9hdCBGUk9NIHVzZXJzIE9SREVSIEJZIGlzX2FwcHJvdmVkIERFU0MsIGNyZWF0ZWRfYXQgREVTQycpCiAgICAgICAgICAgIHVzZXJzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdldCBjdXJyZW50IHRva2VuIGZvciBhZG1pbiBhY3Rpb25zCiAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSBOb25lCiAgICAgICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgZGF0YVsndXNlciddID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IHRva2VuCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2VwYXJhdGUgYXBwcm92ZWQgYW5kIHBlbmRpbmcgdXNlcnMKICAgICAgICAgICAgYXBwcm92ZWRfdXNlcnMgPSBbXQogICAgICAgICAgICBwZW5kaW5nX3VzZXJzID0gW10KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB1c2VyX2lkLCB1c2VybmFtZSwgaXNfYXBwcm92ZWQsIGNyZWF0ZWRfYXQgaW4gdXNlcnM6CiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBpc19hcHByb3ZlZDoKICAgICAgICAgICAgICAgICAgICBhcHByb3ZlZF91c2Vycy5hcHBlbmQoKHVzZXJfaWQsIHVzZXJuYW1lLCBjcmVhdGVkX2F0KSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcGVuZGluZ191c2Vycy5hcHBlbmQoKHVzZXJfaWQsIHVzZXJuYW1lLCBjcmVhdGVkX2F0KSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHVzZXJfbGlzdCA9ICcnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFwcHJvdmVkIFVzZXJzIFNlY3Rpb24KICAgICAgICAgICAgaWYgYXBwcm92ZWRfdXNlcnM6CiAgICAgICAgICAgICAgICB1c2VyX2xpc3QgKz0gJzxoMyBzdHlsZT0iY29sb3I6ICMyOGE3NDU7IG1hcmdpbi10b3A6IDIwcHg7Ij7inIUgQXBwcm92ZWQgVXNlcnM8L2gzPicKICAgICAgICAgICAgICAgIGZvciB1c2VyX2lkLCB1c2VybmFtZSwgY3JlYXRlZF9hdCBpbiBhcHByb3ZlZF91c2VyczoKICAgICAgICAgICAgICAgICAgICB1c2VyX2xpc3QgKz0gZicnJwogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InVzZXIgYXBwcm92ZWQiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHN0cm9uZz57dXNlcm5hbWV9PC9zdHJvbmc+PGJyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNtYWxsPkpvaW5lZDoge2NyZWF0ZWRfYXR9PC9zbWFsbD48YnI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBzdHlsZT0iY29sb3I6ICMyOGE3NDU7Ij7inIUgQWN0aXZlIFVzZXI8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iL2FkbWluL3Jlc2V0LXBhc3N3b3JkL3t1c2VyX2lkfT90b2tlbj17Y3VycmVudF90b2tlbn0iIGNsYXNzPSJidG4iIHN0eWxlPSJiYWNrZ3JvdW5kOiAjZmZjMTA3OyBjb2xvcjogIzAwMDsgbWFyZ2luOiAycHg7Ij5SZXNldCBQYXNzd29yZDwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9Ii9hZG1pbi9yZWplY3Qve3VzZXJfaWR9P3Rva2VuPXtjdXJyZW50X3Rva2VufSIgY2xhc3M9ImJ0biIgc3R5bGU9ImJhY2tncm91bmQ6ICNmZDdlMTQ7IG1hcmdpbjogMnB4OyI+U3VzcGVuZDwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9Ii9hZG1pbi9kZWxldGUve3VzZXJfaWR9P3Rva2VuPXtjdXJyZW50X3Rva2VufSIgY2xhc3M9ImJ0biBidG4tZGFuZ2VyIiBvbmNsaWNrPSJyZXR1cm4gY29uZmlybSgnRGVsZXRlIHVzZXIge3VzZXJuYW1lfT8gVGhpcyBjYW5ub3QgYmUgdW5kb25lIScpIj5EZWxldGU8L2E+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAKICAgICAgICAgICAgIyBQZW5kaW5nIFVzZXJzIFNlY3Rpb24KICAgICAgICAgICAgaWYgcGVuZGluZ191c2VyczoKICAgICAgICAgICAgICAgIHVzZXJfbGlzdCArPSAnPGgzIHN0eWxlPSJjb2xvcjogI2RjMzU0NTsgbWFyZ2luLXRvcDogMzBweDsiPuKPsyBQZW5kaW5nIEFwcHJvdmFsPC9oMz4nCiAgICAgICAgICAgICAgICBmb3IgdXNlcl9pZCwgdXNlcm5hbWUsIGNyZWF0ZWRfYXQgaW4gcGVuZGluZ191c2VyczoKICAgICAgICAgICAgICAgICAgICB1c2VyX2xpc3QgKz0gZicnJwogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InVzZXIgcGVuZGluZyI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3Ryb25nPnt1c2VybmFtZX08L3N0cm9uZz48YnI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c21hbGw+UmVxdWVzdGVkOiB7Y3JlYXRlZF9hdH08L3NtYWxsPjxicj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIHN0eWxlPSJjb2xvcjogI2RjMzU0NTsiPuKPsyBXYWl0aW5nIGZvciBhcHByb3ZhbDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIvYWRtaW4vYXBwcm92ZS97dXNlcl9pZH0/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIj5BcHByb3ZlPC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iL2FkbWluL2RlbGV0ZS97dXNlcl9pZH0/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBjbGFzcz0iYnRuIGJ0bi1kYW5nZXIiIG9uY2xpY2s9InJldHVybiBjb25maXJtKCdEZWxldGUgdXNlciB7dXNlcm5hbWV9PyBUaGlzIGNhbm5vdCBiZSB1bmRvbmUhJykiPkRlbGV0ZTwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYXBwcm92ZWRfdXNlcnMgYW5kIG5vdCBwZW5kaW5nX3VzZXJzOgogICAgICAgICAgICAgICAgdXNlcl9saXN0ID0gJzxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogNDBweDsgY29sb3I6ICM2NjY7Ij5ObyB1c2VycyByZWdpc3RlcmVkIHlldDwvZGl2PicKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQWRkIG5vdGlmaWNhdGlvbnMKICAgICAgICAgICAgbm90aWZpY2F0aW9ucyA9ICcnCiAgICAgICAgICAgIGlmIEF1dGhGaWxlSGFuZGxlci5BRE1JTl9OT1RJRklDQVRJT05TOgogICAgICAgICAgICAgICAgbm90aWZpY2F0aW9ucyA9ICc8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZmZmM2NkOyBib3JkZXI6IDFweCBzb2xpZCAjZmZlYWE3OyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4nCiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25zICs9ICc8aDMgc3R5bGU9ImNvbG9yOiAjODU2NDA0OyI+8J+UlCBSZWNlbnQgQWN0aW9uczwvaDM+JwogICAgICAgICAgICAgICAgZm9yIG5vdGlmaWNhdGlvbiBpbiBBdXRoRmlsZUhhbmRsZXIuQURNSU5fTk9USUZJQ0FUSU9OU1stNTpdOiAgIyBTaG93IGxhc3QgNQogICAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbnMgKz0gZic8cCBzdHlsZT0ibWFyZ2luOiA1cHggMDsgY29sb3I6ICM4NTY0MDQ7Ij7igKIge25vdGlmaWNhdGlvbn08L3A+JwogICAgICAgICAgICAgICAgbm90aWZpY2F0aW9ucyArPSAnPGJ1dHRvbiBvbmNsaWNrPSJ0aGlzLnBhcmVudEVsZW1lbnQuc3R5bGUuZGlzcGxheT1cJ25vbmVcJyIgc3R5bGU9ImJhY2tncm91bmQ6ICNmZmMxMDc7IGJvcmRlcjogbm9uZTsgcGFkZGluZzogNXB4IDEwcHg7IGJvcmRlci1yYWRpdXM6IDNweDsgY3Vyc29yOiBwb2ludGVyOyI+Q2xlYXI8L2J1dHRvbj4nCiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25zICs9ICc8L2Rpdj4nCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEFkZCBzdW1tYXJ5IHN0YXRzCiAgICAgICAgICAgIHN0YXRzID0gZicnJwogICAgICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZTllY2VmOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij4KICAgICAgICAgICAgICAgIDxoMz5Vc2VyIFN0YXRpc3RpY3M8L2gzPgogICAgICAgICAgICAgICAgPHA+PHN0cm9uZz5Ub3RhbCBVc2Vyczo8L3N0cm9uZz4ge2xlbihhcHByb3ZlZF91c2VycykgKyBsZW4ocGVuZGluZ191c2Vycyl9PC9wPgogICAgICAgICAgICAgICAgPHA+PHN0cm9uZz5BcHByb3ZlZDo8L3N0cm9uZz4gPHNwYW4gc3R5bGU9ImNvbG9yOiAjMjhhNzQ1OyI+e2xlbihhcHByb3ZlZF91c2Vycyl9PC9zcGFuPjwvcD4KICAgICAgICAgICAgICAgIDxwPjxzdHJvbmc+UGVuZGluZzo8L3N0cm9uZz4gPHNwYW4gc3R5bGU9ImNvbG9yOiAjZGMzNTQ1OyI+e2xlbihwZW5kaW5nX3VzZXJzKX08L3NwYW4+PC9wPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHVzZXJfbGlzdCA9IG5vdGlmaWNhdGlvbnMgKyBzdGF0cyArIHVzZXJfbGlzdAogICAgICAgICAgICAKICAgICAgICAgICAgIyBBZGQgYWRtaW4gbmF2aWdhdGlvbgogICAgICAgICAgICBhZG1pbl9uYXYgPSBmJycnCiAgICAgICAgICAgIDxkaXYgc3R5bGU9ImJhY2tncm91bmQ6ICNlOWVjZWY7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDhweDsgbWFyZ2luLWJvdHRvbTogMjBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgICAgICAgICA8aDM+QWRtaW4gVG9vbHM8L2gzPgogICAgICAgICAgICAgICAgPGEgaHJlZj0iLz90b2tlbj17Y3VycmVudF90b2tlbn0iIHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHBhZGRpbmc6IDEwcHggMjBweDsgbWFyZ2luOiA1cHg7IGJhY2tncm91bmQ6ICM2ZjQyYzE7IGNvbG9yOiB3aGl0ZTsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiA1cHg7Ij7wn5OCIEJyb3dzZSBGaWxlczwvYT4KICAgICAgICAgICAgICAgIDxhIGhyZWY9Ii9hZG1pbi9hY3RpdmUtdXNlcnM/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBwYWRkaW5nOiAxMHB4IDIwcHg7IG1hcmdpbjogNXB4OyBiYWNrZ3JvdW5kOiAjMTdhMmI4OyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNXB4OyI+8J+RpSBWaWV3IEFjdGl2ZSBVc2VyczwvYT4KICAgICAgICAgICAgICAgIDxhIGhyZWY9Ii9hZG1pbi9zaGFyZWQtcGF0aHM/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBwYWRkaW5nOiAxMHB4IDIwcHg7IG1hcmdpbjogNXB4OyBiYWNrZ3JvdW5kOiAjMjhhNzQ1OyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNXB4OyI+8J+TgSBNYW5hZ2UgU2hhcmVkIEZvbGRlcnM8L2E+CiAgICAgICAgICAgICAgICA8YSBocmVmPSIvYWRtaW4vcmF0ZS1saW1pdHM/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBwYWRkaW5nOiAxMHB4IDIwcHg7IG1hcmdpbjogNXB4OyBiYWNrZ3JvdW5kOiAjZGMzNTQ1OyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNXB4OyI+8J+aqyBNYW5hZ2UgUmF0ZSBMaW1pdHM8L2E+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAnJycKICAgICAgICAgICAgCiAgICAgICAgICAgIGh0bWwgPSB0ZW1wbGF0ZS5yZXBsYWNlKCd7dXNlcl9saXN0fScsIGFkbWluX25hdiArIHVzZXJfbGlzdCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtdHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShodG1sLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsICJUZW1wbGF0ZSBmaWxlIG5vdCBmb3VuZCIpCiAgICAKICAgIGRlZiBhcHByb3ZlX3VzZXIoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLkRCX0ZJTEUpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCdVUERBVEUgdXNlcnMgU0VUIGlzX2FwcHJvdmVkID0gMSBXSEVSRSBpZCA9ID8nLCAodXNlcl9pZCwpKQogICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAKICAgICAgICAjIEdldCBjdXJyZW50IHRva2VuIGZvciByZWRpcmVjdAogICAgICAgIGN1cnJlbnRfdG9rZW4gPSBOb25lCiAgICAgICAgZm9yIHRva2VuLCBkYXRhIGluIHNlbGYuVkFMSURfVE9LRU5TLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGRhdGFbJ3VzZXInXSA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IHRva2VuCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgzMDIpCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignTG9jYXRpb24nLCBmJy9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0nKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgCiAgICBkZWYgcmVqZWN0X3VzZXIoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLkRCX0ZJTEUpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCdVUERBVEUgdXNlcnMgU0VUIGlzX2FwcHJvdmVkID0gMCBXSEVSRSBpZCA9ID8nLCAodXNlcl9pZCwpKQogICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAKICAgICAgICAjIEdldCBjdXJyZW50IHRva2VuIGZvciByZWRpcmVjdAogICAgICAgIGN1cnJlbnRfdG9rZW4gPSBOb25lCiAgICAgICAgZm9yIHRva2VuLCBkYXRhIGluIHNlbGYuVkFMSURfVE9LRU5TLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGRhdGFbJ3VzZXInXSA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IHRva2VuCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgzMDIpCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignTG9jYXRpb24nLCBmJy9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0nKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgCiAgICBkZWYgZGVsZXRlX3VzZXIoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLkRCX0ZJTEUpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICMgR2V0IHVzZXJuYW1lIGJlZm9yZSBkZWxldGluZyBmb3IgbG9nZ2luZwogICAgICAgIGN1cnNvci5leGVjdXRlKCdTRUxFQ1QgdXNlcm5hbWUgRlJPTSB1c2VycyBXSEVSRSBpZCA9ID8nLCAodXNlcl9pZCwpKQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgaWYgcmVzdWx0OgogICAgICAgICAgICB1c2VybmFtZSA9IHJlc3VsdFswXQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnREVMRVRFIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/IEFORCB1c2VybmFtZSAhPSAiYWRtaW4iJywgKHVzZXJfaWQsKSkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICBwcmludChmIkFkbWluIGRlbGV0ZWQgdXNlcjoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEludmFsaWRhdGUgYWxsIHRva2VucyBhbmQgYWN0aXZlIHNlc3Npb25zIGZvciB0aGUgZGVsZXRlZCB1c2VyCiAgICAgICAgICAgIHRva2Vuc190b19yZW1vdmUgPSBbXQogICAgICAgICAgICBmb3IgdG9rZW4sIGRhdGEgaW4gc2VsZi5WQUxJRF9UT0tFTlMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGRhdGFbJ3VzZXInXSA9PSB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICB0b2tlbnNfdG9fcmVtb3ZlLmFwcGVuZCh0b2tlbikKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB0b2tlbiBpbiB0b2tlbnNfdG9fcmVtb3ZlOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuVkFMSURfVE9LRU5TW3Rva2VuXQogICAgICAgICAgICAgICAgaWYgdG9rZW4gaW4gc2VsZi5BQ1RJVkVfVVNFUlM6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuQUNUSVZFX1VTRVJTW3Rva2VuXQogICAgICAgICAgICAgICAgcHJpbnQoZiJJbnZhbGlkYXRlZCB0b2tlbiBmb3IgZGVsZXRlZCB1c2VyOiB7dXNlcm5hbWV9IikKICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAKICAgICAgICAjIEdldCBjdXJyZW50IHRva2VuIGZvciByZWRpcmVjdAogICAgICAgIGN1cnJlbnRfdG9rZW4gPSBOb25lCiAgICAgICAgZm9yIHRva2VuLCBkYXRhIGluIHNlbGYuVkFMSURfVE9LRU5TLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGRhdGFbJ3VzZXInXSA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IHRva2VuCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgzMDIpCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignTG9jYXRpb24nLCBmJy9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0nKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgCiAgICBkZWYgcmVzZXRfdXNlcl9wYXNzd29yZChzZWxmLCB1c2VyX2lkKToKICAgICAgICBpbXBvcnQgdXVpZAogICAgICAgIG5ld19wYXNzd29yZCA9IHN0cih1dWlkLnV1aWQ0KCkpWzo4XSAgIyA4IGNoYXJhY3RlciBwYXNzd29yZAogICAgICAgIHNhbHQgPSBzZWNyZXRzLnRva2VuX2hleCgxNikKICAgICAgICBwYXNzd29yZF9oYXNoID0gaGFzaGxpYi5wYmtkZjJfaG1hYygnc2hhMjU2JywgbmV3X3Bhc3N3b3JkLmVuY29kZSgpLCBzYWx0LmVuY29kZSgpLCAxMDAwMDApCiAgICAgICAgCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLkRCX0ZJTEUpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIHRyeToKICAgICAgICAgICAgIyBHZXQgdXNlcm5hbWUgYW5kIHVwZGF0ZSBwYXNzd29yZAogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnU0VMRUNUIHVzZXJuYW1lIEZST00gdXNlcnMgV0hFUkUgaWQgPSA/JywgKHVzZXJfaWQsKSkKICAgICAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgaWYgcmVzdWx0OgogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSByZXN1bHRbMF0KICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIkNhbm5vdCByZXNldCBhZG1pbiBwYXNzd29yZCIpCiAgICAgICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVHJ5IHRvIHVwZGF0ZSB3aXRoIHBhc3N3b3JkX3BsYWluIGNvbHVtbiBmaXJzdAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCdVUERBVEUgdXNlcnMgU0VUIHBhc3N3b3JkX2hhc2ggPSA/LCBzYWx0ID0gPywgcGFzc3dvcmRfcGxhaW4gPSA/IFdIRVJFIGlkID0gPycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXNzd29yZF9oYXNoLmhleCgpLCBzYWx0LCBuZXdfcGFzc3dvcmQsIHVzZXJfaWQpKQogICAgICAgICAgICAgICAgICAgIHByaW50KGYi4pyFIEFkbWluIHJlc2V0IHBhc3N3b3JkIGZvciB1c2VyOiB7dXNlcm5hbWV9IC0+IHtuZXdfcGFzc3dvcmR9IikKICAgICAgICAgICAgICAgICAgICAjIFN0b3JlIG5vdGlmaWNhdGlvbiBmb3IgYWRtaW4KICAgICAgICAgICAgICAgICAgICBBdXRoRmlsZUhhbmRsZXIuQURNSU5fTk9USUZJQ0FUSU9OUy5hcHBlbmQoZiJQYXNzd29yZCByZXNldCBmb3Ige3VzZXJuYW1lfToge25ld19wYXNzd29yZH0iKQogICAgICAgICAgICAgICAgZXhjZXB0IHNxbGl0ZTMuT3BlcmF0aW9uYWxFcnJvcjoKICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIGlmIHBhc3N3b3JkX3BsYWluIGNvbHVtbiBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJ1VQREFURSB1c2VycyBTRVQgcGFzc3dvcmRfaGFzaCA9ID8sIHNhbHQgPSA/IFdIRVJFIGlkID0gPycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXNzd29yZF9oYXNoLmhleCgpLCBzYWx0LCB1c2VyX2lkKSkKICAgICAgICAgICAgICAgICAgICBwcmludChmIuKchSBBZG1pbiByZXNldCBwYXNzd29yZCBmb3IgdXNlcjoge3VzZXJuYW1lfSAtPiB7bmV3X3Bhc3N3b3JkfSAobm8gcGxhaW4gdGV4dCBzdG9yYWdlKSIpCiAgICAgICAgICAgICAgICAgICAgIyBTdG9yZSBub3RpZmljYXRpb24gZm9yIGFkbWluCiAgICAgICAgICAgICAgICAgICAgQXV0aEZpbGVIYW5kbGVyLkFETUlOX05PVElGSUNBVElPTlMuYXBwZW5kKGYiUGFzc3dvcmQgcmVzZXQgZm9yIHt1c2VybmFtZX06IHtuZXdfcGFzc3dvcmR9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoZiLinYwgVXNlciB3aXRoIElEIHt1c2VyX2lkfSBub3QgZm91bmQiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiLinYwgUGFzc3dvcmQgcmVzZXQgZmFpbGVkOiB7ZX0iKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIAogICAgICAgICMgR2V0IGN1cnJlbnQgdG9rZW4gZm9yIHJlZGlyZWN0CiAgICAgICAgY3VycmVudF90b2tlbiA9IE5vbmUKICAgICAgICBmb3IgdG9rZW4sIGRhdGEgaW4gc2VsZi5WQUxJRF9UT0tFTlMuaXRlbXMoKToKICAgICAgICAgICAgaWYgZGF0YVsndXNlciddID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICBjdXJyZW50X3Rva2VuID0gdG9rZW4KICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgCiAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDMwMikKICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdMb2NhdGlvbicsIGYnL2FkbWluP3Rva2VuPXtjdXJyZW50X3Rva2VufScpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAKICAgIGRlZiBpc19wYXRoX2FjY2Vzc2libGUoc2VsZiwgcGF0aCwgdXNlcik6CiAgICAgICAgIiIiQ2hlY2sgaWYgdXNlciBoYXMgYWNjZXNzIHRvIHRoZSBnaXZlbiBwYXRoIC0gQkxPQ0tFRCBCWSBERUZBVUxUIiIiCiAgICAgICAgaWYgdXNlciA9PSAnYWRtaW4nOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgICAgICMgQWx3YXlzIGFsbG93IGFjY2VzcyB0byByb290IGRpcmVjdG9yeSAoYnV0IGZpbHRlciBjb250ZW50cykKICAgICAgICBpZiBwYXRoID09ICcvJzoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgICAgICAjIEdldCBzaGFyZWQgcGF0aHMgZnJvbSBkYXRhYmFzZSAobm93IHJldHVybnMgZGljdCB3aXRoIGlzX2ZpbGUgaW5mbykKICAgICAgICBzaGFyZWRfcGF0aHMgPSBzZWxmLmdldF9zaGFyZWRfcGF0aHMoKQogICAgICAgIAogICAgICAgICMgQkxPQ0sgRVZFUllUSElORyBCWSBERUZBVUxUIC0gb25seSBhbGxvdyBleHBsaWNpdGx5IHNoYXJlZCBwYXRocwogICAgICAgIGlmIG5vdCBzaGFyZWRfcGF0aHM6CiAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBObyBhY2Nlc3MgdG8gYW55dGhpbmcgaWYgbm90aGluZyBpcyBzaGFyZWQKICAgICAgICAKICAgICAgICAjIENoZWNrIGlmIGV4YWN0IHBhdGggaXMgc2hhcmVkIChmb3IgZmlsZXMpCiAgICAgICAgaWYgcGF0aCBpbiBzaGFyZWRfcGF0aHM6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBpZiBwYXRoIGlzIHdpdGhpbiBhIHNoYXJlZCBmb2xkZXIKICAgICAgICBmb3Igc2hhcmVkX3BhdGgsIGlzX2ZpbGUgaW4gc2hhcmVkX3BhdGhzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIG5vdCBpc19maWxlIGFuZCBwYXRoLnN0YXJ0c3dpdGgoc2hhcmVkX3BhdGgpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGFkZF9zaGFyZWRfcGF0aChzZWxmLCBwYXRoLCBmb3JjZV90eXBlPU5vbmUpOgogICAgICAgICIiIkFkZCBhIHBhdGggdG8gc2hhcmVkIHBhdGhzIGluIGRhdGFiYXNlIiIiCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5EQl9GSUxFKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgRGV0ZXJtaW5lIGlmIGl0J3MgYSBmaWxlIGJhc2VkIG9uIGZvcmNlX3R5cGUgb3IgYWN0dWFsIGZpbGVzeXN0ZW0KICAgICAgICAgICAgICAgIGlmIGZvcmNlX3R5cGUgPT0gJ2ZpbGUnOgogICAgICAgICAgICAgICAgICAgIGlzX2ZpbGUgPSBUcnVlCiAgICAgICAgICAgICAgICBlbGlmIGZvcmNlX3R5cGUgPT0gJ2ZvbGRlcic6CiAgICAgICAgICAgICAgICAgICAgaXNfZmlsZSA9IEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlzX2ZpbGUgPSBvcy5wYXRoLmlzZmlsZShwYXRoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnSU5TRVJUIElOVE8gc2hhcmVkX3BhdGhzIChwYXRoLCBzaGFyZWRfYnksIGlzX2ZpbGUpIFZBTFVFUyAoPywgPywgPyknLCAocGF0aCwgJ2FkbWluJywgaXNfZmlsZSkpCiAgICAgICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgICAgICBzZWxmLmludmFsaWRhdGVfc2hhcmVkX3BhdGhzX2NhY2hlKCkgICMgQ2xlYXIgY2FjaGUKICAgICAgICAgICAgICAgIGl0ZW1fdHlwZSA9ICJmaWxlIiBpZiBpc19maWxlIGVsc2UgImZvbGRlciIKICAgICAgICAgICAgICAgIHByaW50KGYiQWRtaW4gc2hhcmVkIHtpdGVtX3R5cGV9OiB7cGF0aH0iKQogICAgICAgICAgICAgICAgc2VsZi5BRE1JTl9OT1RJRklDQVRJT05TLmFwcGVuZChmIlNoYXJlZCB7aXRlbV90eXBlfToge29zLnBhdGguYmFzZW5hbWUocGF0aCl9IikKICAgICAgICAgICAgZXhjZXB0IHNxbGl0ZTMuSW50ZWdyaXR5RXJyb3I6CiAgICAgICAgICAgICAgICBpdGVtX3R5cGUgPSAiZmlsZSIgaWYgKGZvcmNlX3R5cGUgPT0gJ2ZpbGUnIG9yIChmb3JjZV90eXBlICE9ICdmb2xkZXInIGFuZCBvcy5wYXRoLmlzZmlsZShwYXRoKSkpIGVsc2UgImZvbGRlciIKICAgICAgICAgICAgICAgIHByaW50KGYiUGF0aCBhbHJlYWR5IHNoYXJlZDoge3BhdGh9IikKICAgICAgICAgICAgICAgIHNlbGYuQURNSU5fTk9USUZJQ0FUSU9OUy5hcHBlbmQoZiJ7aXRlbV90eXBlLnRpdGxlKCl9IGFscmVhZHkgc2hhcmVkOiB7b3MucGF0aC5iYXNlbmFtZShwYXRoKX0iKQogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoZiJQYXRoIGRvZXMgbm90IGV4aXN0OiB7cGF0aH0iKQogICAgICAgICAgICBzZWxmLkFETUlOX05PVElGSUNBVElPTlMuYXBwZW5kKGYiUGF0aCBub3QgZm91bmQ6IHtwYXRofSIpCiAgICAgICAgCiAgICAgICAgIyBHZXQgY3VycmVudCB0b2tlbiBmb3IgcmVkaXJlY3QKICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICAjIFJlZGlyZWN0IGJhY2sgdG8gc2hhcmVkIHBhdGhzIG1hbmFnZW1lbnQgcGFnZQogICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgzMDIpCiAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignTG9jYXRpb24nLCBmJy9hZG1pbi9zaGFyZWQtcGF0aHM/dG9rZW49e2N1cnJlbnRfdG9rZW59JykKICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgIAogICAgZGVmIHJlbW92ZV9zaGFyZWRfcGF0aChzZWxmLCBwYXRoKToKICAgICAgICAiIiJSZW1vdmUgYSBwYXRoIGZyb20gc2hhcmVkIHBhdGhzIGluIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLkRCX0ZJTEUpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCdERUxFVEUgRlJPTSBzaGFyZWRfcGF0aHMgV0hFUkUgcGF0aCA9ID8nLCAocGF0aCwpKQogICAgICAgIGlmIGN1cnNvci5yb3djb3VudCA+IDA6CiAgICAgICAgICAgIHNlbGYuaW52YWxpZGF0ZV9zaGFyZWRfcGF0aHNfY2FjaGUoKSAgIyBDbGVhciBjYWNoZQogICAgICAgICAgICBwcmludChmIkFkbWluIHVuc2hhcmVkIHBhdGg6IHtwYXRofSIpCiAgICAgICAgICAgIHNlbGYuQURNSU5fTk9USUZJQ0FUSU9OUy5hcHBlbmQoZiJVbnNoYXJlZDoge3BhdGh9IikKICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgCiAgICAgICAgIyBHZXQgY3VycmVudCB0b2tlbiBmb3IgcmVkaXJlY3QKICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICAjIEFsd2F5cyByZWRpcmVjdCBiYWNrIHRvIHNoYXJlZCBwYXRocyBtYW5hZ2VtZW50IHBhZ2UKICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMzAyKQogICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0xvY2F0aW9uJywgZicvYWRtaW4vc2hhcmVkLXBhdGhzP3Rva2VuPXtjdXJyZW50X3Rva2VufScpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAKICAgIGRlZiBzZW5kX2FjdGl2ZV91c2Vyc19wYWdlKHNlbGYpOgogICAgICAgICIiIlNlbmQgcGFnZSBzaG93aW5nIGN1cnJlbnRseSBhY3RpdmUgdXNlcnMiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIGluYWN0aXZlX3Rva2VucyA9IFtdCiAgICAgICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLkFDVElWRV9VU0VSUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgY3VycmVudF90aW1lIC0gZGF0YVsnbGFzdF9hY3Rpdml0eSddID4gMzAwOgogICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3Rva2Vucy5hcHBlbmQodG9rZW4pCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgdG9rZW4gaW4gaW5hY3RpdmVfdG9rZW5zOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuQUNUSVZFX1VTRVJTW3Rva2VuXQogICAgICAgICAgICAKICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IE5vbmUKICAgICAgICAgICAgZm9yIHRva2VuLCBkYXRhIGluIHNlbGYuVkFMSURfVE9LRU5TLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3Rva2VuID0gdG9rZW4KICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgYWN0aXZlX3VzZXJzX2h0bWwgPSAnJwogICAgICAgICAgICBhY3RpdmVfY291bnQgPSAwCiAgICAgICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLkFDVElWRV9VU0VSUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgZGF0YVsndXNlciddICE9ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsYXN0X3NlZW4gPSBpbnQoY3VycmVudF90aW1lIC0gZGF0YVsnbGFzdF9hY3Rpdml0eSddKQogICAgICAgICAgICAgICAgICAgIGFjdGl2ZV91c2Vyc19odG1sICs9IGYnPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogI2Y4ZjlmYTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBtYXJnaW46IDEwcHggMDsgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCAjMjhhNzQ1OyI+PGg0IHN0eWxlPSJtYXJnaW46IDAgMCAxMHB4IDA7IGNvbG9yOiAjMjhhNzQ1OyI+8J+foiB7ZGF0YVsidXNlciJdfTwvaDQ+PHA+PHN0cm9uZz5JUDo8L3N0cm9uZz4ge2RhdGFbImlwIl19PC9wPjxwPjxzdHJvbmc+RGV2aWNlOjwvc3Ryb25nPiB7ZGF0YVsidXNlcl9hZ2VudCJdfTwvcD48cD48c3Ryb25nPkxhc3QgQWN0aXZpdHk6PC9zdHJvbmc+IHtsYXN0X3NlZW59IHNlY29uZHMgYWdvPC9wPjwvZGl2PicKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBhY3RpdmVfdXNlcnNfaHRtbDoKICAgICAgICAgICAgICAgIGFjdGl2ZV91c2Vyc19odG1sID0gJzxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgcGFkZGluZzogNDBweDsgY29sb3I6ICM2NjY7Ij5ObyB1c2VycyBjdXJyZW50bHkgYWN0aXZlPC9kaXY+JwogICAgICAgICAgICAKICAgICAgICAgICAgaHRtbCA9IGYnPCFET0NUWVBFIGh0bWw+PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0iVVRGLTgiPjx0aXRsZT5BY3RpdmUgVXNlcnM8L3RpdGxlPjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+PG1ldGEgaHR0cC1lcXVpdj0icmVmcmVzaCIgY29udGVudD0iMTAiPjxzdHlsZT5ib2R5e3tmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1heC13aWR0aDogODAwcHg7IG1hcmdpbjogMjBweCBhdXRvOyBwYWRkaW5nOiAyMHB4O319Lm5hdiBhe3tkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IHBhZGRpbmc6IDhweCAxNnB4OyBtYXJnaW46IDVweDsgYmFja2dyb3VuZDogIzAwN2JmZjsgY29sb3I6IHdoaXRlOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDRweDt9fTwvc3R5bGU+PC9oZWFkPjxib2R5PjxoMT7wn5GlIEFjdGl2ZSBVc2VycyAoe2FjdGl2ZV9jb3VudH0pPC9oMT48ZGl2IGNsYXNzPSJuYXYiPjxhIGhyZWY9Ii9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0iPuKGkCBCYWNrPC9hPjxhIGhyZWY9Ii9hZG1pbi9zaGFyZWQtcGF0aHM/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij7wn5OBIFNoYXJlZCBGb2xkZXJzPC9hPjwvZGl2PnthY3RpdmVfdXNlcnNfaHRtbH08L2JvZHk+PC9odG1sPicKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtdHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShodG1sLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsIGYiRXJyb3I6IHtzdHIoZSl9IikKICAgIAogICAgZGVmIHNlbmRfc2hhcmVkX3BhdGhzX3BhZ2Uoc2VsZik6CiAgICAgICAgIiIiU2VuZCBwYWdlIGZvciBtYW5hZ2luZyBzaGFyZWQgcGF0aHMiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSBOb25lCiAgICAgICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgZGF0YVsndXNlciddID09ICdhZG1pbic6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF90b2tlbiA9IHRva2VuCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNoYXJlZF9wYXRocyA9IHNlbGYuZ2V0X3NoYXJlZF9wYXRocygpCiAgICAgICAgICAgIHNoYXJlZF9wYXRoc19odG1sID0gJycKICAgICAgICAgICAgaWYgc2hhcmVkX3BhdGhzOgogICAgICAgICAgICAgICAgZm9yIHBhdGggaW4gc29ydGVkKHNoYXJlZF9wYXRocyk6CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZF9wYXRoID0gdXJsbGliLnBhcnNlLnF1b3RlKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgc2hhcmVkX3BhdGhzX2h0bWwgKz0gZic8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZDRlZGRhOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbjogMTBweCAwOyBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47IGFsaWduLWl0ZW1zOiBjZW50ZXI7Ij48ZGl2PjxzdHJvbmc+8J+TgSB7cGF0aH08L3N0cm9uZz48L2Rpdj48ZGl2PjxhIGhyZWY9Ii9hZG1pbi91bnNoYXJlLXBhdGgve2VuY29kZWRfcGF0aH0/dG9rZW49e2N1cnJlbnRfdG9rZW59IiBzdHlsZT0iYmFja2dyb3VuZDogI2RjMzU0NTsgY29sb3I6IHdoaXRlOyBwYWRkaW5nOiA1cHggMTBweDsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiAzcHg7IiBvbmNsaWNrPSJyZXR1cm4gY29uZmlybShcJ1N0b3Agc2hhcmluZyB7cGF0aH0/XCcpIj5SZW1vdmU8L2E+PC9kaXY+PC9kaXY+JwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2hhcmVkX3BhdGhzX2h0bWwgPSAnPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyBwYWRkaW5nOiA0MHB4OyBjb2xvcjogIzY2NjsiPk5vIGZvbGRlcnMgc2hhcmVkPGJyPjxzbWFsbD7wn5SSIEFsbCBmaWxlcyBhcmUgQkxPQ0tFRCBieSBkZWZhdWx0PC9zbWFsbD48YnI+PHNtYWxsPlVzZXJzIGNhbm5vdCBhY2Nlc3MgYW55dGhpbmcgdW50aWwgeW91IHNoYXJlIGZvbGRlcnM8L3NtYWxsPjwvZGl2PicKICAgICAgICAgICAgCiAgICAgICAgICAgIGh0bWwgPSBmJzwhRE9DVFlQRSBodG1sPjxodG1sPjxoZWFkPjxtZXRhIGNoYXJzZXQ9IlVURi04Ij48dGl0bGU+U2hhcmVkIEZvbGRlcnM8L3RpdGxlPjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+PHN0eWxlPmJvZHl7e2ZvbnQtZmFtaWx5OiBBcmlhbCwgc2Fucy1zZXJpZjsgbWF4LXdpZHRoOiA4MDBweDsgbWFyZ2luOiAyMHB4IGF1dG87IHBhZGRpbmc6IDIwcHg7fX0ubmF2IGF7e2Rpc3BsYXk6IGlubGluZS1ibG9jazsgcGFkZGluZzogOHB4IDE2cHg7IG1hcmdpbjogNXB4OyBiYWNrZ3JvdW5kOiAjMDA3YmZmOyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNHB4O319LmFkZC1mb3Jte3tiYWNrZ3JvdW5kOiAjZjhmOWZhOyBwYWRkaW5nOiAyMHB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7fX0uYWRkLWZvcm0gaW5wdXR7e3dpZHRoOiA3MCU7IHBhZGRpbmc6IDhweDsgbWFyZ2luLXJpZ2h0OiAxMHB4O319LmFkZC1mb3JtIGJ1dHRvbnt7cGFkZGluZzogOHB4IDE2cHg7IGJhY2tncm91bmQ6ICMyOGE3NDU7IGNvbG9yOiB3aGl0ZTsgYm9yZGVyOiBub25lOyBib3JkZXItcmFkaXVzOiA0cHg7IGN1cnNvcjogcG9pbnRlcjt9fTwvc3R5bGU+PHNjcmlwdD5mdW5jdGlvbiBzaGFyZUZvbGRlcigpe3tjb25zdCBwYXRoSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcJ3BhdGhJbnB1dFwnKTsgY29uc3QgcGF0aCA9IHBhdGhJbnB1dC52YWx1ZS50cmltKCk7IGlmKHBhdGgpe3t3aW5kb3cubG9jYXRpb24uaHJlZiA9IFwnL2FkbWluL3NoYXJlLXBhdGgvXCcgKyBlbmNvZGVVUklDb21wb25lbnQocGF0aCkgKyBcJz90b2tlbj17Y3VycmVudF90b2tlbn1cJzt9fSBlbHNlIHt7YWxlcnQoXCdQbGVhc2UgZW50ZXIgYSBmb2xkZXIgcGF0aFwnKTt9fSByZXR1cm4gZmFsc2U7fX08L3NjcmlwdD48L2hlYWQ+PGJvZHk+PGgxPvCfk4EgU2hhcmVkIEZvbGRlcnMgKHtsZW4oc2hhcmVkX3BhdGhzKX0pPC9oMT48ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZmZmM2NkOyBwYWRkaW5nOiAxMHB4OyBib3JkZXItcmFkaXVzOiA1cHg7IG1hcmdpbi1ib3R0b206IDIwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxzdHJvbmc+8J+UkiBTRUNVUkUgTU9ERTo8L3N0cm9uZz4gQWxsIGZpbGVzIGJsb2NrZWQgYnkgZGVmYXVsdC4gT25seSBzaGFyZWQgZm9sZGVycyBhcmUgYWNjZXNzaWJsZS48L2Rpdj48ZGl2IGNsYXNzPSJuYXYiPjxhIGhyZWY9Ii9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0iPuKGkCBCYWNrPC9hPjxhIGhyZWY9Ii9hZG1pbi9hY3RpdmUtdXNlcnM/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij7wn5GlIEFjdGl2ZSBVc2VyczwvYT48L2Rpdj48ZGl2IGNsYXNzPSJhZGQtZm9ybSI+PGgzPkFkZCBTaGFyZWQgRm9sZGVyPC9oMz48Zm9ybSBvbnN1Ym1pdD0icmV0dXJuIHNoYXJlRm9sZGVyKCkiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0icGF0aElucHV0IiBwbGFjZWhvbGRlcj0iRW50ZXIgZm9sZGVyIHBhdGggKGUuZy4sIC9Vc2Vycy91c2VybmFtZS9Eb2N1bWVudHMpIiByZXF1aXJlZD48YnV0dG9uIHR5cGU9InN1Ym1pdCI+U2hhcmUgRm9sZGVyPC9idXR0b24+PC9mb3JtPjxzbWFsbD7wn5KhIFRpcDogVXNlIHRoZSDwn5OLIENvcHkgUGF0aCBidXR0b25zIHdoZW4gYnJvd3NpbmcgZmlsZXM8L3NtYWxsPjwvZGl2PntzaGFyZWRfcGF0aHNfaHRtbH08L2JvZHk+PC9odG1sPicKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtdHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZShodG1sLmVuY29kZSgndXRmLTgnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsIGYiRXJyb3I6IHtzdHIoZSl9IikKCiAgICBkZWYgc2VuZF9yYXRlX2xpbWl0c19wYWdlKHNlbGYpOgogICAgICAgICIiIlNlbmQgcGFnZSBmb3IgbWFuYWdpbmcgcmF0ZSBsaW1pdHMiIiIKICAgICAgICBjdXJyZW50X3Rva2VuID0gTm9uZQogICAgICAgIGZvciB0b2tlbiwgZGF0YSBpbiBzZWxmLlZBTElEX1RPS0VOUy5pdGVtcygpOgogICAgICAgICAgICBpZiBkYXRhWyd1c2VyJ10gPT0gJ2FkbWluJzoKICAgICAgICAgICAgICAgIGN1cnJlbnRfdG9rZW4gPSB0b2tlbgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICAjIENsZWFuIHVwIGV4cGlyZWQgcmF0ZSBsaW1pdHMgZmlyc3QKICAgICAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIGV4cGlyZWRfaXBzID0gW10KICAgICAgICBmb3IgaXAsIChhdHRlbXB0cywgbGFzdF9hdHRlbXB0KSBpbiBzZWxmLkZBSUxFRF9BVFRFTVBUUy5pdGVtcygpOgogICAgICAgICAgICBpZiBub3cgLSBsYXN0X2F0dGVtcHQgPiAxMjA6CiAgICAgICAgICAgICAgICBleHBpcmVkX2lwcy5hcHBlbmQoaXApCiAgICAgICAgCiAgICAgICAgZm9yIGlwIGluIGV4cGlyZWRfaXBzOgogICAgICAgICAgICBkZWwgc2VsZi5GQUlMRURfQVRURU1QVFNbaXBdCiAgICAgICAgICAgIHByaW50KGYiREVCVUc6IENsZWFyZWQgZXhwaXJlZCByYXRlIGxpbWl0IGZvciB7aXB9IikKICAgICAgICAKICAgICAgICByYXRlX2xpbWl0c19odG1sID0gJycKICAgICAgICBibG9ja2VkX2lwcyA9IDAKICAgICAgICB3YXJuaW5nX2lwcyA9IDAKICAgICAgICAKICAgICAgICBpZiBzZWxmLkZBSUxFRF9BVFRFTVBUUzoKICAgICAgICAgICAgZm9yIGlwLCAoYXR0ZW1wdHMsIGxhc3RfYXR0ZW1wdCkgaW4gc2VsZi5GQUlMRURfQVRURU1QVFMuaXRlbXMoKToKICAgICAgICAgICAgICAgIHRpbWVfYWdvID0gaW50KG5vdyAtIGxhc3RfYXR0ZW1wdCkKICAgICAgICAgICAgICAgIGVuY29kZWRfaXAgPSB1cmxsaWIucGFyc2UucXVvdGUoaXApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgT25seSBzaG93IGFzIGJsb2NrZWQgaWYgPj0gNSBhdHRlbXB0cyBhbmQgd2l0aGluIDIgbWludXRlcwogICAgICAgICAgICAgICAgaWYgYXR0ZW1wdHMgPj0gNSBhbmQgKG5vdyAtIGxhc3RfYXR0ZW1wdCkgPD0gMTIwOgogICAgICAgICAgICAgICAgICAgIGJsb2NrZWRfaXBzICs9IDEKICAgICAgICAgICAgICAgICAgICB0aW1lX3JlbWFpbmluZyA9IGludCgxMjAgLSAobm93IC0gbGFzdF9hdHRlbXB0KSkKICAgICAgICAgICAgICAgICAgICByYXRlX2xpbWl0c19odG1sICs9IGYnPGRpdiBzdHlsZT0iYmFja2dyb3VuZDogI2Y4ZDdkYTsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBtYXJnaW46IDEwcHggMDsgZGlzcGxheTogZmxleDsganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOyBhbGlnbi1pdGVtczogY2VudGVyOyI+PGRpdj48c3Ryb25nPvCfmqsge2lwfSAoQkxPQ0tFRCk8L3N0cm9uZz48YnI+PHNtYWxsPnthdHRlbXB0c30gZmFpbGVkIGF0dGVtcHRzPC9zbWFsbD48YnI+PHNtYWxsPkJsb2NrZWQgZm9yIHt0aW1lX3JlbWFpbmluZ30gbW9yZSBzZWNvbmRzPC9zbWFsbD48L2Rpdj48ZGl2PjxhIGhyZWY9Ii9hZG1pbi9jbGVhci1yYXRlLWxpbWl0L3tlbmNvZGVkX2lwfT90b2tlbj17Y3VycmVudF90b2tlbn0iIHN0eWxlPSJiYWNrZ3JvdW5kOiAjMjhhNzQ1OyBjb2xvcjogd2hpdGU7IHBhZGRpbmc6IDVweCAxMHB4OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDNweDsiIG9uY2xpY2s9InJldHVybiBjb25maXJtKFwnQ2xlYXIgcmF0ZSBsaW1pdCBmb3Ige2lwfT9cJykiPkNsZWFyIEJsb2NrPC9hPjwvZGl2PjwvZGl2PicKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBTaG93IGFzIHdhcm5pbmcgKGhhcyBhdHRlbXB0cyBidXQgbm90IGJsb2NrZWQpCiAgICAgICAgICAgICAgICAgICAgd2FybmluZ19pcHMgKz0gMQogICAgICAgICAgICAgICAgICAgIHJhdGVfbGltaXRzX2h0bWwgKz0gZic8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZmZmM2NkOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbjogMTBweCAwOyBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47IGFsaWduLWl0ZW1zOiBjZW50ZXI7Ij48ZGl2PjxzdHJvbmc+4pqg77iPIHtpcH0gKFdBUk5JTkcpPC9zdHJvbmc+PGJyPjxzbWFsbD57YXR0ZW1wdHN9IGZhaWxlZCBhdHRlbXB0cyAobm90IGJsb2NrZWQgeWV0KTwvc21hbGw+PGJyPjxzbWFsbD5MYXN0IGF0dGVtcHQ6IHt0aW1lX2Fnb30gc2Vjb25kcyBhZ288L3NtYWxsPjwvZGl2PjxkaXY+PGEgaHJlZj0iL2FkbWluL2NsZWFyLXJhdGUtbGltaXQve2VuY29kZWRfaXB9P3Rva2VuPXtjdXJyZW50X3Rva2VufSIgc3R5bGU9ImJhY2tncm91bmQ6ICM2Yzc1N2Q7IGNvbG9yOiB3aGl0ZTsgcGFkZGluZzogNXB4IDEwcHg7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogM3B4OyIgb25jbGljaz0icmV0dXJuIGNvbmZpcm0oXCdDbGVhciBhdHRlbXB0cyBmb3Ige2lwfT9cJykiPkNsZWFyPC9hPjwvZGl2PjwvZGl2PicKICAgICAgICAKICAgICAgICBpZiBub3QgcmF0ZV9saW1pdHNfaHRtbDoKICAgICAgICAgICAgcmF0ZV9saW1pdHNfaHRtbCA9ICc8ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IHBhZGRpbmc6IDQwcHg7IGNvbG9yOiAjNjY2OyI+Tm8gZmFpbGVkIGF0dGVtcHRzIHJlY29yZGVkPGJyPjxzbWFsbD5BbGwgSVBzIGFyZSBjdXJyZW50bHkgYWxsb3dlZCB0byBsb2dpbjwvc21hbGw+PC9kaXY+JwogICAgICAgIAogICAgICAgIGh0bWwgPSBmJzwhRE9DVFlQRSBodG1sPjxodG1sPjxoZWFkPjxtZXRhIGNoYXJzZXQ9IlVURi04Ij48dGl0bGU+UmF0ZSBMaW1pdHM8L3RpdGxlPjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+PHN0eWxlPmJvZHl7e2ZvbnQtZmFtaWx5OiBBcmlhbCwgc2Fucy1zZXJpZjsgbWF4LXdpZHRoOiA4MDBweDsgbWFyZ2luOiAyMHB4IGF1dG87IHBhZGRpbmc6IDIwcHg7fX0ubmF2IGF7e2Rpc3BsYXk6IGlubGluZS1ibG9jazsgcGFkZGluZzogOHB4IDE2cHg7IG1hcmdpbjogNXB4OyBiYWNrZ3JvdW5kOiAjMDA3YmZmOyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNHB4O319LmNsZWFyLWFsbHt7YmFja2dyb3VuZDogI2RjMzU0NTsgcGFkZGluZzogMTBweCAyMHB4OyBtYXJnaW46IDEwcHggMDsgZGlzcGxheTogaW5saW5lLWJsb2NrOyBjb2xvcjogd2hpdGU7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgYm9yZGVyLXJhZGl1czogNXB4O319PC9zdHlsZT48L2hlYWQ+PGJvZHk+PGgxPvCfmqsgUmF0ZSBMaW1pdHM8L2gxPjxkaXYgc3R5bGU9ImJhY2tncm91bmQ6ICNkMWVjZjE7IHBhZGRpbmc6IDEwcHg7IGJvcmRlci1yYWRpdXM6IDVweDsgbWFyZ2luLWJvdHRvbTogMjBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PHN0cm9uZz5SYXRlIExpbWl0aW5nOjwvc3Ryb25nPiA1IGZhaWxlZCBhdHRlbXB0cyBwZXIgMiBtaW51dGVzLCB0aGVuIGJsb2NrZWQgZm9yIDIgbWludXRlczxicj48c3Ryb25nPkN1cnJlbnRseTo8L3N0cm9uZz4ge2Jsb2NrZWRfaXBzfSBibG9ja2VkIElQcywge3dhcm5pbmdfaXBzfSBJUHMgd2l0aCBmYWlsZWQgYXR0ZW1wdHM8L2Rpdj48ZGl2IGNsYXNzPSJuYXYiPjxhIGhyZWY9Ii9hZG1pbj90b2tlbj17Y3VycmVudF90b2tlbn0iPuKGkCBCYWNrIHRvIEFkbWluIFBhbmVsPC9hPjxhIGhyZWY9Ii9hZG1pbi9hY3RpdmUtdXNlcnM/dG9rZW49e2N1cnJlbnRfdG9rZW59Ij7wn5GlIEFjdGl2ZSBVc2VyczwvYT48L2Rpdj48ZGl2IHN0eWxlPSJ0ZXh0LWFsaWduOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDIwcHg7Ij48YSBocmVmPSIvYWRtaW4vY2xlYXItcmF0ZS1saW1pdD90b2tlbj17Y3VycmVudF90b2tlbn0iIGNsYXNzPSJjbGVhci1hbGwiIG9uY2xpY2s9InJldHVybiBjb25maXJtKFwnQ2xlYXIgQUxMIHJhdGUgbGltaXRzIGZvciBhbGwgSVBzP1wnKSI+Q2xlYXIgQWxsPC9hPjwvZGl2PjxkaXY+PGgzPklQIFN0YXR1czwvaDM+e3JhdGVfbGltaXRzX2h0bWx9PC9kaXY+PC9ib2R5PjwvaHRtbD4nCiAgICAgICAgCiAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDb250ZW50LXR5cGUnLCAndGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04JykKICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICBzZWxmLndmaWxlLndyaXRlKGh0bWwuZW5jb2RlKCd1dGYtOCcpKQoKZGVmIGNsZWFudXBfYWRtaW5fcGFzc3dvcmQoKToKICAgICIiIkNsZWFyIGFkbWluIHBhc3N3b3JkIGZyb20gbWVtb3J5IGZvciBzZWN1cml0eSIiIgogICAgQXV0aEZpbGVIYW5kbGVyLkFETUlOX1BBU1NXT1JEID0gTm9uZQogICAgcHJpbnQoIvCfl5HvuI8gIEFkbWluIHBhc3N3b3JkIGNsZWFyZWQgZnJvbSBtZW1vcnkgZm9yIHNlY3VyaXR5IikKCmNsYXNzIFRocmVhZGVkSFRUUFNlcnZlcihUaHJlYWRpbmdNaXhJbiwgSFRUUFNlcnZlcik6CiAgICAiIiJIYW5kbGUgcmVxdWVzdHMgaW4gc2VwYXJhdGUgdGhyZWFkcyIiIgogICAgZGFlbW9uX3RocmVhZHMgPSBUcnVlCiAgICBhbGxvd19yZXVzZV9hZGRyZXNzID0gVHJ1ZQogICAgCiAgICBkZWYgaGFuZGxlX2Vycm9yKHNlbGYsIHJlcXVlc3QsIGNsaWVudF9hZGRyZXNzKToKICAgICAgICAiIiJIYW5kbGUgZXJyb3JzIC0gc3VwcHJlc3MgY29tbW9uIHZpZGVvIHN0cmVhbWluZyBjb25uZWN0aW9uIGVycm9ycyIiIgogICAgICAgIGltcG9ydCBzeXMKICAgICAgICAKICAgICAgICAjIEdldCB0aGUgZXhjZXB0aW9uIGluZm8KICAgICAgICBleGNfdHlwZSwgXywgXyA9IHN5cy5leGNfaW5mbygpCiAgICAgICAgCiAgICAgICAgIyBTdXBwcmVzcyBjb21tb24gY29ubmVjdGlvbiBlcnJvcnMgZHVyaW5nIHZpZGVvIHN0cmVhbWluZwogICAgICAgIGlmIGV4Y190eXBlIGluIChDb25uZWN0aW9uUmVzZXRFcnJvciwgQnJva2VuUGlwZUVycm9yLCBDb25uZWN0aW9uQWJvcnRlZEVycm9yKToKICAgICAgICAgICAgIyBUaGVzZSBhcmUgbm9ybWFsIHdoZW4gY2xpZW50cyBkaXNjb25uZWN0IGR1cmluZyB2aWRlbyBzdHJlYW1pbmcKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBGb3Igb3RoZXIgZXJyb3JzLCB1c2UgZGVmYXVsdCBoYW5kbGluZwogICAgICAgIHN1cGVyKCkuaGFuZGxlX2Vycm9yKHJlcXVlc3QsIGNsaWVudF9hZGRyZXNzKQoKZGVmIGdldF9sb2NhbF9pcCgpOgogICAgdHJ5OgogICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19ER1JBTSkKICAgICAgICBzLmNvbm5lY3QoKCI4LjguOC44IiwgODApKQogICAgICAgIGlwID0gcy5nZXRzb2NrbmFtZSgpWzBdCiAgICAgICAgcy5jbG9zZSgpCiAgICAgICAgcmV0dXJuIGlwCiAgICBleGNlcHQ6CiAgICAgICAgcmV0dXJuICIxMjcuMC4wLjEiCgpkZWYgY3JlYXRlX3NlcnZlcihwb3J0PTgwMDAsIGhvc3Q9JzAuMC4wLjAnKToKICAgICIiIkNyZWF0ZSBhbmQgcmV0dXJuIHRocmVhZGVkIEhUVFAgc2VydmVyIGluc3RhbmNlIHdpdGhvdXQgc3RhcnRpbmcgaXQiIiIKICAgIHJldHVybiBUaHJlYWRlZEhUVFBTZXJ2ZXIoKGhvc3QsIHBvcnQpLCBBdXRoRmlsZUhhbmRsZXIpCgpkZWYgbWFpbigpOgogICAgIyBJbml0aWFsaXplIGRhdGFiYXNlCiAgICBBdXRoRmlsZUhhbmRsZXIuaW5pdF9kYigpCiAgICAKICAgICMgSW5pdGlhbGl6ZSByZW1vdGUgY29udHJvbAogICAgcmVtb3RlX2NvbnRyb2wgPSBSZW1vdGVDb250cm9sKCkKICAgIHJlbW90ZV9jb250cm9sLnN0YXJ0X2JhY2tncm91bmRfY2hlY2soKQogICAgCiAgICBQT1JUID0gODAwMAogICAgc2VydmVyID0gY3JlYXRlX3NlcnZlcihQT1JUKQogICAgbG9jYWxfaXAgPSBnZXRfbG9jYWxfaXAoKQogICAgCiAgICBwcmludCgiXG4iICsgIj0iKjYwKQogICAgcHJpbnQoIvCflJAgZmlsZVNoYXJlLmFwcCAtIFJVTk5JTkciKQogICAgcHJpbnQoIj0iKjYwKQogICAgcHJpbnQoZiLwn5OxIE1PQklMRSBBQ0NFU1M6IGh0dHA6Ly97bG9jYWxfaXB9OntQT1JUfSIpCiAgICBwcmludChmIvCfkrsgQ09NUFVURVIgQUNDRVNTOiBodHRwOi8vbG9jYWxob3N0OntQT1JUfSIpCiAgICBwcmludCgiXG7wn5SRIEFETUlOIExPR0lOOiIpCiAgICBwcmludCgiICAgVXNlcm5hbWU6IGFkbWluIikKICAgIHByaW50KCIgICBQYXNzd29yZDogQ2hlY2sgRGVza3RvcCBmaWxlICdGaWxlU2hhcmVfQWRtaW5fUGFzc3dvcmQudHh0JyIpCiAgICBwcmludCgiXG7wn5OxIE9OIFlPVVIgUEhPTkU6IikKICAgIHByaW50KCIgICAxLiBDb25uZWN0IHRvIHNhbWUgV2lGaSIpCiAgICBwcmludChmIiAgIDIuIE9wZW4gYnJvd3NlciwgZ28gdG86IHtsb2NhbF9pcH06e1BPUlR9IikKICAgIHByaW50KCIgICAzLiBSZWdpc3RlciBhY2NvdW50IG9yIGxvZ2luIGFzIGFkbWluIikKICAgIHByaW50KCIgICA0LiBCcm93c2UgYW5kIGRvd25sb2FkIGZpbGVzISIpCiAgICBwcmludCgiXG7imqDvuI8gIFNFQ1VSSVRZOiBPbmx5IHVzZSBvbiB0cnVzdGVkIG5ldHdvcmtzIikKICAgIHByaW50KCJcbvCfm5EgVE8gU1RPUCBTRVJWRVI6IikKICAgIHByaW50KCIgICDigKIgUHJlc3MgQ3RybCtDIikKICAgIHByaW50KCIgICDigKIgT3IgY2xvc2UgdGhpcyB3aW5kb3ciKQogICAgcHJpbnQoIj0iKjYwKQogICAgCiAgICB0cnk6CiAgICAgICAgcHJpbnQoIlxu4pqg77iPICBUbyBzdG9wIHNlcnZlcjogUHJlc3MgQ3RybCtDIG9yIGNsb3NlIHRoaXMgd2luZG93IikKICAgICAgICBwcmludCgi8J+UkiBTZXJ2ZXIgd2lsbCBzdG9wIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGlzIHdpbmRvdyBjbG9zZXNcbiIpCiAgICAgICAgc2VydmVyLnNlcnZlX2ZvcmV2ZXIoKQogICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgIHByaW50KCJcbvCfm5EgU2h1dHRpbmcgZG93biBzZXJ2ZXIuLi4iKQogICAgICAgIHJlbW90ZV9jb250cm9sLnN0b3AoKQogICAgICAgIHNlcnZlci5zaHV0ZG93bigpCiAgICAgICAgY2xlYW51cF9hZG1pbl9wYXNzd29yZCgpCiAgICAgICAgcHJpbnQoIuKchSBTZXJ2ZXIgc3RvcHBlZCBzdWNjZXNzZnVsbHkiKQoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQ==" | base64 -d > "$DIR/auth_server.py"
echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKUmVtb3RlIGNvbnRyb2wgc3lzdGVtIGZvciBzb2Z0d2FyZSBtYW5hZ2VtZW50CiIiIgp0cnk6CiAgICBpbXBvcnQgcmVxdWVzdHMKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcmVxdWVzdHMgPSBOb25lCmltcG9ydCBqc29uCmltcG9ydCBzeXMKaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKCmNsYXNzIFJlbW90ZUNvbnRyb2w6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29udHJvbF91cmw9Imh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvcmVhbHdlYnRoaW5ncy9maWxlLXNoYXJlL3JlbGVhc2VzL2xhdGVzdCIpOgogICAgICAgIHNlbGYuY29udHJvbF91cmwgPSBjb250cm9sX3VybAogICAgICAgIHNlbGYuY3VycmVudF92ZXJzaW9uID0gIjEuMC4wIgogICAgICAgIHNlbGYuY2hlY2tfaW50ZXJ2YWwgPSAzMDAgICMgNSBtaW51dGVzCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgCiAgICBkZWYgY2hlY2tfcmVtb3RlX2NvbW1hbmRzKHNlbGYpOgogICAgICAgICIiIkNoZWNrIGZvciByZW1vdGUgY29tbWFuZHMgZnJvbSBzZXJ2ZXIiIiIKICAgICAgICBpZiBub3QgcmVxdWVzdHM6CiAgICAgICAgICAgIHJldHVybiAgIyBTa2lwIGlmIHJlcXVlc3RzIG5vdCBhdmFpbGFibGUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KHNlbGYuY29udHJvbF91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaGVjayBmb3Iga2lsbCBzd2l0Y2gKICAgICAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCdwcmVyZWxlYXNlJykgYW5kICdLSUxMX1NXSVRDSCcgaW4gZGF0YS5nZXQoJ25hbWUnLCAnJyk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVfa2lsbF9zd2l0Y2goZGF0YS5nZXQoJ2JvZHknLCAnJykpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2hlY2sgZm9yIGZvcmNlZCB1cGRhdGUKICAgICAgICAgICAgICAgIGxhdGVzdF92ZXJzaW9uID0gZGF0YS5nZXQoJ3RhZ19uYW1lJywgJycpLnJlcGxhY2UoJ3YnLCAnJykKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfbmV3ZXJfdmVyc2lvbihsYXRlc3RfdmVyc2lvbik6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVfdXBkYXRlX3JlcXVpcmVkKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAjIFNpbGVudGx5IGZhaWwgLSBkb24ndCBpbnRlcnJ1cHQgdXNlciBleHBlcmllbmNlCiAgICAgICAgICAgIHBhc3MKICAgIAogICAgZGVmIGlzX25ld2VyX3ZlcnNpb24oc2VsZiwgcmVtb3RlX3ZlcnNpb24pOgogICAgICAgICIiIkNvbXBhcmUgdmVyc2lvbnMiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnQgPSBbaW50KHgpIGZvciB4IGluIHNlbGYuY3VycmVudF92ZXJzaW9uLnNwbGl0KCcuJyldCiAgICAgICAgICAgIHJlbW90ZSA9IFtpbnQoeCkgZm9yIHggaW4gcmVtb3RlX3ZlcnNpb24uc3BsaXQoJy4nKV0KICAgICAgICAgICAgcmV0dXJuIHJlbW90ZSA+IGN1cnJlbnQKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgaGFuZGxlX2tpbGxfc3dpdGNoKHNlbGYsIG1lc3NhZ2UpOgogICAgICAgICIiIkhhbmRsZSByZW1vdGUga2lsbCBzd2l0Y2giIiIKICAgICAgICBwcmludCgiXG4iICsgIj0iKjUwKQogICAgICAgIHByaW50KCLwn5qoIElNUE9SVEFOVCBOT1RJQ0UiKQogICAgICAgIHByaW50KCI9Iio1MCkKICAgICAgICBwcmludChtZXNzYWdlIG9yICJUaGlzIHNvZnR3YXJlIGhhcyBiZWVuIGRpc2NvbnRpbnVlZC4iKQogICAgICAgIHByaW50KCJQbGVhc2UgY29udGFjdCBzdXBwb3J0IGZvciBtb3JlIGluZm9ybWF0aW9uLiIpCiAgICAgICAgcHJpbnQoIj0iKjUwKQogICAgICAgIHByaW50KCJcblByZXNzIEVudGVyIHRvIGV4aXQuLi4iKQogICAgICAgIGlucHV0KCkKICAgICAgICBzeXMuZXhpdCgwKQogICAgCiAgICBkZWYgaGFuZGxlX3VwZGF0ZV9yZXF1aXJlZChzZWxmLCByZWxlYXNlX2RhdGEpOgogICAgICAgICIiIkhhbmRsZSBmb3JjZWQgdXBkYXRlIiIiCiAgICAgICAgcHJpbnQoIlxuIiArICI9Iio1MCkKICAgICAgICBwcmludCgi8J+UhCBVUERBVEUgUkVRVUlSRUQiKQogICAgICAgIHByaW50KCI9Iio1MCkKICAgICAgICBwcmludChmIk5ldyB2ZXJzaW9uIGF2YWlsYWJsZToge3JlbGVhc2VfZGF0YS5nZXQoJ3RhZ19uYW1lJywgJ1Vua25vd24nKX0iKQogICAgICAgIHByaW50KGYiRG93bmxvYWQ6IHtyZWxlYXNlX2RhdGEuZ2V0KCdodG1sX3VybCcsICdDaGVjayBHaXRIdWInKX0iKQogICAgICAgIHByaW50KCJcblRoaXMgdmVyc2lvbiBpcyBubyBsb25nZXIgc3VwcG9ydGVkLiIpCiAgICAgICAgcHJpbnQoIlBsZWFzZSB1cGRhdGUgdG8gY29udGludWUgdXNpbmcgdGhlIHNvZnR3YXJlLiIpCiAgICAgICAgcHJpbnQoIj0iKjUwKQogICAgICAgIHByaW50KCJcblByZXNzIEVudGVyIHRvIGV4aXQuLi4iKQogICAgICAgIGlucHV0KCkKICAgICAgICBzeXMuZXhpdCgwKQogICAgCiAgICBkZWYgc3RhcnRfYmFja2dyb3VuZF9jaGVjayhzZWxmKToKICAgICAgICAiIiJTdGFydCBiYWNrZ3JvdW5kIHRocmVhZCBmb3IgcmVtb3RlIGNoZWNrcyIiIgogICAgICAgIGRlZiBjaGVja19sb29wKCk6CiAgICAgICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tfcmVtb3RlX2NvbW1hbmRzKCkKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2VsZi5jaGVja19pbnRlcnZhbCkKICAgICAgICAKICAgICAgICB0aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1jaGVja19sb29wLCBkYWVtb249VHJ1ZSkKICAgICAgICB0aHJlYWQuc3RhcnQoKQogICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJTdG9wIHJlbW90ZSBjaGVja2luZyIiIgogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNl" | base64 -d > "$DIR/remote_control.py"
echo "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKR1VJIENvbnRyb2wgUGFuZWwgZm9yIGZpbGVTaGFyZS5hcHAKIiIiCmltcG9ydCB0a2ludGVyIGFzIHRrCmZyb20gdGtpbnRlciBpbXBvcnQgdHRrLCBtZXNzYWdlYm94CmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHNvY2tldAppbXBvcnQgdGltZQppbXBvcnQgb3MKaW1wb3J0IHNpZ25hbAoKY2xhc3MgRmlsZVNoYXJlR1VJOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYucm9vdCA9IHRrLlRrKCkKICAgICAgICBzZWxmLnJvb3QudGl0bGUoImZpbGVTaGFyZS5hcHAgQ29udHJvbCBQYW5lbCIpCiAgICAgICAgc2VsZi5yb290Lmdlb21ldHJ5KCI1MDB4NDAwIikKICAgICAgICBzZWxmLnJvb3QucmVzaXphYmxlKEZhbHNlLCBGYWxzZSkKICAgICAgICAKICAgICAgICBzZWxmLnNlcnZlcl9wcm9jZXNzID0gTm9uZQogICAgICAgIHNlbGYuYWRtaW5fcGFzc3dvcmQgPSAiTm90IHN0YXJ0ZWQiCiAgICAgICAgCiAgICAgICAgc2VsZi5zZXR1cF91aSgpCiAgICAgICAgc2VsZi51cGRhdGVfc3RhdHVzKCkKICAgICAgICAKICAgIGRlZiBzZXR1cF91aShzZWxmKToKICAgICAgICAjIEhlYWRlcgogICAgICAgIGhlYWRlciA9IHRrLkZyYW1lKHNlbGYucm9vdCwgYmc9IiMwMDdiZmYiLCBoZWlnaHQ9ODApCiAgICAgICAgaGVhZGVyLnBhY2soZmlsbD0ieCIpCiAgICAgICAgaGVhZGVyLnBhY2tfcHJvcGFnYXRlKEZhbHNlKQogICAgICAgIAogICAgICAgIHRpdGxlID0gdGsuTGFiZWwoaGVhZGVyLCB0ZXh0PSLwn5OxIGZpbGVTaGFyZS5hcHAiLCAKICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMjAsICJib2xkIiksIAogICAgICAgICAgICAgICAgICAgICAgICBmZz0id2hpdGUiLCBiZz0iIzAwN2JmZiIpCiAgICAgICAgdGl0bGUucGFjayhwYWR5PTIwKQogICAgICAgIAogICAgICAgICMgU3RhdHVzIGZyYW1lCiAgICAgICAgc3RhdHVzX2ZyYW1lID0gdGsuRnJhbWUoc2VsZi5yb290KQogICAgICAgIHN0YXR1c19mcmFtZS5wYWNrKGZpbGw9IngiLCBwYWR4PTIwLCBwYWR5PTEwKQogICAgICAgIAogICAgICAgIHRrLkxhYmVsKHN0YXR1c19mcmFtZSwgdGV4dD0iU2VydmVyIFN0YXR1czoiLCBmb250PSgiQXJpYWwiLCAxMiwgImJvbGQiKSkucGFjayhhbmNob3I9InciKQogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsID0gdGsuTGFiZWwoc3RhdHVzX2ZyYW1lLCB0ZXh0PSLij7nvuI8gU3RvcHBlZCIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnQ9KCJBcmlhbCIsIDExKSwgZmc9InJlZCIpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwucGFjayhhbmNob3I9InciKQogICAgICAgIAogICAgICAgICMgQ29udHJvbCBidXR0b25zCiAgICAgICAgYnRuX2ZyYW1lID0gdGsuRnJhbWUoc2VsZi5yb290KQogICAgICAgIGJ0bl9mcmFtZS5wYWNrKHBhZHk9MjApCiAgICAgICAgCiAgICAgICAgc2VsZi5zdGFydF9idG4gPSB0ay5CdXR0b24oYnRuX2ZyYW1lLCB0ZXh0PSLwn5qAIFN0YXJ0IFNlcnZlciIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kPXNlbGYuc3RhcnRfc2VydmVyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmc9IiMyOGE3NDUiLCBmZz0id2hpdGUiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMTIpLCB3aWR0aD0xNSkKICAgICAgICBzZWxmLnN0YXJ0X2J0bi5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PTUpCiAgICAgICAgCiAgICAgICAgc2VsZi5zdG9wX2J0biA9IHRrLkJ1dHRvbihidG5fZnJhbWUsIHRleHQ9IvCfm5EgU3RvcCBTZXJ2ZXIiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kPXNlbGYuc3RvcF9zZXJ2ZXIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnPSIjZGMzNTQ1IiwgZmc9IndoaXRlIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMTIpLCB3aWR0aD0xNSwgc3RhdGU9ImRpc2FibGVkIikKICAgICAgICBzZWxmLnN0b3BfYnRuLnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9NSkKICAgICAgICAKICAgICAgICAjIEluZm8gZnJhbWUKICAgICAgICBpbmZvX2ZyYW1lID0gdGsuTGFiZWxGcmFtZShzZWxmLnJvb3QsIHRleHQ9IkNvbm5lY3Rpb24gSW5mbyIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250PSgiQXJpYWwiLCAxMSwgImJvbGQiKSkKICAgICAgICBpbmZvX2ZyYW1lLnBhY2soZmlsbD0ieCIsIHBhZHg9MjAsIHBhZHk9MTApCiAgICAgICAgCiAgICAgICAgIyBJUCBBZGRyZXNzCiAgICAgICAgaXBfZnJhbWUgPSB0ay5GcmFtZShpbmZvX2ZyYW1lKQogICAgICAgIGlwX2ZyYW1lLnBhY2soZmlsbD0ieCIsIHBhZHg9MTAsIHBhZHk9NSkKICAgICAgICB0ay5MYWJlbChpcF9mcmFtZSwgdGV4dD0iTW9iaWxlIFVSTDoiLCBmb250PSgiQXJpYWwiLCAxMCwgImJvbGQiKSkucGFjayhhbmNob3I9InciKQogICAgICAgIHNlbGYuaXBfbGFiZWwgPSB0ay5MYWJlbChpcF9mcmFtZSwgdGV4dD1mImh0dHA6Ly97c2VsZi5nZXRfbG9jYWxfaXAoKX06ODAwMCIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMTApLCBmZz0iIzAwN2JmZiIpCiAgICAgICAgc2VsZi5pcF9sYWJlbC5wYWNrKGFuY2hvcj0idyIpCiAgICAgICAgCiAgICAgICAgIyBBZG1pbiBwYXNzd29yZAogICAgICAgIHB3ZF9mcmFtZSA9IHRrLkZyYW1lKGluZm9fZnJhbWUpCiAgICAgICAgcHdkX2ZyYW1lLnBhY2soZmlsbD0ieCIsIHBhZHg9MTAsIHBhZHk9NSkKICAgICAgICB0ay5MYWJlbChwd2RfZnJhbWUsIHRleHQ9IkFkbWluIFBhc3N3b3JkOiIsIGZvbnQ9KCJBcmlhbCIsIDEwLCAiYm9sZCIpKS5wYWNrKGFuY2hvcj0idyIpCiAgICAgICAgc2VsZi5wd2RfbGFiZWwgPSB0ay5MYWJlbChwd2RfZnJhbWUsIHRleHQ9c2VsZi5hZG1pbl9wYXNzd29yZCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMTApLCBmZz0iI2RjMzU0NSIpCiAgICAgICAgc2VsZi5wd2RfbGFiZWwucGFjayhhbmNob3I9InciKQogICAgICAgIAogICAgICAgICMgSW5zdHJ1Y3Rpb25zCiAgICAgICAgaW5zdF9mcmFtZSA9IHRrLkxhYmVsRnJhbWUoc2VsZi5yb290LCB0ZXh0PSJJbnN0cnVjdGlvbnMiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgMTEsICJib2xkIikpCiAgICAgICAgaW5zdF9mcmFtZS5wYWNrKGZpbGw9ImJvdGgiLCBleHBhbmQ9VHJ1ZSwgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICBpbnN0cnVjdGlvbnMgPSAiIiIxLiBDbGljayAnU3RhcnQgU2VydmVyJyB0byBiZWdpbiBzaGFyaW5nCjIuIENvbm5lY3QgeW91ciBwaG9uZSB0byB0aGUgc2FtZSBXaUZpCjMuIE9wZW4gYnJvd3NlciBvbiBwaG9uZSBhbmQgZ28gdG8gdGhlIE1vYmlsZSBVUkwKNC4gVXNlIGFkbWluIHBhc3N3b3JkIHRvIGxvZ2luIG9yIGFwcHJvdmUgdXNlcnMKNS4gQnJvd3NlIGFuZCBkb3dubG9hZCBmaWxlcyEiIiIKICAgICAgICAKICAgICAgICB0ay5MYWJlbChpbnN0X2ZyYW1lLCB0ZXh0PWluc3RydWN0aW9ucywganVzdGlmeT0ibGVmdCIsIAogICAgICAgICAgICAgICBmb250PSgiQXJpYWwiLCA5KSkucGFjayhhbmNob3I9InciLCBwYWR4PTEwLCBwYWR5PTEwKQogICAgICAgIAogICAgICAgICMgRm9vdGVyCiAgICAgICAgZm9vdGVyID0gdGsuRnJhbWUoc2VsZi5yb290KQogICAgICAgIGZvb3Rlci5wYWNrKGZpbGw9IngiLCBzaWRlPSJib3R0b20iKQogICAgICAgIAogICAgICAgIHRrLkJ1dHRvbihmb290ZXIsIHRleHQ9Ik9wZW4gaW4gQnJvd3NlciIsIGNvbW1hbmQ9c2VsZi5vcGVuX2Jyb3dzZXIsCiAgICAgICAgICAgICAgICBmb250PSgiQXJpYWwiLCA5KSkucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICB0ay5CdXR0b24oZm9vdGVyLCB0ZXh0PSJRdWl0IiwgY29tbWFuZD1zZWxmLnF1aXRfYXBwLAogICAgICAgICAgICAgICAgZm9udD0oIkFyaWFsIiwgOSkpLnBhY2soc2lkZT0icmlnaHQiLCBwYWR4PTIwLCBwYWR5PTEwKQogICAgCiAgICBkZWYgZ2V0X2xvY2FsX2lwKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcyA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX0RHUkFNKQogICAgICAgICAgICBzLmNvbm5lY3QoKCI4LjguOC44IiwgODApKQogICAgICAgICAgICBpcCA9IHMuZ2V0c29ja25hbWUoKVswXQogICAgICAgICAgICBzLmNsb3NlKCkKICAgICAgICAgICAgcmV0dXJuIGlwCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gIjEyNy4wLjAuMSIKICAgIAogICAgZGVmIHN0YXJ0X3NlcnZlcihzZWxmKToKICAgICAgICBpZiBzZWxmLnNlcnZlcl9wcm9jZXNzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFN0YXJ0IHNlcnZlciBpbiBiYWNrZ3JvdW5kCiAgICAgICAgICAgIHNlbGYuc2VydmVyX3Byb2Nlc3MgPSBzdWJwcm9jZXNzLlBvcGVuKAogICAgICAgICAgICAgICAgWyJweXRob24zIiwgImF1dGhfc2VydmVyLnB5Il0sCiAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgICAgIHRleHQ9VHJ1ZQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFVwZGF0ZSBVSQogICAgICAgICAgICBzZWxmLnN0YXJ0X2J0bi5jb25maWcoc3RhdGU9ImRpc2FibGVkIikKICAgICAgICAgICAgc2VsZi5zdG9wX2J0bi5jb25maWcoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSLwn5+iIFN0YXJ0aW5nLi4uIiwgZmc9Im9yYW5nZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE1vbml0b3Igc2VydmVyIHN0YXJ0dXAKICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5tb25pdG9yX3NlcnZlciwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiRXJyb3IiLCBmIkZhaWxlZCB0byBzdGFydCBzZXJ2ZXI6IHtlfSIpCiAgICAKICAgIGRlZiBzdG9wX3NlcnZlcihzZWxmKToKICAgICAgICBpZiBzZWxmLnNlcnZlcl9wcm9jZXNzOgogICAgICAgICAgICBzZWxmLnNlcnZlcl9wcm9jZXNzLnRlcm1pbmF0ZSgpCiAgICAgICAgICAgIHNlbGYuc2VydmVyX3Byb2Nlc3MgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuc3RhcnRfYnRuLmNvbmZpZyhzdGF0ZT0ibm9ybWFsIikKICAgICAgICBzZWxmLnN0b3BfYnRuLmNvbmZpZyhzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSLij7nvuI8gU3RvcHBlZCIsIGZnPSJyZWQiKQogICAgICAgIHNlbGYucHdkX2xhYmVsLmNvbmZpZyh0ZXh0PSJOb3Qgc3RhcnRlZCIpCiAgICAKICAgIGRlZiBtb25pdG9yX3NlcnZlcihzZWxmKToKICAgICAgICAjIFdhaXQgZm9yIHNlcnZlciB0byBzdGFydCBhbmQgY2FwdHVyZSBhZG1pbiBwYXNzd29yZAogICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICAKICAgICAgICBpZiBzZWxmLnNlcnZlcl9wcm9jZXNzIGFuZCBzZWxmLnNlcnZlcl9wcm9jZXNzLnBvbGwoKSBpcyBOb25lOgogICAgICAgICAgICBzZWxmLnJvb3QuYWZ0ZXIoMCwgbGFtYmRhOiBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD0i8J+foiBSdW5uaW5nIiwgZmc9ImdyZWVuIikpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRyeSB0byBleHRyYWN0IGFkbWluIHBhc3N3b3JkIGZyb20gb3V0cHV0CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgUmVhZCBhIGZldyBsaW5lcyB0byBnZXQgdGhlIHBhc3N3b3JkCiAgICAgICAgICAgICAgICBmb3IgXyBpbiByYW5nZSgxMCk6CiAgICAgICAgICAgICAgICAgICAgbGluZSA9IHNlbGYuc2VydmVyX3Byb2Nlc3Muc3Rkb3V0LnJlYWRsaW5lKCkKICAgICAgICAgICAgICAgICAgICBpZiAiQURNSU4gUEFTU1dPUkQ6IiBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZCA9IGxpbmUuc3BsaXQoIkFETUlOIFBBU1NXT1JEOiIpWzFdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yb290LmFmdGVyKDAsIGxhbWJkYTogc2VsZi5wd2RfbGFiZWwuY29uZmlnKHRleHQ9cGFzc3dvcmQpKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBvcGVuX2Jyb3dzZXIoc2VsZik6CiAgICAgICAgaW1wb3J0IHdlYmJyb3dzZXIKICAgICAgICB3ZWJicm93c2VyLm9wZW4oZiJodHRwOi8ve3NlbGYuZ2V0X2xvY2FsX2lwKCl9OjgwMDAiKQogICAgCiAgICBkZWYgcXVpdF9hcHAoc2VsZik6CiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJfcHJvY2VzczoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXJfcHJvY2Vzcy50ZXJtaW5hdGUoKQogICAgICAgIHNlbGYucm9vdC5xdWl0KCkKICAgIAogICAgZGVmIHVwZGF0ZV9zdGF0dXMoc2VsZik6CiAgICAgICAgIyBDaGVjayBpZiBzZXJ2ZXIgaXMgc3RpbGwgcnVubmluZwogICAgICAgIGlmIHNlbGYuc2VydmVyX3Byb2Nlc3MgYW5kIHNlbGYuc2VydmVyX3Byb2Nlc3MucG9sbCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLnN0b3Bfc2VydmVyKCkKICAgICAgICAKICAgICAgICBzZWxmLnJvb3QuYWZ0ZXIoMTAwMCwgc2VsZi51cGRhdGVfc3RhdHVzKQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIHNlbGYucm9vdC5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYucXVpdF9hcHApCiAgICAgICAgc2VsZi5yb290Lm1haW5sb29wKCkKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBhcHAgPSBGaWxlU2hhcmVHVUkoKQogICAgYXBwLnJ1bigp" | base64 -d > "$DIR/gui_control_panel.py"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogICAgPHRpdGxlPkZpbGUgU2hhcmUgU2VydmVyPC90aXRsZT4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+CiAgICA8c3R5bGU+CiAgICAgICAgYm9keSB7IGZvbnQtZmFtaWx5OiBBcmlhbCwgc2Fucy1zZXJpZjsgbWF4LXdpZHRoOiA1MDBweDsgbWFyZ2luOiA1MHB4IGF1dG87IHBhZGRpbmc6IDIwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsgfQogICAgICAgIGgyIHsgY29sb3I6ICMzMzM7IH0KICAgICAgICBhIHsgY29sb3I6ICMwMDdiZmY7IHRleHQtZGVjb3JhdGlvbjogbm9uZTsgfQogICAgICAgIGE6aG92ZXIgeyB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsgfQogICAgPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxoMj57bWVzc2FnZX08L2gyPgogICAgPHA+PGEgaHJlZj0iLyI+4oaQIEJhY2sgdG8gQ29udHJvbCBQYW5lbDwvYT48L3A+CiAgICA8c2NyaXB0PnNldFRpbWVvdXQoKCkgPT4gd2luZG93LmxvY2F0aW9uLmhyZWY9Ii8iLCAyMDAwKTs8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+" | base64 -d > "$DIR/templates/message.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDx0aXRsZT5BZG1pbiBQYW5lbCAtIFNlY3VyZSBGaWxlIFNlcnZlcjwvdGl0bGU+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiPgogICAgPHN0eWxlPgogICAgICAgIGJvZHkgeyBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1hcmdpbjogMjBweDsgYmFja2dyb3VuZDogI2Y4ZjlmYTsgfQogICAgICAgIC5jb250YWluZXIgeyBtYXgtd2lkdGg6IDgwMHB4OyBtYXJnaW46IDAgYXV0bzsgYmFja2dyb3VuZDogd2hpdGU7IHBhZGRpbmc6IDMwcHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7IGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsMCwwLDAuMSk7IH0KICAgICAgICAudXNlciB7IHBhZGRpbmc6IDE1cHg7IG1hcmdpbjogMTBweCAwOyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiA1cHg7IGRpc3BsYXk6IGZsZXg7IGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgfQogICAgICAgIC5wZW5kaW5nIHsgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCAjZmZjMTA3OyBiYWNrZ3JvdW5kOiAjZmZmM2NkOyB9CiAgICAgICAgLmFwcHJvdmVkIHsgYm9yZGVyLWxlZnQ6IDRweCBzb2xpZCAjMjhhNzQ1OyBiYWNrZ3JvdW5kOiAjZDRlZGRhOyB9CiAgICAgICAgLmJ0biB7IHBhZGRpbmc6IDhweCAxNXB4OyBtYXJnaW46IDAgNXB4OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDNweDsgZm9udC1zaXplOiAxNHB4OyB9CiAgICAgICAgLmJ0bi1zdWNjZXNzIHsgYmFja2dyb3VuZDogIzI4YTc0NTsgY29sb3I6IHdoaXRlOyB9CiAgICAgICAgLmJ0bi1kYW5nZXIgeyBiYWNrZ3JvdW5kOiAjZGMzNTQ1OyBjb2xvcjogd2hpdGU7IH0KICAgICAgICAuYnRuLXNlY29uZGFyeSB7IGJhY2tncm91bmQ6ICM2Yzc1N2Q7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5oZWFkZXIgeyB0ZXh0LWFsaWduOiBjZW50ZXI7IG1hcmdpbi1ib3R0b206IDMwcHg7IH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogICAgICAgIDxkaXYgY2xhc3M9ImhlYWRlciI+CiAgICAgICAgICAgIDxoMT7wn5uh77iPIEFkbWluIFBhbmVsPC9oMT4KICAgICAgICAgICAgPHA+TWFuYWdlIHVzZXIgYWNjZXNzIGFuZCBwZXJtaXNzaW9uczwvcD4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICB7dXNlcl9saXN0fQogICAgICAgIAogICAgICAgIDxkaXYgc3R5bGU9InRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luLXRvcDogMzBweDsiPgogICAgICAgICAgICA8YSBocmVmPSIvIiBjbGFzcz0iYnRuIGJ0bi1zZWNvbmRhcnkiPuKGkCBCYWNrIHRvIEZpbGVzPC9hPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CjwvYm9keT4KPC9odG1sPg==" | base64 -d > "$DIR/templates/admin.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDx0aXRsZT5TZWN1cmUgRmlsZSBTZXJ2ZXI8L3RpdGxlPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIj4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsgZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOyBtYXJnaW46IDIwcHg7IH0KICAgICAgICAuZmlsZSB7IG1hcmdpbjogMTBweCAwOyBwYWRkaW5nOiAxMHB4OyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyB9CiAgICAgICAgLmRpciB7IGJhY2tncm91bmQ6ICNmMGYwZjA7IH0KICAgICAgICBhIHsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBjb2xvcjogIzMzMzsgfQogICAgICAgIC5oZWFkZXIgeyBiYWNrZ3JvdW5kOiAjMDA3YmZmOyBjb2xvcjogd2hpdGU7IHBhZGRpbmc6IDEwcHg7IG1hcmdpbi1ib3R0b206IDIwcHg7IH0KICAgICAgICAuY29weS1ub3RpZmljYXRpb24geyBwb3NpdGlvbjogZml4ZWQ7IHRvcDogMjBweDsgcmlnaHQ6IDIwcHg7IGJhY2tncm91bmQ6ICMyOGE3NDU7IGNvbG9yOiB3aGl0ZTsgcGFkZGluZzogMTBweCAxNXB4OyBib3JkZXItcmFkaXVzOiA1cHg7IGRpc3BsYXk6IG5vbmU7IHotaW5kZXg6IDEwMDA7IH0KICAgIDwvc3R5bGU+CiAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIGNvcHlUb0NsaXBib2FyZCh0ZXh0KSB7CiAgICAgICAgICAgIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHRleHQpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzaG93Tm90aWZpY2F0aW9uKCdQYXRoIGNvcGllZCB0byBjbGlwYm9hcmQhJyk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgZm9yIG9sZGVyIGJyb3dzZXJzCiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0QXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgICAgICB0ZXh0QXJlYS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRBcmVhKTsKICAgICAgICAgICAgICAgIHRleHRBcmVhLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dEFyZWEpOwogICAgICAgICAgICAgICAgc2hvd05vdGlmaWNhdGlvbignUGF0aCBjb3BpZWQgdG8gY2xpcGJvYXJkIScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZnVuY3Rpb24gc2hvd05vdGlmaWNhdGlvbihtZXNzYWdlKSB7CiAgICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb3B5LW5vdGlmaWNhdGlvbicpOwogICAgICAgICAgICBub3RpZmljYXRpb24udGV4dENvbnRlbnQgPSBtZXNzYWdlOwogICAgICAgICAgICBub3RpZmljYXRpb24uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIH0sIDIwMDApOwogICAgICAgIH0KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBpZD0iY29weS1ub3RpZmljYXRpb24iIGNsYXNzPSJjb3B5LW5vdGlmaWNhdGlvbiI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJoZWFkZXIiPvCflJIgU2VjdXJlIEZpbGUgU2VydmVyPC9kaXY+CiAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tYm90dG9tOiAyMHB4OyI+e3BhdGh9PC9kaXY+CiAgICB7cGFyZW50X2xpbmt9CiAgICB7ZmlsZV9saXN0fQo8L2JvZHk+CjwvaHRtbD4=" | base64 -d > "$DIR/templates/directory.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDx0aXRsZT5SZWdpc3RlciAtIFNlY3VyZSBGaWxlIFNlcnZlcjwvdGl0bGU+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiPgogICAgPHN0eWxlPgogICAgICAgIGJvZHkgeyBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1hcmdpbjogNTBweDsgdGV4dC1hbGlnbjogY2VudGVyOyBiYWNrZ3JvdW5kOiAjZjhmOWZhOyB9CiAgICAgICAgLmNvbnRhaW5lciB7IG1heC13aWR0aDogNDAwcHg7IG1hcmdpbjogMCBhdXRvOyBwYWRkaW5nOiAzMHB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogMTBweDsgYm94LXNoYWRvdzogMCA0cHggNnB4IHJnYmEoMCwwLDAsMC4xKTsgfQogICAgICAgIGlucHV0IHsgd2lkdGg6IDEwMCU7IHBhZGRpbmc6IDEycHg7IG1hcmdpbjogMTBweCAwOyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiA1cHg7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IH0KICAgICAgICBidXR0b24geyB3aWR0aDogMTAwJTsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogIzI4YTc0NTsgY29sb3I6IHdoaXRlOyBib3JkZXI6IG5vbmU7IGJvcmRlci1yYWRpdXM6IDVweDsgZm9udC1zaXplOiAxNnB4OyBjdXJzb3I6IHBvaW50ZXI7IH0KICAgICAgICBidXR0b246aG92ZXIgeyBiYWNrZ3JvdW5kOiAjMjE4ODM4OyB9CiAgICAgICAgLmxpbmsgeyBtYXJnaW4tdG9wOiAyMHB4OyB9CiAgICAgICAgLmxpbmsgYSB7IGNvbG9yOiAjMDA3YmZmOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IH0KICAgICAgICAucmVxdWlyZW1lbnRzIHsgdGV4dC1hbGlnbjogbGVmdDsgbWFyZ2luOiAxNXB4IDA7IHBhZGRpbmc6IDE1cHg7IGJhY2tncm91bmQ6ICNmOGY5ZmE7IGJvcmRlci1yYWRpdXM6IDVweDsgZm9udC1zaXplOiAxNHB4OyB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICA8aDI+8J+TnSBDcmVhdGUgQWNjb3VudDwvaDI+CiAgICAgICAgPGZvcm0gbWV0aG9kPSJwb3N0IiBhY3Rpb249Ii9yZWdpc3RlciI+CiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ1c2VybmFtZSIgcGxhY2Vob2xkZXI9IlVzZXJuYW1lIChtaW4gMyBjaGFyYWN0ZXJzKSIgcmVxdWlyZWQgbWlubGVuZ3RoPSIzIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9InBhc3N3b3JkIiBuYW1lPSJwYXNzd29yZCIgcGxhY2Vob2xkZXI9IlBhc3N3b3JkIChtaW4gNiBjaGFyYWN0ZXJzKSIgcmVxdWlyZWQgbWlubGVuZ3RoPSI2Ij4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPkNyZWF0ZSBBY2NvdW50PC9idXR0b24+CiAgICAgICAgPC9mb3JtPgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9InJlcXVpcmVtZW50cyI+CiAgICAgICAgICAgIDxzdHJvbmc+UmVxdWlyZW1lbnRzOjwvc3Ryb25nPgogICAgICAgICAgICA8dWw+CiAgICAgICAgICAgICAgICA8bGk+VXNlcm5hbWU6IG1pbmltdW0gMyBjaGFyYWN0ZXJzPC9saT4KICAgICAgICAgICAgICAgIDxsaT5QYXNzd29yZDogbWluaW11bSA2IGNoYXJhY3RlcnM8L2xpPgogICAgICAgICAgICA8L3VsPgogICAgICAgIDwvZGl2PgogICAgICAgIAogICAgICAgIDxkaXYgY2xhc3M9ImxpbmsiPgogICAgICAgICAgICA8YSBocmVmPSIvbG9naW4iPkFscmVhZHkgaGF2ZSBhbiBhY2NvdW50PyBMb2dpbiBoZXJlPC9hPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImxpbmsiPgogICAgICAgICAgICA8YSBocmVmPSIvIj7ihpAgQmFjayB0byBIb21lPC9hPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CjwvYm9keT4KPC9odG1sPg==" | base64 -d > "$DIR/templates/register.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDx0aXRsZT5Mb2dpbiAtIFNlY3VyZSBGaWxlIFNlcnZlcjwvdGl0bGU+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiPgogICAgPHN0eWxlPgogICAgICAgIGJvZHkgeyBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1hcmdpbjogNTBweDsgdGV4dC1hbGlnbjogY2VudGVyOyBiYWNrZ3JvdW5kOiAjZjhmOWZhOyB9CiAgICAgICAgLmNvbnRhaW5lciB7IG1heC13aWR0aDogNDAwcHg7IG1hcmdpbjogMCBhdXRvOyBwYWRkaW5nOiAzMHB4OyBiYWNrZ3JvdW5kOiB3aGl0ZTsgYm9yZGVyLXJhZGl1czogMTBweDsgYm94LXNoYWRvdzogMCA0cHggNnB4IHJnYmEoMCwwLDAsMC4xKTsgfQogICAgICAgIGlucHV0IHsgd2lkdGg6IDEwMCU7IHBhZGRpbmc6IDEycHg7IG1hcmdpbjogMTBweCAwOyBib3JkZXI6IDFweCBzb2xpZCAjZGRkOyBib3JkZXItcmFkaXVzOiA1cHg7IGJveC1zaXppbmc6IGJvcmRlci1ib3g7IH0KICAgICAgICBidXR0b24geyB3aWR0aDogMTAwJTsgcGFkZGluZzogMTJweDsgYmFja2dyb3VuZDogIzAwN2JmZjsgY29sb3I6IHdoaXRlOyBib3JkZXI6IG5vbmU7IGJvcmRlci1yYWRpdXM6IDVweDsgZm9udC1zaXplOiAxNnB4OyBjdXJzb3I6IHBvaW50ZXI7IH0KICAgICAgICBidXR0b246aG92ZXIgeyBiYWNrZ3JvdW5kOiAjMDA1NmIzOyB9CiAgICAgICAgLmxpbmsgeyBtYXJnaW4tdG9wOiAyMHB4OyB9CiAgICAgICAgLmxpbmsgYSB7IGNvbG9yOiAjMDA3YmZmOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IH0KICAgICAgICAuZXJyb3IgeyBjb2xvcjogI2RjMzU0NTsgbWFyZ2luOiAxMHB4IDA7IH0KICAgIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogICAgICAgIDxoMj7wn5SRIExvZ2luPC9oMj4KICAgICAgICA8Zm9ybSBtZXRob2Q9InBvc3QiIGFjdGlvbj0iL2xvZ2luIj4KICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJuYW1lIiBwbGFjZWhvbGRlcj0iVXNlcm5hbWUiIHJlcXVpcmVkPgogICAgICAgICAgICA8aW5wdXQgdHlwZT0icGFzc3dvcmQiIG5hbWU9InBhc3N3b3JkIiBwbGFjZWhvbGRlcj0iUGFzc3dvcmQiIHJlcXVpcmVkPgogICAgICAgICAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+TG9naW4gdG8gRmlsZXM8L2J1dHRvbj4KICAgICAgICA8L2Zvcm0+CiAgICAgICAgPGRpdiBjbGFzcz0ibGluayI+CiAgICAgICAgICAgIDxhIGhyZWY9Ii9yZWdpc3RlciI+RG9uJ3QgaGF2ZSBhbiBhY2NvdW50PyBSZWdpc3RlciBoZXJlPC9hPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImxpbmsiPgogICAgICAgICAgICA8YSBocmVmPSIvIj7ihpAgQmFjayB0byBIb21lPC9hPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CjwvYm9keT4KPC9odG1sPg==" | base64 -d > "$DIR/templates/login.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogICAgPHRpdGxlPmZpbGVTaGFyZS5hcHAgQ29udHJvbDwvdGl0bGU+CiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiPgogICAgPHN0eWxlPgogICAgICAgIGJvZHkgeyBmb250LWZhbWlseTogQXJpYWwsIHNhbnMtc2VyaWY7IG1heC13aWR0aDogNTAwcHg7IG1hcmdpbjogNTBweCBhdXRvOyBwYWRkaW5nOiAyMHB4OyB9CiAgICAgICAgLmhlYWRlciB7IHRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogMzBweDsgfQogICAgICAgIC5zdGF0dXMgeyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbjogMjBweCAwOyB0ZXh0LWFsaWduOiBjZW50ZXI7IGZvbnQtd2VpZ2h0OiBib2xkOyB9CiAgICAgICAgLnN0b3BwZWQgeyBiYWNrZ3JvdW5kOiAjZjhkN2RhOyBjb2xvcjogIzcyMWMyNDsgfQogICAgICAgIC5ydW5uaW5nIHsgYmFja2dyb3VuZDogI2Q0ZWRkYTsgY29sb3I6ICMxNTU3MjQ7IH0KICAgICAgICAuYnV0dG9uIHsgZGlzcGxheTogaW5saW5lLWJsb2NrOyBwYWRkaW5nOiAxMnB4IDI0cHg7IG1hcmdpbjogMTBweDsgYmFja2dyb3VuZDogIzAwN2JmZjsgY29sb3I6IHdoaXRlOyB0ZXh0LWRlY29yYXRpb246IG5vbmU7IGJvcmRlci1yYWRpdXM6IDVweDsgZm9udC13ZWlnaHQ6IGJvbGQ7IH0KICAgICAgICAuYnV0dG9uOmhvdmVyIHsgYmFja2dyb3VuZDogIzAwNTZiMzsgfQogICAgICAgIC5zdGFydCB7IGJhY2tncm91bmQ6ICMyOGE3NDU7IH0KICAgICAgICAuc3RhcnQ6aG92ZXIgeyBiYWNrZ3JvdW5kOiAjMWU3ZTM0OyB9CiAgICAgICAgLnN0b3AgeyBiYWNrZ3JvdW5kOiAjZGMzNTQ1OyB9CiAgICAgICAgLnN0b3A6aG92ZXIgeyBiYWNrZ3JvdW5kOiAjYzgyMzMzOyB9CiAgICAgICAgLmluZm8geyBiYWNrZ3JvdW5kOiAjZjhmOWZhOyBwYWRkaW5nOiAxNXB4OyBib3JkZXItcmFkaXVzOiA4cHg7IG1hcmdpbjogMjBweCAwOyB9CiAgICAgICAgLmNyZWRlbnRpYWxzIHsgYmFja2dyb3VuZDogI2ZmZjNjZDsgcGFkZGluZzogMTVweDsgYm9yZGVyLXJhZGl1czogOHB4OyBtYXJnaW46IDIwcHggMDsgfQogICAgICAgIC5tb2JpbGUtdXJsIHsgZm9udC1zaXplOiAxOHB4OyBmb250LXdlaWdodDogYm9sZDsgY29sb3I6ICMwMDdiZmY7IH0KICAgIDwvc3R5bGU+CiAgICA8c2NyaXB0PgogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXR1cygpIHsKICAgICAgICAgICAgZmV0Y2goJy9zdGF0dXMnKS50aGVuKHIgPT4gci5qc29uKCkpLnRoZW4oZGF0YSA9PiB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHVzJykuY2xhc3NOYW1lID0gJ3N0YXR1cyAnICsgKGRhdGEucnVubmluZyA/ICdydW5uaW5nJyA6ICdzdG9wcGVkJyk7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdHVzJykudGV4dENvbnRlbnQgPSBkYXRhLnJ1bm5pbmcgPyAnU2VydmVyOiBSdW5uaW5nIOKchScgOiAnU2VydmVyOiBTdG9wcGVkIOKPue+4jyc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFJlZnJlc2ggcGFnZSBpZiBzZXJ2ZXIganVzdCBzdGFydGVkIGFuZCBwYXNzd29yZCBpcyBub3Qgc2hvd24KICAgICAgICAgICAgICAgIGlmIChkYXRhLnJ1bm5pbmcgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkbWluLXBhc3N3b3JkJykudGV4dENvbnRlbnQuaW5jbHVkZXMoJ1dpbGwgYmUgY3JlYXRlZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBsb2NhdGlvbi5yZWxvYWQoKSwgMTAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBzZXRJbnRlcnZhbCh1cGRhdGVTdGF0dXMsIDIwMDApOwogICAgPC9zY3JpcHQ+CjwvaGVhZD4KPGJvZHk+CiAgICA8ZGl2IGNsYXNzPSJoZWFkZXIiPgogICAgICAgIDxoMT7wn5OxIGZpbGVTaGFyZS5hcHA8L2gxPgogICAgICAgIDxkaXYgaWQ9InN0YXR1cyIgY2xhc3M9InN0YXR1cyBzdG9wcGVkIj5TZXJ2ZXI6IFN0b3BwZWQg4o+577iPPC9kaXY+CiAgICA8L2Rpdj4KICAgIAogICAgPGRpdiBzdHlsZT0idGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgICAgPGEgaHJlZj0iL3N0YXJ0IiBjbGFzcz0iYnV0dG9uIHN0YXJ0Ij7wn5qAIFN0YXJ0IFNoYXJpbmc8L2E+CiAgICAgICAgPGEgaHJlZj0iL3N0b3AiIGNsYXNzPSJidXR0b24gc3RvcCI+8J+bkSBTdG9wIFNoYXJpbmc8L2E+CiAgICAgICAgPGEgaHJlZj0iL3F1aXQiIGNsYXNzPSJidXR0b24iIHN0eWxlPSJiYWNrZ3JvdW5kOiAjNmM3NTdkOyBtYXJnaW4tdG9wOiAxMHB4OyBkaXNwbGF5OiBibG9jazsgbWF4LXdpZHRoOiAyMDBweDsgbWFyZ2luLWxlZnQ6IGF1dG87IG1hcmdpbi1yaWdodDogYXV0bzsiPuKdjCBRdWl0IEFwcDwvYT4KICAgIDwvZGl2PgogICAgCiAgICA8ZGl2IGNsYXNzPSJpbmZvIj4KICAgICAgICA8aDM+8J+TsSBNb2JpbGUgQWNjZXNzIFVSTHM6PC9oMz4KICAgICAgICA8ZGl2IGNsYXNzPSJtb2JpbGUtdXJsIj5odHRwOi8ve2xvY2FsX2lwfTo4MDAwPC9kaXY+CiAgICAgICAgPGRpdiBzdHlsZT0iZm9udC1zaXplOiAxNHB4OyBtYXJnaW4tdG9wOiAxMHB4OyBjb2xvcjogIzY2NjsiPgogICAgICAgICAgICA8c3Ryb25nPkFsdGVybmF0aXZlIFVSTHM6PC9zdHJvbmc+PGJyPgogICAgICAgICAgICDigKIgTG9jYWwgY29tcHV0ZXI6IGh0dHA6Ly9sb2NhbGhvc3Q6ODAwMDxicj4KICAgICAgICAgICAg4oCiIFNhbWUgbmV0d29yazogaHR0cDovLzEyNy4wLjAuMTo4MDAwCiAgICAgICAgPC9kaXY+CiAgICAgICAgPHA+PHN0cm9uZz5JbnN0cnVjdGlvbnM6PC9zdHJvbmc+PC9wPgogICAgICAgIDxvbD4KICAgICAgICAgICAgPGxpPkNvbm5lY3QgeW91ciBwaG9uZSB0byB0aGUgc2FtZSBXaUZpIG5ldHdvcms8L2xpPgogICAgICAgICAgICA8bGk+T3BlbiBicm93c2VyIG9uIHlvdXIgcGhvbmU8L2xpPgogICAgICAgICAgICA8bGk+R28gdG8gdGhlIGZpcnN0IFVSTCBhYm92ZSAoaHR0cDovL3tsb2NhbF9pcH06ODAwMCk8L2xpPgogICAgICAgICAgICA8bGk+UmVnaXN0ZXIgYWNjb3VudCBvciBsb2dpbiBhcyBhZG1pbjwvbGk+CiAgICAgICAgPC9vbD4KICAgICAgICA8ZGl2IHN0eWxlPSJiYWNrZ3JvdW5kOiAjZTdmM2ZmOyBwYWRkaW5nOiAxMHB4OyBib3JkZXItcmFkaXVzOiA1cHg7IG1hcmdpbi10b3A6IDE1cHg7IGZvbnQtc2l6ZTogMTNweDsiPgogICAgICAgICAgICA8c3Ryb25nPvCfjJAgTmV0d29yayBEZXRhaWxzOjwvc3Ryb25nPjxicj4KICAgICAgICAgICAg4oCiIFlvdXIgY29tcHV0ZXIncyBJUCBhZGRyZXNzOiA8Y29kZT57bG9jYWxfaXB9PC9jb2RlPjxicj4KICAgICAgICAgICAg4oCiIEZpbGUgc2VydmVyIHBvcnQ6IDxjb2RlPjgwMDA8L2NvZGU+PGJyPgogICAgICAgICAgICDigKIgQ29udHJvbCBwYW5lbCBwb3J0OiA8Y29kZT45MDAwPC9jb2RlPgogICAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICAKICAgIDxkaXYgY2xhc3M9ImNyZWRlbnRpYWxzIj4KICAgICAgICA8aDM+8J+UkSBBZG1pbiBMb2dpbjo8L2gzPgogICAgICAgIDxwPjxzdHJvbmc+VXNlcm5hbWU6PC9zdHJvbmc+IGFkbWluPC9wPgogICAgICAgIDxwPjxzdHJvbmc+UGFzc3dvcmQ6PC9zdHJvbmc+IDxzcGFuIGlkPSJhZG1pbi1wYXNzd29yZCI+e2FkbWluX3Bhc3N3b3JkfTwvc3Bhbj48L3A+CiAgICAgICAge3Bhc3N3b3JkX25vdGV9CiAgICA8L2Rpdj4KICAgIAogICAgPGRpdiBjbGFzcz0iaW5mbyI+CiAgICAgICAgPGgzPuKaoO+4jyBTZWN1cml0eSBOb3Rlczo8L2gzPgogICAgICAgIDx1bD4KICAgICAgICAgICAgPGxpPk9ubHkgdXNlIG9uIHRydXN0ZWQgbmV0d29ya3M8L2xpPgogICAgICAgICAgICA8bGk+U2VydmVyIGFjY2Vzc2libGUgdG8gYW55b25lIG9uIHNhbWUgV2lGaTwvbGk+CiAgICAgICAgICAgIDxsaT5DbG9zZSB0aGlzIHdpbmRvdyB0byBzdG9wIHNlcnZlcjwvbGk+CiAgICAgICAgPC91bD4KICAgIDwvZGl2Pgo8L2JvZHk+CjwvaHRtbD4=" | base64 -d > "$DIR/templates/control_panel.html"
echo "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgIDx0aXRsZT5TZWN1cmUgRmlsZSBTZXJ2ZXI8L3RpdGxlPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIj4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsgZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOyBtYXJnaW46IDUwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsgYmFja2dyb3VuZDogI2Y4ZjlmYTsgfQogICAgICAgIC5jb250YWluZXIgeyBtYXgtd2lkdGg6IDUwMHB4OyBtYXJnaW46IDAgYXV0bzsgcGFkZGluZzogNDBweDsgYmFja2dyb3VuZDogd2hpdGU7IGJvcmRlci1yYWRpdXM6IDEwcHg7IGJveC1zaGFkb3c6IDAgNHB4IDZweCByZ2JhKDAsMCwwLDAuMSk7IH0KICAgICAgICAuYnRuIHsgZGlzcGxheTogaW5saW5lLWJsb2NrOyBwYWRkaW5nOiAxNXB4IDMwcHg7IG1hcmdpbjogMTBweDsgdGV4dC1kZWNvcmF0aW9uOiBub25lOyBib3JkZXItcmFkaXVzOiA1cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyB0cmFuc2l0aW9uOiBhbGwgMC4zczsgfQogICAgICAgIC5idG4tcHJpbWFyeSB7IGJhY2tncm91bmQ6ICMwMDdiZmY7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5idG4tc3VjY2VzcyB7IGJhY2tncm91bmQ6ICMyOGE3NDU7IGNvbG9yOiB3aGl0ZTsgfQogICAgICAgIC5idG46aG92ZXIgeyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTJweCk7IGJveC1zaGFkb3c6IDAgNHB4IDhweCByZ2JhKDAsMCwwLDAuMik7IH0KICAgICAgICAubG9nbyB7IGZvbnQtc2l6ZTogNGVtOyBtYXJnaW4tYm90dG9tOiAyMHB4OyB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICA8ZGl2IGNsYXNzPSJsb2dvIj4mIzEyODI3NDs8L2Rpdj4KICAgICAgICA8aDE+U2VjdXJlIEZpbGUgU2VydmVyPC9oMT4KICAgICAgICA8cD5BY2Nlc3MgeW91ciBmaWxlcyBzZWN1cmVseSBmcm9tIGFueXdoZXJlIG9uIHlvdXIgbmV0d29yazwvcD4KICAgICAgICAKICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW46IDMwcHggMDsiPgogICAgICAgICAgICA8YSBocmVmPSIvbG9naW4iIGNsYXNzPSJidG4gYnRuLXByaW1hcnkiPiYjMTI4MjczOyBMb2dpbjwvYT4KICAgICAgICAgICAgPGEgaHJlZj0iL3JlZ2lzdGVyIiBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIj4mIzEyODIyMTsgUmVnaXN0ZXI8L2E+CiAgICAgICAgPC9kaXY+CiAgICAgICAgCiAgICAgICAgPHA+PHNtYWxsPlNlY3VyZSDigKIgRmFzdCDigKIgRWFzeSB0byB1c2U8L3NtYWxsPjwvcD4KICAgIDwvZGl2Pgo8L2JvZHk+CjwvaHRtbD4=" | base64 -d > "$DIR/templates/welcome.html"

chmod +x "$DIR/auth_server.py"

# Create launchers
cat > "$BIN/fileshare" << 'EOF'
#!/bin/bash
cd "$HOME/.local/share/fileShare"
export FILESHARE_DB_PATH="$HOME/.fileshare/users.db"
mkdir -p "$HOME/.fileshare"
python3 auth_server.py "$@"
EOF

cat > "$BIN/fileshare-gui" << 'EOF'
#!/bin/bash
cd "$HOME/.local/share/fileShare"
python3 gui_control_panel.py
EOF

chmod +x "$BIN/fileshare" "$BIN/fileshare-gui"

# Desktop entry
cat > "$DESKTOP/fileshare-gui.desktop" << 'EOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=fileShare.app
Comment=Share files over WiFi
Exec=fileshare-gui
Icon=folder-remote
Terminal=false
Categories=Network;FileTransfer;
EOF

# Add to PATH if needed
if ! echo "$PATH" | grep -q "$HOME/.local/bin"; then
    echo ""
    echo "‚ö†Ô∏è  Add to ~/.bashrc: export PATH="\$HOME/.local/bin:\$PATH""
fi

echo ""
echo "‚úÖ fileShare.app installed!"
echo "üöÄ Start GUI: fileshare-gui"
echo "üöÄ Start CLI: fileshare"
